# 權限系統架構說明

## 系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        權限系統架構                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐
│    User     │ 用戶
│  (使用者)   │
└──────┬──────┘
       │
       │ 多對多關係
       │
       ├─────────────────────────────────┐
       │                                 │
       ▼                                 ▼
┌─────────────┐                  ┌─────────────┐
│    Role     │                  │ Permission  │
│   (角色)    │                  │   (權限)    │
└──────┬──────┘                  └─────────────┘
       │                                 ▲
       │ 多對多關係                       │
       │                                 │
       └─────────────────────────────────┘
              (Role 包含多個 Permission)

┌──────────────────────────────────────────────────────────────┐
│                    UrlPermission (URL 權限)                    │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ • url_pattern: "/api/users/**"                        │  │
│  │ • http_method: "GET"                                  │  │
│  │ • is_public: false                                    │  │
│  │ • required_role: "ROLE_ADMIN" (可選)                  │  │
│  │ • required_permission: "PERM_ADMIN_ACCESS" (可選)      │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

## 資料庫關聯關係

```
users (用戶表)
├── user_roles (用戶-角色關聯表)
│   └── roles (角色表)
│       └── role_permissions (角色-權限關聯表)
│           └── permissions (權限表)
│
└── user_permissions (用戶-權限關聯表)
    └── permissions (權限表)

url_permissions (URL 權限表)
├── required_role (可選，對應 roles.role_name)
└── required_permission (可選，對應 permissions.permission_code)
```

## 權限檢查流程

```
┌─────────────────────────────────────────────────────────────┐
│               API 請求權限檢查流程                            │
└─────────────────────────────────────────────────────────────┘

用戶發起 API 請求
       │
       ▼
┌──────────────────┐
│ JWT 認證         │ 檢查 Token 是否有效
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ UrlPermission    │ 查詢 url_permissions 表
│ Filter           │ 找到匹配的 URL 規則
└────────┬─────────┘
         │
         ├─→ 是公開的 (is_public = true)?
         │   └─→ ✅ 允許訪問
         │
         ├─→ 需要認證?
         │   ├─→ 用戶未登入?
         │   │   └─→ ❌ 返回 401 Unauthorized
         │   │
         │   └─→ 用戶已登入
         │       │
         │       ├─→ 需要角色 (required_role)?
         │       │   ├─→ 檢查用戶的角色
         │       │   │   └─→ 用戶直接擁有的角色 (User.roles)
         │       │   │
         │       │   └─→ 沒有該角色?
         │       │       └─→ ❌ 返回 403 Forbidden
         │       │
         │       └─→ 需要權限 (required_permission)?
         │           ├─→ 檢查用戶的權限
         │           │   ├─→ 直接分配的權限 (User.permissions)
         │           │   └─→ 通過角色獲得的權限 (User.roles → Role.permissions)
         │           │
         │           └─→ 沒有該權限?
         │               └─→ ❌ 返回 403 Forbidden
         │
         └─→ ✅ 通過所有檢查，允許訪問
```

## 權限收集流程

```
┌─────────────────────────────────────────────────────────────┐
│              用戶登入時權限收集流程                           │
└─────────────────────────────────────────────────────────────┘

用戶登入成功
       │
       ▼
┌──────────────────┐
│ 載入用戶資料      │ UserDetailsService.loadUserByUsername()
└────────┬─────────┘
         │
         ├─→ 載入用戶直接擁有的角色 (User.roles)
         │   └─→ 載入每個角色的權限 (Role.permissions)
         │
         ├─→ 載入用戶直接分配的權限 (User.permissions)
         │
         └─→ 合併所有權限
             │
             ├─→ 直接權限: User.permissions
             ├─→ 角色權限: User.roles[].permissions
             └─→ 角色名稱: User.roles[].roleName
             │
             ▼
┌──────────────────┐
│ 生成 Authorities │
│ (Spring Security)│
└──────────────────┘
         │
         ├─→ ROLE_ADMIN (來自 Role.roleName)
         ├─→ ROLE_USER (來自 Role.roleName)
         ├─→ PERM_ADMIN_ACCESS (來自 Permission.permissionCode)
         └─→ PERM_USER_READ (來自 Permission.permissionCode)
```

## 各層級的用途說明

### 1. User (用戶)
- **用途**: 系統的使用者
- **特點**: 可以有多個角色，也可以直接分配權限

### 2. Role (角色)
- **用途**: 將一組權限打包成一個角色，方便管理
- **優點**: 
  - 不需要為每個用戶單獨分配權限
  - 可以批量管理（例如：所有「管理員」都有相同的權限）
- **範例**: 
  - `ROLE_ADMIN` 角色包含 `PERM_USER_MANAGE`, `PERM_ROLE_MANAGE` 等權限
  - 將 `ROLE_ADMIN` 分配給用戶，用戶就自動獲得這些權限

### 3. Permission (權限)
- **用途**: 功能性的權限標識，不直接對應 API
- **特點**: 
  - 是一個抽象的權限代碼（如 `PERM_ADMIN_ACCESS`）
  - 可以通過角色間接獲得，也可以直接分配給用戶
- **範例**: 
  - `PERM_USER_MANAGE`: 管理用戶的權限
  - `PERM_EXPENSE_READ`: 查看支出的權限

### 4. UrlPermission (URL 權限)
- **用途**: 控制哪些 API 端點可以訪問，以及訪問條件
- **特點**: 
  - 直接對應 API 路徑（如 `/api/users/**`）
  - 可以設定為公開（無需登入）
  - 可以要求特定角色或權限
- **範例**: 
  - `/api/users/**` 需要 `ROLE_ADMIN` 角色
  - `/api/expenses/**` 需要 `PERM_EXPENSE_READ` 權限
  - `/api/public/**` 設定為公開（`is_public = true`）

## 為什麼需要 Permission 這一層？

### 設計理念：**分離關注點**

1. **Permission (權限)**: 代表「能做什麼」
   - 例如：`PERM_USER_MANAGE` = "可以管理用戶"
   - 這是**功能性的**，不綁定具體的 API

2. **UrlPermission (URL 權限)**: 代表「哪些 API 需要什麼條件」
   - 例如：`/api/users/**` 需要 `PERM_USER_MANAGE` 權限
   - 這是**技術性的**，綁定具體的 API 路徑

### 優點：

1. **靈活性**: 
   - 同一個權限可以對應多個 API
   - 例如：`PERM_USER_MANAGE` 可以同時保護 `/api/users/**` 和 `/api/admin/users/**`

2. **可維護性**: 
   - 如果 API 路徑改變，只需要修改 `UrlPermission`，不需要修改 `Permission`
   - 如果功能權限改變，只需要修改 `Permission` 和 `Role` 的關係

3. **可擴展性**: 
   - 未來可以添加其他類型的權限檢查（如：資源級別權限、資料級別權限）
   - 這些都可以使用相同的 `Permission` 概念

## 實際使用範例

### 場景 1: 管理員訪問用戶管理 API

```
用戶: admin
角色: ROLE_ADMIN
  └─→ 權限: PERM_USER_MANAGE, PERM_ROLE_MANAGE

API 請求: GET /api/users
UrlPermission 配置:
  - url_pattern: "/api/users/**"
  - required_permission: "PERM_USER_MANAGE"

檢查流程:
  1. ✅ 用戶已登入
  2. ✅ 用戶有 PERM_USER_MANAGE 權限（通過 ROLE_ADMIN 角色獲得）
  3. ✅ 允許訪問
```

### 場景 2: 普通用戶訪問公開 API

```
用戶: user1
角色: ROLE_USER
  └─→ 權限: PERM_EXPENSE_READ

API 請求: GET /api/public/news
UrlPermission 配置:
  - url_pattern: "/api/public/**"
  - is_public: true

檢查流程:
  1. ✅ 是公開的，無需登入
  2. ✅ 允許訪問
```

### 場景 3: 用戶直接分配權限（不通過角色）

```
用戶: special_user
角色: 無
直接權限: PERM_ADMIN_ACCESS

API 請求: GET /api/admin/config
UrlPermission 配置:
  - url_pattern: "/api/admin/**"
  - required_permission: "PERM_ADMIN_ACCESS"

檢查流程:
  1. ✅ 用戶已登入
  2. ✅ 用戶有 PERM_ADMIN_ACCESS 權限（直接分配）
  3. ✅ 允許訪問
```

## 總結

- **User**: 系統使用者
- **Role**: 權限的打包容器，方便批量管理
- **Permission**: 功能性的權限標識（「能做什麼」）
- **UrlPermission**: 技術性的 API 訪問控制（「哪些 API 需要什麼條件」）

這樣的設計讓系統既有靈活性（可以直接分配權限），又有便利性（可以通過角色批量管理），同時保持了清晰的職責分離。

