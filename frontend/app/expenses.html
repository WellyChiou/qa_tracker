<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è¨˜å¸³ç³»çµ± (MySQL ç‰ˆæœ¬)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- API Service -->
    <script src="api.js" onerror="console.error('âŒ api.js è¼‰å…¥å¤±æ•—ï¼'); alert('api.js æ–‡ä»¶è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨');"></script>
    <script>
        // æª¢æŸ¥ api.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥
        // æª¢æŸ¥èªè­‰ç‹€æ…‹ï¼Œå¦‚æœæœªç™»å…¥å‰‡é‡å®šå‘åˆ°ç™»å…¥é 
        async function checkAuthAndRedirect() {
            const backendUrl = window.location.protocol + '//' + window.location.hostname + ':8080';
            try {
                const response = await fetch(`${backendUrl}/api/auth/current-user`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.authenticated) {
                        console.log('âœ… ç”¨æˆ¶å·²èªè­‰:', user.username || user.email);
                        return true;
                    }
                }
            } catch (error) {
                console.error('æª¢æŸ¥èªè­‰ç‹€æ…‹å¤±æ•—:', error);
            }
            
            // æœªç™»å…¥ï¼Œé‡å®šå‘åˆ°ç™»å…¥é 
            console.log('âŒ ç”¨æˆ¶æœªèªè­‰ï¼Œé‡å®šå‘åˆ°ç™»å…¥é ');
            window.location.href = '/login.html';
            return false;
        }
        
        window.addEventListener('load', async function() {
            // å…ˆæª¢æŸ¥èªè­‰ç‹€æ…‹
            const isAuthenticated = await checkAuthAndRedirect();
            if (!isAuthenticated) {
                return; // å·²é‡å®šå‘ï¼Œåœæ­¢åŸ·è¡Œ
            }
            
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œæª¢æŸ¥ apiService...');
            console.log('window.apiService:', window.apiService);
            if (window.apiService) {
                console.log('âœ… apiService å·²è¼‰å…¥');
                console.log('apiService é¡å‹:', window.apiService.constructor.name);
                console.log('apiService æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.apiService)));
            } else {
                console.error('âŒ apiService æœªè¼‰å…¥ï¼');
            }
        });
    </script>
</head>
<body>
    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">è¼‰å…¥ä¸­</div>
            <div class="loading-subtext" id="loadingSubtext">è«‹ç¨å€™<span class="loading-dots"></span></div>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer" style="position: fixed; bottom: 20px; left: 20px; z-index: 10000; max-width: 300px;"></div>

    <div class="container">
        <header>
            <div class="header-top">
            <h1>å®¶åº­è¨˜å¸³ç³»çµ±</h1>
                <div id="userInfo" class="user-info" style="display: none; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px); padding: 10px 18px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                    <div class="user-details">
                        <svg class="user-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                        <span id="userEmail" class="user-email"></span>
                    </div>
                    <button onclick="window.location.href='index.html';" class="logout-btn" style="background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);">è¿”å›å„€è¡¨æ¿</button>
                </div>
            </div>
            <div class="summary">
                <div class="summary-item">
                    <span class="label">æœ¬æœˆæ”¶å…¥</span>
                    <span class="amount income" id="monthlyIncome">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">æœ¬æœˆæ”¯å‡º</span>
                    <span class="amount expense" id="monthlyExpense">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">æœ¬æœˆæ·¨æ”¶å…¥</span>
                    <span class="amount net-income" id="monthlyNetIncome">$0</span>
                </div>
                </div>
            
            <!-- åŠŸèƒ½æŒ‰éˆ•å€åŸŸ -->
            <div class="function-buttons-section">
                <button class="btn btn-chart" onclick="expenseTracker.showChartsModal()">
                    ğŸ“Š åœ–è¡¨åˆ†æ
                </button>
                <button class="btn btn-primary" onclick="expenseTracker.showAssetPortfolio()">
                    ğŸ“Š è³‡ç”¢çµ„åˆç®¡ç†
                </button>
                <button class="btn btn-secondary" onclick="expenseTracker.showExchangeRates()">
                    ğŸ’± åŒ¯ç‡ç®¡ç†
                </button>
                <button class="btn btn-info" onclick="expenseTracker.showTradingFeesConfig()">
                    ğŸ’° äº¤æ˜“è²»ç”¨é…ç½®
                </button>
            </div>
        </header>

        <main>
            <!-- æ–°å¢è¨˜éŒ„å€åŸŸ -->
            <section class="add-record">
                <h2>æ–°å¢è¨˜å¸³è¨˜éŒ„</h2>
                <form id="recordForm">
                    <div class="form-grid">
                    <div class="form-group">
                        <label for="member">å®¶åº­æˆå“¡</label>
                        <select id="member" required>
                            <option value="">è«‹é¸æ“‡æˆå“¡</option>
                            <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
                            <option value="åª½åª½">åª½åª½</option>
                            <option value="å­©å­">å­©å­</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="type">é¡å‹</label>
                        <select id="type" required>
                            <option value="">è«‹é¸æ“‡é¡å‹</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mainCategory">é¡åˆ¥</label>
                        <select id="mainCategory" required>
                            <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                            <!-- æ”¯å‡ºå¤§é …ç›® -->
                            <option value="é£Ÿ" data-type="æ”¯å‡º">é£Ÿ</option>
                            <option value="è¡£" data-type="æ”¯å‡º">è¡£</option>
                            <option value="ä½" data-type="æ”¯å‡º">ä½</option>
                            <option value="è¡Œ" data-type="æ”¯å‡º">è¡Œ</option>
                            <option value="è‚²" data-type="æ”¯å‡º">è‚²</option>
                            <option value="æ¨‚" data-type="æ”¯å‡º">æ¨‚</option>
                            <option value="é†«ç™‚" data-type="æ”¯å‡º">é†«ç™‚</option>
                            <option value="å…¶ä»–æ”¯å‡º" data-type="æ”¯å‡º">å…¶ä»–æ”¯å‡º</option>
                            <!-- æ”¶å…¥å¤§é …ç›® -->
                            <option value="è–ªè³‡" data-type="æ”¶å…¥">è–ªè³‡</option>
                            <option value="æŠ•è³‡" data-type="æ”¶å…¥">æŠ•è³‡</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="subCategory">ç´°é …</label>
                        <select id="subCategory" required>
                            <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">é‡‘é¡</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="currency">å¹£åˆ¥</label>
                        <select id="currency" required>
                            <option value="TWD">å°å¹£ (TWD)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                            <option value="JPY">æ—¥åœ“ (JPY)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="exchangeRateGroup" style="display: none;">
                        <label for="exchangeRate">åŒ¯ç‡ (å°å°å¹£)</label>
                        <div class="exchange-rate-display">
                            <input type="number" id="exchangeRate" step="0.0001" readonly placeholder="æ­£åœ¨å–å¾—åŒ¯ç‡...">
                            <button type="button" id="refreshRateBtn" onclick="expenseTracker.fetchCurrentExchangeRate()" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸ”„ æ›´æ–°åŒ¯ç‡
                            </button>
                        </div>
                        <small class="exchange-rate-info" style="color: #666; font-size: 12px;">
                            åŒ¯ç‡å°‡è‡ªå‹•å¾ç¶²è·¯å–å¾—æœ€æ–°æ•¸æ“š
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <input type="text" id="description" placeholder="è¼¸å…¥æè¿°...">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit">æ–°å¢è¨˜éŒ„</button>
                        <button type="button" onclick="expenseTracker.resetForm()" class="reset-btn">æ¸…ç©ºè¡¨å–®</button>
                    </div>
                </form>
            </section>


            <!-- è¨˜éŒ„åˆ—è¡¨å€åŸŸ -->
            <section class="records">
                <h2>è¨˜å¸³è¨˜éŒ„</h2>
                <div class="records-list" id="recordsList">
                    <!-- è¨˜éŒ„å°‡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <!-- åˆ†é æ§ä»¶ -->
                <div class="pagination" id="pagination">
                    <div class="page-size-selector">
                        <label for="pageSize">æ¯é é¡¯ç¤ºï¼š</label>
                        <select id="pageSize">
                            <option value="5">5 ç­†</option>
                            <option value="10">10 ç­†</option>
                            <option value="20" selected>20 ç­†</option>
                            <option value="50">50 ç­†</option>
                        </select>
                    </div>
                    
                    <div class="page-controls">
                        <button id="prevPage" class="page-btn" disabled>ä¸Šä¸€é </button>
                        <div class="page-info">
                            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
                        </div>
                        <button id="nextPage" class="page-btn" disabled>ä¸‹ä¸€é </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- åœ–è¡¨å½ˆçª— -->
    <div id="chartsModal" class="modal">
        <div class="modal-content charts-modal">
            <div class="modal-header">
                <h2>ğŸ“Š åœ–è¡¨åˆ†æ</h2>
                <span class="close" onclick="expenseTracker.hideChartsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- åœ–è¡¨ç¯©é¸å™¨ -->
                <div class="chart-filters">
                    <h3>åœ–è¡¨ç¯©é¸</h3>
                    <div class="filter-group">
                        <label for="chartFilterType">é¡å‹ï¼š</label>
                        <select id="chartFilterType">
                            <option value="">æ‰€æœ‰é¡å‹</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                        </select>
                        
                        <label for="chartFilterYear">å¹´ä»½ï¼š</label>
                        <select id="chartFilterYear" required>
                        </select>
                        
                        <label for="chartFilterMonth">æœˆä»½ï¼š</label>
                        <select id="chartFilterMonth">
                            <option value="">æ•´å¹´</option>
                            <option value="01">1æœˆ</option>
                            <option value="02">2æœˆ</option>
                            <option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option>
                            <option value="05">5æœˆ</option>
                            <option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option>
                            <option value="08">8æœˆ</option>
                            <option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>

                        <label for="chartFilterMember">å®¶åº­æˆå“¡ï¼š</label>
                        <select id="chartFilterMember">
                            <option value="">å…¨éƒ¨æˆå“¡</option>
                            <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
                            <option value="åª½åª½">åª½åª½</option>
                            <option value="å­©å­">å­©å­</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="expense-section-title">æ”¯å‡ºçµ±è¨ˆ</h2>
                <div class="chart-row expense-section">
                    <div class="chart-container">
                        <h3>æ”¯å‡ºé¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="expenseCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡æ”¯å‡ºåˆ†å¸ƒ</h3>
                        <canvas id="expenseMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="income-section-title">æ”¶å…¥çµ±è¨ˆ</h2>
                <div class="chart-row income-section">
                    <div class="chart-container">
                        <h3>æ”¶å…¥é¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="incomeCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡æ”¶å…¥åˆ†å¸ƒ</h3>
                        <canvas id="incomeMemberChart"></canvas>
                    </div>
                </div>
                
                <h2 class="asset-section-title" style="display: none;">è³‡ç”¢çµ±è¨ˆ</h2>
                <div class="chart-row asset-section" style="display: none;">
                    <div class="chart-container">
                        <h3>è³‡ç”¢é¡åˆ¥åˆ†å¸ƒ</h3>
                        <canvas id="assetCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>å®¶åº­æˆå“¡è³‡ç”¢åˆ†å¸ƒ</h3>
                        <canvas id="assetMemberChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="expenseTracker.hideChartsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯ç‡ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="exchangeRateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’± åŒ¯ç‡ç®¡ç†</h2>
                <span class="close" onclick="expenseTracker.hideExchangeRates()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="exchange-rate-section">
                    <h3>åŒ¯ç‡ç®¡ç† (å°å°å¹£)</h3>
                    <div class="rate-date-controls">
                        <div class="form-group">
                            <label for="rateDate">åŒ¯ç‡æ—¥æœŸ</label>
                            <input type="date" id="rateDate">
                        </div>
                        <button class="btn btn-outline" onclick="expenseTracker.loadRatesForDate()">
                            ğŸ“… è¼‰å…¥è©²æ—¥æœŸåŒ¯ç‡
                        </button>
                    </div>
                    <div class="exchange-rates-cards">
                        <div class="exchange-rate-card">
                            <div class="currency-header">
                                <span class="currency-name">ç¾å…ƒ</span>
                                <span class="currency-code">(USD)</span>
                            </div>
                            <div class="currency-rate">
                            <input type="number" id="usdRate" step="0.0001" placeholder="30.0000">
                        </div>
                        </div>
                        <div class="exchange-rate-card">
                            <div class="currency-header">
                                <span class="currency-name">æ­å…ƒ</span>
                                <span class="currency-code">(EUR)</span>
                            </div>
                            <div class="currency-rate">
                            <input type="number" id="eurRate" step="0.0001" placeholder="32.0000">
                        </div>
                        </div>
                        <div class="exchange-rate-card">
                            <div class="currency-header">
                                <span class="currency-name">æ—¥åœ“</span>
                                <span class="currency-code">(JPY)</span>
                            </div>
                            <div class="currency-rate">
                            <input type="number" id="jpyRate" step="0.0001" placeholder="0.2000">
                        </div>
                        </div>
                        <div class="exchange-rate-card">
                            <div class="currency-header">
                                <span class="currency-name">äººæ°‘å¹£</span>
                                <span class="currency-code">(CNY)</span>
                            </div>
                            <div class="currency-rate">
                            <input type="number" id="cnyRate" step="0.0001" placeholder="4.2000">
                            </div>
                        </div>
                    </div>
                    <div class="exchange-rate-actions">
                        <button class="btn btn-primary" onclick="expenseTracker.fetchLatestRates()">
                            ğŸ”„ è‡ªå‹•æ›´æ–°åŒ¯ç‡
                        </button>
                        <button class="btn btn-secondary" onclick="expenseTracker.saveExchangeRates()">
                            ğŸ’¾ å„²å­˜åŒ¯ç‡
                        </button>
                        <button class="btn btn-info" onclick="expenseTracker.autoFillMissingRates()">
                            ğŸ”§ è£œè¶³ç¼ºå°‘åŒ¯ç‡
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- æ›´æ–°è‚¡åƒ¹ Loading æ¨¡æ…‹æ¡† -->
    <div id="updateStocksLoadingModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ğŸ“ˆ æ›´æ–°è‚¡åƒ¹ <span id="updateProgressBadge" style="font-size: 0.7em; color: #fff; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; margin-left: 10px; display: none;"></span> <span id="updateResultBadge" style="font-size: 0.7em; color: #fff; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; margin-left: 10px; display: none;"></span></h2>
                <span class="close" onclick="expenseTracker.hideUpdateStocksLoading()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="updateProgressFill"></div>
                    </div>
                    <div class="progress-text" id="updateProgressText">æº–å‚™ä¸­...</div>
                </div>
                
                <div class="stocks-update-list" id="stocksUpdateList">
                    <!-- è‚¡ç¥¨æ›´æ–°ç‹€æ…‹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è³‡ç”¢çµ„åˆç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="assetPortfolioModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>ğŸ“Š è³‡ç”¢çµ„åˆç®¡ç†</h2>
                <span class="close" onclick="expenseTracker.hideAssetPortfolio()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="asset-portfolio-section">
                    <div class="portfolio-header">
                        <h3>æˆ‘çš„è³‡ç”¢çµ„åˆ <span id="assetCountDisplay" style="font-size: 0.8em; color: #666; font-weight: normal;">(0 é …)</span></h3>
                        <button class="btn btn-primary" onclick="expenseTracker.showAddAssetForm()">
                            â• æ–°å¢è³‡ç”¢
                        </button>
                        <button class="btn btn-primary" onclick="expenseTracker.updateAllStockPrices()" id="updateAllStocksBtn">
                            ğŸ“ˆ æ›´æ–°æ‰€æœ‰è‚¡åƒ¹
                        </button>
                    </div>
                    
                    <div class="portfolio-summary">
                        <div class="summary-item">
                            <span class="label">ç¸½è³‡ç”¢åƒ¹å€¼ (å°å¹£)</span>
                            <span class="amount" id="portfolioTotalValue">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">ç¸½æˆæœ¬ (å°å¹£)</span>
                            <span class="amount" id="portfolioTotalCost">$0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">ç¸½æç›Šåƒ¹å€¼ (å°å¹£)</span>
                            <span class="amount" id="portfolioTotalProfitLoss">$0</span>
                        </div>
                    </div>
                    
                    <div class="assets-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>å–å¾—æœ€æ–°åƒ¹æ ¼</th>
                                    <th>è³‡ç”¢åç¨±</th>
                                    <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                    <th>é¡å‹</th>
                                    <th>æ•¸é‡</th>
                                    <th>è³¼è²·å¹³å‡æˆæœ¬åƒ¹</th>
                                    <th>ç•¶å‰åƒ¹æ ¼</th>
                                    <th>æˆæœ¬</th>
                                    <th>ç•¶å‰åƒ¹å€¼</th>
                                    <th>æç›Š</th>
                                    <th>æç›Š%</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                <!-- è³‡ç”¢é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è³‡ç”¢æ¨¡æ…‹æ¡† -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• æ–°å¢è³‡ç”¢</h2>
                <span class="close" onclick="expenseTracker.hideAddAssetForm()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addAssetForm">
                    <div class="form-group">
                        <label for="assetName">è³‡ç”¢åç¨±</label>
                        <input type="text" id="assetName" required placeholder="ä¾‹å¦‚ï¼šAAPL è‚¡ç¥¨">
                    </div>
                    
                    <div class="form-group" id="stockCodeGroup" style="display: none;">
                        <label for="assetStockCode">è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" id="assetStockCode" placeholder="ä¾‹å¦‚ï¼šAAPLã€TSLAã€2330">
                        <small style="color: #666; font-size: 12px;">
                            ç¾è‚¡ï¼šAAPLã€TSLA | å°è‚¡ï¼š2330ã€2317 | æ¸¯è‚¡ï¼š0700ã€9988
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetType">è³‡ç”¢é¡å‹</label>
                        <select id="assetType" required>
                            <option value="">è«‹é¸æ“‡é¡å‹</option>
                            <option value="è‚¡ç¥¨">è‚¡ç¥¨</option>
                            <option value="åŸºé‡‘">åŸºé‡‘</option>
                            <option value="å‚µåˆ¸">å‚µåˆ¸</option>
                            <option value="åŠ å¯†è²¨å¹£">åŠ å¯†è²¨å¹£</option>
                            <option value="ä¸å‹•ç”¢">ä¸å‹•ç”¢</option>
                            <option value="å­˜æ¬¾">å­˜æ¬¾</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetQuantity">è‚¡æ•¸/æ•¸é‡</label>
                        <input type="text" id="assetQuantity" pattern="[0-9]+(\.[0-9]+)?" min="0" required placeholder="ä¾‹å¦‚ï¼š1000" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                    </div>
                    
                    <div class="form-group">
                        <label for="assetCurrency">å¹£åˆ¥</label>
                        <select id="assetCurrency" required>
                            <option value="TWD">å°å¹£ (TWD)</option>
                            <option value="USD">ç¾å…ƒ (USD)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                            <option value="JPY">æ—¥åœ“ (JPY)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetCost">ç¸½æˆæœ¬</label>
                        <input type="number" id="assetCost" step="0.01" placeholder="ä¾‹å¦‚ï¼š100000" required>
                        <small style="color: #666; font-size: 12px;">
                            å¯¦éš›æŠ•å…¥çš„ç¸½é‡‘é¡ï¼ˆåŒ…å«æ‰‹çºŒè²»ç­‰ï¼‰
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetUnitPrice">è³¼è²·å¹³å‡æˆæœ¬åƒ¹ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                        <input type="number" id="assetUnitPrice" step="0.0001" readonly placeholder="è‡ªå‹•è¨ˆç®—">
                        <small style="color: #666; font-size: 12px;">
                            è³¼è²·å¹³å‡æˆæœ¬åƒ¹ = ç¸½æˆæœ¬ Ã· è‚¡æ•¸
                        </small>
                    </div>
                    
                    <div class="form-group" id="currentPriceGroup" style="display: none;">
                        <label for="assetCurrentPrice">ç•¶å‰åƒ¹æ ¼ (é¸å¡«)</label>
                        <input type="number" id="assetCurrentPrice" step="0.0001" placeholder="ä¾‹å¦‚ï¼š160.00">
                        <button type="button" id="fetchCurrentPriceBtn" onclick="expenseTracker.fetchCurrentStockPrice()" style="margin-left: 10px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ“ˆ 
                        </button>
                        <small style="color: #666; font-size: 12px;">
                            ç•™ç©ºå°‡ä½¿ç”¨è³¼è²·åƒ¹æ ¼è¨ˆç®—åƒ¹å€¼
                        </small>
                    </div>
                    
                    <div class="form-group" id="purchaseDateGroup" style="display: none;">
                        <label for="assetPurchaseDate">è³¼è²·æ—¥æœŸ (é¸å¡«)</label>
                        <input type="date" id="assetPurchaseDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="assetDescription">æè¿°</label>
                        <textarea id="assetDescription" placeholder="è³‡ç”¢ç›¸é—œèªªæ˜..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="expenseTracker.hideAddAssetForm()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">æ–°å¢è³‡ç”¢</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


        <style>
            /* æç›Šé¡è‰²æ¨£å¼ */
            .profit {
                color: #28a745;
                font-weight: bold;
            }
            
            .loss {
                color: #dc3545;
                font-weight: bold;
            }
            
            .btn-update {
                background: #28a745;
                color: white;
                border: none;
                padding: 2px 6px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .btn-update:hover {
                background: #218838;
            }
            
            /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
            .assets-table table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
            }
            
            .assets-table th,
            .assets-table td {
                padding: 8px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            
            .assets-table th {
                background-color: #f8f9fa;
                font-weight: bold;
            }
            
            .assets-table tr:hover {
                background-color: #f5f5f5;
            }
            
            /* æœ¬æœˆæ·¨æ”¶å…¥æ¨£å¼ */
            .net-income.positive {
                color: #28a745;
                font-weight: bold;
            }
            
            .net-income.negative {
                color: #dc3545;
                font-weight: bold;
            }
            
            .net-income.positive::before {
                content: "+";
            }
            
            .net-income.negative::before {
                content: "-";
            }
            
            /* ç¾åŒ–æ“ä½œæŒ‰éˆ• */
            .btn-edit, .btn-delete, .btn-update, .btn-copy, .copy-btn {
                background: none !important;
                border: none !important;
                padding: 4px 6px !important;
                margin: 1px !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                min-width: 28px !important;
                height: 28px !important;
            }
            
            .btn-edit, .edit-btn {
                color: #007bff !important;
                background-color: #007bff !important;
            }
            
            .btn-edit:hover, .edit-btn:hover {
                background-color: #0056b3 !important;
                transform: scale(1.05) !important;
            }
            
            .btn-delete, .delete-btn {
                color: #dc3545 !important;
                background-color: #dc3545 !important;
            }
            
            .btn-delete:hover, .delete-btn:hover {
                background-color: #c82333 !important;
                transform: scale(1.05) !important;
            }
            
            .btn-update {
                color: #28a745 !important;
                background-color: rgba(40, 167, 69, 0.1) !important;
            }
            
            .btn-update:hover {
                background-color: rgba(40, 167, 69, 0.2) !important;
                transform: scale(1.05) !important;
            }
            
            .btn-copy, .copy-btn {
                color: #6c757d !important;
                background-color: rgba(108, 117, 125, 0.1) !important;
            }
            
            .btn-copy:hover, .copy-btn:hover {
                background-color: rgba(108, 117, 125, 0.2) !important;
                transform: scale(1.05) !important;
            }
            
            /* æ“ä½œæ¬„ä½æ¨£å¼ */
            .operation-cell {
                white-space: nowrap;
                padding: 8px !important;
            }
            
            .operation-cell .btn-group {
                display: flex;
                gap: 2px;
                align-items: center;
            }
        </style>

    <script>
        // ExpenseTracker é¡åˆ¥
        class ExpenseTracker {
            // æ ¼å¼åŒ–æ•¸å­—ï¼Œæ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦ï¼ˆæ•´æ•¸é¡¯ç¤ºï¼‰
            formatNumber(number) {
                return Math.round(number).toLocaleString('zh-TW');
            }

            constructor() {
                this.records = [];
                this.editingId = null;
                this.currentPage = 1;
                this.recordsPerPage = 20;
                this.currentUser = null;
                this.isFirebaseReady = false;
                
                // è¼‰å…¥å‹•ç•«å…ƒç´ 
                this.loadingOverlay = document.getElementById('loadingOverlay');
                this.loadingText = document.getElementById('loadingText');
                this.loadingSubtext = document.getElementById('loadingSubtext');
                
                // åŒ¯ç‡ç®¡ç†
                this.exchangeRates = {
                    'USD': 30.0,
                    'EUR': 32.0,
                    'JPY': 0.2,
                    'CNY': 4.2
                };
                
                // è³‡ç”¢çµ„åˆ
                this.assets = [];
                this.editingAssetId = null;
                
                // åŒ¯ç‡è‡ªå‹•æ›´æ–°æ¨™è¨˜
                this.isExchangeRateChecked = false;
                this.hasShownStartNotification = false;
                
                // è‚¡ç¥¨äº¤æ˜“è²»ç”¨é…ç½®
                this.tradingFees = {
                    commission: 0.001425,  // æ‰‹çºŒè²» 0.1425%
                    tax: {
                        'TWD': 0.003,      // å°è‚¡äº¤æ˜“ç¨… 0.3%
                        'USD': 0.003,      // ç¾è‚¡äº¤æ˜“ç¨… 0.3%
                        'ETF': 0.001       // ETFäº¤æ˜“ç¨… 0.1%
                    }
                };
                
                this.categoryStructure = {
                    'é£Ÿ': ['å¤–é£Ÿ', 'é£Ÿæ', 'é£²æ–™', 'é›¶é£Ÿ', 'å…¶ä»–'],
                    'è¡£': ['æœé£¾', 'é‹å­', 'é…ä»¶', 'ç¾å®¹', 'å…¶ä»–'],
                    'ä½': ['æˆ¿è²¸', 'ç§Ÿé‡‘', 'æ°´é›»ç“¦æ–¯', 'å±…å®¶ç”¨å“', 'å®¶å…·å®¶é›»', 'è£æ½¢ä¿®ç¹•', 'ç¶²è·¯è²»', 'é€šè¨Š', 'å…¶ä»–'],
                    'è¡Œ': ['äº¤é€šè²»', 'æ²¹è²»', 'åœè»Šè²»', 'å¤§çœ¾é‹è¼¸', 'äº¤é€šå·¥å…·ä¿é¤Š', 'å…¶ä»–'],
                    'è‚²': ['å­¸è²»', 'æ›¸ç±', 'é€²ä¿®', 'æ–‡å…·', 'å…¶ä»–'],
                    'æ¨‚': ['å¨›æ¨‚', 'æ—…éŠ', 'é‹å‹•', 'ç¤¾äº¤', 'å…¶ä»–'],
                    'é†«ç™‚': ['è¨ºç™‚', 'è—¥å“', 'å¥æª¢', 'é†«ç™‚ç”¨å“', 'å…¶ä»–'],
                    'å…¶ä»–æ”¯å‡º': ['æŠ•è³‡', 'æ•™æœƒå¥‰ç»', 'ä¿éšª', 'ç¨…å‹™', 'å…¶ä»–'],
                    'è–ªè³‡': ['æœ¬è–ª', 'çé‡‘', 'å…¼è·', 'å…¶ä»–'],
                    'æŠ•è³‡': ['è‚¡ç¥¨', 'åŸºé‡‘', 'å‚µåˆ¸', 'åŠ å¯†è²¨å¹£', 'å…¶ä»–']
                };
                
                this.init();
            }

            // è¼‰å…¥è³‡æ–™ï¼ˆä¸éœ€è¦ Firebase èªè­‰ï¼‰
            async loadData() {
                try {
                    this.showLoading('è¼‰å…¥è¨˜å¸³è³‡æ–™', 'æ­£åœ¨å¾è³‡æ–™åº«è®€å–è¨˜éŒ„...');
                    this.isFirebaseReady = true; // æ¨™è¨˜ç‚ºå°±ç·’
                        
                        // è¼‰å…¥è¨˜éŒ„
                        await this.loadRecordsFromFirebase();
                
                // è¼‰å…¥åŒ¯ç‡
                try {
                    await this.loadExchangeRatesFromFirebase();
                    console.log('åŒ¯ç‡è¼‰å…¥å®Œæˆ');
                } catch (error) {
                    console.error('åŒ¯ç‡è¼‰å…¥å¤±æ•—:', error);
                }
                
                        this.hideLoading();
                
                // ç•«é¢è¼‰å…¥å®Œæˆå¾Œï¼Œå»¶é²åŸ·è¡Œè‡ªå‹•æ›´æ–°åŒ¯ç‡
                setTimeout(async () => {
                    if (!this.isExchangeRateChecked) {
                        await this.checkAndAutoFillTodayRates();
                    }
                }, 2000);
                } catch (error) {
                    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    this.hideLoading();
                    alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
            }

            // é¡¯ç¤ºFirebaseéŒ¯èª¤è¨Šæ¯
            showFirebaseError(error) {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">âš ï¸</div>
                                <h2>ç³»çµ±åˆå§‹åŒ–å¤±æ•—</h2>
                                <p>å¾ˆæŠ±æ­‰ï¼Œç³»çµ±ç„¡æ³•æ­£å¸¸è¼‰å…¥ã€‚è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š</p>
                                <div class="user-info">
                                    <p><strong>éŒ¯èª¤è¨Šæ¯:</strong> ${error.message}</p>
                                    <p><strong>å¯èƒ½åŸå› :</strong></p>
                                    <ul style="text-align: left; margin: 10px 0;">
                                        <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                                        <li>Firebaseæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</li>
                                        <li>ç€è¦½å™¨å¿«å–å•é¡Œ</li>
                                        <li>Firebaseé…ç½®éŒ¯èª¤</li>
                                    </ul>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                    <button onclick="window.location.href='index.html';" class="logout-btn">
                                        è¿”å›ç™»å…¥
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>å¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // æª¢æŸ¥ä½¿ç”¨è€…å•Ÿç”¨ç‹€æ…‹ï¼ˆæ–°ç³»çµ±ä¸éœ€è¦ï¼Œç›´æ¥è¿”å› trueï¼‰
            async checkUserStatus(user) {
                // æ–°ç³»çµ±ä¸éœ€è¦ Firebase èªè­‰ï¼Œç›´æ¥è¿”å›å•Ÿç”¨ç‹€æ…‹
                return { isActive: true };
            }

            // é¡¯ç¤ºç´¢å¼•éŒ¯èª¤è¨Šæ¯
            showIndexError() {
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">ğŸ”</div>
                                <h2>Firebase ç´¢å¼•è¨­å®š</h2>
                                <p>ç³»çµ±éœ€è¦å»ºç«‹ Firebase ç´¢å¼•æ‰èƒ½æ­£å¸¸é‹ä½œã€‚</p>
                                <div class="user-info">
                                    <p><strong>è§£æ±ºæ­¥é©Ÿ:</strong></p>
                                    <ol style="text-align: left; margin: 10px 0;">
                                        <li>å‰å¾€ <a href="https://console.firebase.google.com/project/expenses-91280/firestore/indexes" target="_blank">Firebase Console</a></li>
                                        <li>é»æ“Šã€Œå»ºç«‹ç´¢å¼•ã€</li>
                                        <li>è¨­å®šé›†åˆ: <code>records</code></li>
                                        <li>è¨­å®šæ¬„ä½: <code>userId</code> (å‡åº), <code>date</code> (é™åº)</li>
                                        <li>ç­‰å¾…ç´¢å¼•å»ºç«‹å®Œæˆï¼ˆé€šå¸¸éœ€è¦å¹¾åˆ†é˜ï¼‰</li>
                                        <li>é‡æ–°æ•´ç†æ­¤é é¢</li>
                                    </ol>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="location.reload();" class="logout-btn" style="background: #3498db;">
                                        é‡æ–°è¼‰å…¥
                                    </button>
                                    <button onclick="window.location.href='index.html';" class="logout-btn">
                                        è¿”å›ç™»å…¥
                                    </button>
                                </div>
                                <div style="margin-top: 20px; font-size: 0.9em; color: #999;">
                                    <p>å¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Šï¼ˆä¸å†éœ€è¦ç™»å‡ºåŠŸèƒ½ï¼‰
            showUserInfo(user) {
                const userInfo = document.getElementById('userInfo');
                const userEmail = document.getElementById('userEmail');
                
                if (userInfo && userEmail) {
                    // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                    userInfo.style.display = 'flex';
                    userEmail.textContent = user.displayName || user.email;
                }
            }

            // é¡¯ç¤ºæœªå•Ÿç”¨ä½¿ç”¨è€…è¨Šæ¯
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showLoading(message = 'è¼‰å…¥ä¸­', submessage = 'è«‹ç¨å€™') {
                if (this.loadingText) this.loadingText.textContent = message;
                if (this.loadingSubtext) this.loadingSubtext.textContent = submessage;
                if (this.loadingOverlay) this.loadingOverlay.style.display = 'flex';
            }

            // éš±è—è¼‰å…¥å‹•ç•«
            hideLoading() {
                if (this.loadingOverlay) this.loadingOverlay.style.display = 'none';
            }

            showInactiveUserMessage(user) {
                // éš±è—æ‰€æœ‰è¼¸å…¥è¡¨å–®
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="inactive-user-container">
                            <div class="inactive-user-card">
                                <div class="inactive-user-icon">â³</div>
                                <h2>ä½¿ç”¨è€…å°šæœªå•Ÿç”¨</h2>
                                <p>è¦ªæ„›çš„ <strong>${user.displayName || user.email}</strong>ï¼Œ</p>
                                <p>æ‚¨çš„å¸³è™Ÿç›®å‰å°šæœªå•Ÿç”¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡é€²è¡Œå•Ÿç”¨ã€‚</p>
                                <div class="user-info">
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>ç‹€æ…‹:</strong> ç­‰å¾…å•Ÿç”¨</p>
                                </div>
                                <div class="action-buttons">
                                    <button onclick="window.location.href='index.html';" class="logout-btn">
                                        è¿”å›å„€è¡¨æ¿
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // ç­‰å¾… Firebase è¼‰å…¥
            waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5ç§’è¶…æ™‚ (50 * 100ms)
                    
                    const checkFirebase = () => {
                        attempts++;
                        
                        // é¦–å…ˆæª¢æŸ¥ firebaseLoaded æ¨™è¨˜
                        if (window.firebaseLoaded) {
                            console.log(`Firebase SDK è¼‰å…¥å®Œæˆï¼Œå˜—è©¦æ¬¡æ•¸: ${attempts}`);
                            resolve();
                            return;
                        }
                        
                        // æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„Firebaseå‡½æ•¸
                        const requiredFunctions = [
                            'firebaseAuth', 'firebaseDb', 'firebaseCollection', 
                            'firebaseAddDoc', 'firebaseGetDocs', 'firebaseUpdateDoc', 
                            'firebaseDeleteDoc', 'firebaseDoc', 'firebaseSetDoc',
                            'firebaseQuery', 'firebaseOrderBy', 'firebaseWhere', 
                            'firebaseServerTimestamp', 'firebaseOnAuthStateChanged'
                        ];
                        
                        const loadedFunctions = requiredFunctions.filter(func => {
                            return window[func] && typeof window[func] === 'function';
                        });
                        
                        const missingFunctions = requiredFunctions.filter(func => !window[func]);
                        
                        console.log(`Firebase è¼‰å…¥æª¢æŸ¥ (${attempts}/${maxAttempts}): å·²è¼‰å…¥ ${loadedFunctions.length}/${requiredFunctions.length} å€‹å‡½æ•¸`);
                        
                        if (window.firebaseAuth && window.firebaseDb && loadedFunctions.length === requiredFunctions.length) {
                            console.log(`Firebase è¼‰å…¥æˆåŠŸï¼Œå˜—è©¦æ¬¡æ•¸: ${attempts}`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.error('Firebase è¼‰å…¥è¶…æ™‚');
                            console.error('å·²è¼‰å…¥çš„å‡½æ•¸:', loadedFunctions);
                            console.error('ç¼ºå°‘çš„å‡½æ•¸:', missingFunctions);
                            reject(new Error(`Firebase SDK è¼‰å…¥è¶…æ™‚ï¼Œç¼ºå°‘å‡½æ•¸: ${missingFunctions.join(', ')}`));
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    
                    checkFirebase();
                });
            }

            // å¾ API è¼‰å…¥è¨˜éŒ„
            async loadRecordsFromFirebase() {
                try {
                    console.log('é–‹å§‹å¾ API è¼‰å…¥è¨˜éŒ„...');
                    // ç¢ºä¿ apiService å·²è¼‰å…¥
                    if (!window.apiService || !window.apiService.getAllExpenses) {
                        throw new Error('API Service æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    }
                    // ä½¿ç”¨ API è¼‰å…¥æ‰€æœ‰è¨˜éŒ„
                    const expenses = await window.apiService.getAllExpenses();
                    this.records = expenses.map(expense => ({
                        id: expense.id,
                        firebaseId: expense.firebaseId,
                        type: expense.type,
                        member: expense.member,
                        mainCategory: expense.mainCategory,
                        subCategory: expense.subCategory,
                        amount: parseFloat(expense.amount),
                        description: expense.description,
                        date: expense.date,
                        currency: expense.currency || 'TWD',
                        exchangeRate: parseFloat(expense.exchangeRate) || 1,
                        createdAt: expense.createdAt ? new Date(expense.createdAt) : null
                    }));
                    
                    // æŒ‰æ—¥æœŸé™åºæ’åº
                    this.records.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    console.log(`å¾ API è¼‰å…¥äº† ${this.records.length} ç­†è¨˜éŒ„ï¼ˆå·²æŒ‰æ—¥æœŸé™åºæ’åˆ—ï¼‰`);
                    // é‡ç½®åˆ†é åˆ°ç¬¬ä¸€é ï¼Œç¢ºä¿æ–°è¨˜éŒ„èƒ½é¡¯ç¤º
                    this.currentPage = 1;
                    await this.updateDisplay();
                } catch (error) {
                    console.error('å¾ API è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                    this.showNotification('è¼‰å…¥è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
                }
            }

            // æ›´æ–°é¡¯ç¤º
            async updateDisplay(resetPage = false) {
                console.log('updateDisplay é–‹å§‹åŸ·è¡Œï¼Œç•¶å‰è¨˜éŒ„æ•¸é‡:', this.records.length);
                const filteredRecords = this.getCurrentFilteredRecords();
                console.log('ç¯©é¸å¾Œçš„è¨˜éŒ„æ•¸é‡:', filteredRecords.length);
                
                // å¦‚æœéœ€è¦é‡ç½®åˆ†é ï¼Œå‰‡é‡ç½®åˆ°ç¬¬ä¸€é 
                if (resetPage) {
                    this.currentPage = 1;
                    console.log('é‡ç½®åˆ†é åˆ°ç¬¬ä¸€é ');
                }
                
                this.displayRecords(filteredRecords);
                await this.updateSummary(filteredRecords);
                console.log('updateDisplay åŸ·è¡Œå®Œæˆ');
            }

            // é¡¯ç¤ºè¨˜éŒ„
            displayRecords(records) {
                console.log('displayRecords é–‹å§‹åŸ·è¡Œï¼Œå‚³å…¥çš„è¨˜éŒ„æ•¸é‡:', records.length);
                const recordsList = document.getElementById('recordsList');
                if (!recordsList) {
                    console.error('æ‰¾ä¸åˆ° recordsList å…ƒç´ ');
                    return;
                }
                
                // ä¿å­˜ç•¶å‰çš„ç¯©é¸å€¼ï¼Œå¦‚æœæ²’æœ‰è¨­å®šå‰‡ä½¿ç”¨ç•¶å‰å¹´æœˆä½œç‚ºé è¨­å€¼
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                const currentFilters = {
                    year: document.getElementById('tableFilterYear')?.value || defaultYear,
                    month: document.getElementById('tableFilterMonth')?.value || defaultMonth,
                    member: Array.from(document.getElementById('tableFilterMember')?.selectedOptions || []).map(option => option.value),
                    type: Array.from(document.getElementById('tableFilterType')?.selectedOptions || []).map(option => option.value),
                    mainCategory: Array.from(document.getElementById('tableFilterMainCategory')?.selectedOptions || []).map(option => option.value),
                    subCategory: Array.from(document.getElementById('tableFilterSubCategory')?.selectedOptions || []).map(option => option.value)
                };

                // ç²å–æ‰€æœ‰å¯èƒ½çš„ç¯©é¸é¸é …ï¼ˆä½¿ç”¨æ‰€æœ‰è¨˜éŒ„ï¼Œä¸æ˜¯ç¯©é¸å¾Œçš„è¨˜éŒ„ï¼‰
                const allMembers = [...new Set(this.records.map(r => r.member))];
                const allTypes = [...new Set(this.records.map(r => r.type))];
                
                // æ ¹æ“šå·²é¸æ“‡çš„é¡å‹éæ¿¾é¡åˆ¥
                let filteredMainCategories = [...new Set(this.records.map(r => r.mainCategory))];
                if (currentFilters.type && currentFilters.type.length > 0) {
                    filteredMainCategories = [...new Set(this.records
                        .filter(r => currentFilters.type.includes(r.type))
                        .map(r => r.mainCategory))];
                }
                
                // æ ¹æ“šå·²é¸æ“‡çš„é¡åˆ¥éæ¿¾ç´°é …
                let filteredSubCategories = [...new Set(this.records.map(r => r.subCategory))];
                if (currentFilters.mainCategory && currentFilters.mainCategory.length > 0) {
                    filteredSubCategories = [...new Set(this.records
                        .filter(r => currentFilters.mainCategory.includes(r.mainCategory))
                        .map(r => r.subCategory))];
                }
                const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                const allMonths = [...new Set(this.records.map(r => r.date.split('-')[1]))].sort((a, b) => a - b);

                // ç”Ÿæˆç¯©é¸æ¢ä»¶HTML
                const filterHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <h3 style="margin: 0; display: inline-block;">ç¯©é¸æ¢ä»¶</h3>
                            <button id="resetFilters" onclick="expenseTracker.resetFilters()" title="é‡ç½®ç¯©é¸æ¢ä»¶" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">
                                ğŸ”„
                            </button>
                        </div>
                        <div class="filter-group">
                            <label for="tableFilterYear">å¹´ä»½ï¼š</label>
                            <select id="tableFilterYear" onchange="expenseTracker.handleTableFilterChange()" style="height: auto; min-height: auto;">
                                ${allYears.map(year => `<option value="${year}" ${currentFilters.year === year ? 'selected' : ''}>${year}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMonth">æœˆä»½ï¼š</label>
                            <select id="tableFilterMonth" onchange="expenseTracker.handleTableFilterChange()" style="height: auto; min-height: auto;">
                                ${allMonths.map(month => `<option value="${month}" ${currentFilters.month === month ? 'selected' : ''}>${month}æœˆ</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMember">å®¶åº­æˆå“¡ï¼š</label>
                            <select id="tableFilterMember" onchange="expenseTracker.handleTableFilterChange()" multiple style="min-height: 80px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allMembers.map(member => `<option value="${member}" ${currentFilters.member && currentFilters.member.includes(member) ? 'selected' : ''}>${member}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterType">é¡å‹ï¼š</label>
                            <select id="tableFilterType" onchange="expenseTracker.handleTableFilterChange(event)" multiple style="min-height: 60px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${allTypes.map(type => `<option value="${type}" ${currentFilters.type && currentFilters.type.includes(type) ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterMainCategory">é¡åˆ¥ï¼š</label>
                            <select id="tableFilterMainCategory" onchange="expenseTracker.handleTableFilterChange(event)" multiple style="min-height: 100px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${filteredMainCategories.map(cat => `<option value="${cat}" ${currentFilters.mainCategory && currentFilters.mainCategory.includes(cat) ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                            
                            <label for="tableFilterSubCategory">ç´°é …ï¼š</label>
                            <select id="tableFilterSubCategory" onchange="expenseTracker.handleTableFilterChange(event)" multiple style="min-height: 120px;" onmousedown="expenseTracker.toggleOption(event)">
                                ${filteredSubCategories.map(sub => `<option value="${sub}" ${currentFilters.subCategory && currentFilters.subCategory.includes(sub) ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
                
                if (records.length === 0) {
                    // ç”Ÿæˆç©ºè¡¨æ ¼HTMLï¼ˆä¿ç•™æ¨™é¡Œï¼‰
                    const emptyTableHTML = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å®¶åº­æˆå“¡</th>
                                    <th>é¡å‹</th>
                                    <th>é¡åˆ¥</th>
                                    <th>ç´°é …</th>
                                    <th>é‡‘é¡</th>
                                    <th>æè¿°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" style="padding: 40px; text-align: center; color: #999;">æš«ç„¡è¨˜éŒ„</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    recordsList.innerHTML = filterHTML + emptyTableHTML;
                    this.updatePagination(0);
                    return;
                }

                // è¨ˆç®—åˆ†é 
                const totalPages = Math.ceil(records.length / this.recordsPerPage);
                const startIndex = (this.currentPage - 1) * this.recordsPerPage;
                const endIndex = startIndex + this.recordsPerPage;
                const pageRecords = records.slice(startIndex, endIndex);

                // ç”Ÿæˆè¡¨æ ¼HTML
                const tableHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>å®¶åº­æˆå“¡</th>
                                <th>é¡å‹</th>
                                <th>é¡åˆ¥</th>
                                <th>ç´°é …</th>
                                <th>é‡‘é¡</th>
                                <th>æè¿°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageRecords
                                .sort((a, b) => {
                                    // å…ˆæŒ‰æ—¥æœŸæ’åºï¼ˆé™åºï¼‰
                                    const dateCompare = new Date(b.date) - new Date(a.date);
                                    if (dateCompare !== 0) {
                                        return dateCompare;
                                    }
                                    // å¦‚æœæ—¥æœŸç›¸åŒï¼Œå†æŒ‰å»ºç«‹æ™‚é–“æ’åºï¼ˆé™åºï¼Œå¾Œå»ºç«‹çš„æ’åœ¨å‰é¢ï¼‰
                                    const getTimestamp = (record) => {
                                        if (!record.createdAt) return 0;
                                        // è™•ç† Firebase Timestamp ç‰©ä»¶
                                        if (record.createdAt && typeof record.createdAt.toMillis === 'function') {
                                            return record.createdAt.toMillis();
                                        }
                                        if (record.createdAt && record.createdAt.seconds) {
                                            return record.createdAt.seconds * 1000;
                                        }
                                        return 0;
                                    };
                                    const aTime = getTimestamp(a);
                                    const bTime = getTimestamp(b);
                                    return bTime - aTime;
                                })
                                .map(record => {
                                    const amountClass = record.type === 'æ”¶å…¥' ? 'amount-income' : 
                                                       record.type === 'æ”¯å‡º' ? 'amount-expense' : 'amount-asset';
                                    const amountPrefix = record.type === 'æ”¶å…¥' ? '+' : 
                                                        record.type === 'è³‡ç”¢' ? '+' : '-';
                                    
                                    return `
                                        <tr>
                                            <td>${record.date}</td>
                                            <td>${record.member}</td>
                                            <td>${record.type}</td>
                                            <td>${record.mainCategory}</td>
                                            <td>${record.subCategory}</td>
                                            <td class="${amountClass}">${amountPrefix}$${this.formatNumber(record.amount)} (${record.currency || 'TWD'})</td>
                                            <td>${record.description || '-'}</td>
                                                                                <td>
                                        <div class="action-buttons">
                                            <button class="action-btn edit-btn" onclick="expenseTracker.editRecord('${record.id}')" title="ç·¨è¼¯è¨˜éŒ„" style="padding: 2px 4px; font-size: 10px;"></button>
                                            <button class="action-btn copy-btn" onclick="expenseTracker.copyRecord('${record.id}')" title="è¤‡è£½è¨˜éŒ„åˆ°è¡¨å–®ï¼ˆæ—¥æœŸä¸è¼‰å…¥ï¼‰" style="padding: 2px 4px; font-size: 10px;">ğŸ“‹</button>
                                            <button class="action-btn delete-btn" onclick="expenseTracker.deleteRecord('${record.id}')" title="åˆªé™¤è¨˜éŒ„" style="padding: 2px 4px; font-size: 10px;"></button>
                                        </div>
                                    </td>
                                        </tr>
                                    `;
                                }).join('')}
                        </tbody>
                    </table>
                `;
                
                recordsList.innerHTML = filterHTML + tableHTML;
                this.updatePagination(records.length);
                console.log('displayRecords åŸ·è¡Œå®Œæˆï¼Œå·²æ›´æ–° DOM');
            }

            // åˆ‡æ›å¤šé¸é¸é …
            toggleOption(event) {
                event.preventDefault();
                const option = event.target;
                if (option.tagName === 'OPTION') {
                    option.selected = !option.selected;
                    // è§¸ç™¼ç¯©é¸æ›´æ–°
                    this.handleTableFilterToggle();
                }
            }

            // é¡¯ç¤ºé€šçŸ¥
            showNotification(message, type = 'success', duration = 3000) {
                const container = document.getElementById('notificationContainer');
                if (!container) {
                    console.warn('notificationContainer ä¸å­˜åœ¨ï¼Œç„¡æ³•é¡¯ç¤ºé€šçŸ¥:', message);
                    return;
                }
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    ${message}
                    <button class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
                `;
                
                container.appendChild(notification);
                
                // è§¸ç™¼å‹•ç•«
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                // è‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }

            // æ›´æ–°æ‘˜è¦
            async updateSummary(filteredRecords) {
                // æŒ‰ç…§å¹£åˆ¥è½‰æ›ç‚ºTWDé‡‘é¡é€²è¡Œçµ±è¨ˆè¨ˆç®—
                let filteredIncome = 0;
                let filteredExpense = 0;
                
                for (const record of filteredRecords) {
                    const recordDate = new Date(record.date);
                    const rate = await this.getExchangeRateForDate(record.currency || 'TWD', recordDate);
                    
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ­·å²åŒ¯ç‡ï¼Œä½¿ç”¨ç•¶å‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨
                    const finalRate = rate !== null ? rate : (this.exchangeRates[record.currency || 'TWD'] || 1);
                    const amountTWD = record.amount * finalRate;
                    
                    // èª¿è©¦ä¿¡æ¯ï¼šé¡¯ç¤ºä½¿ç”¨çš„åŒ¯ç‡
                    if (record.currency && record.currency !== 'TWD') {
                        const rateSource = rate !== null ? 'æ­·å²åŒ¯ç‡' : 'ç•¶å‰åŒ¯ç‡';
                        console.log(`ğŸ’° ${record.date} ${record.currency} ${record.amount} â†’ TWD ${amountTWD.toFixed(2)} (${rateSource}: ${finalRate})`);
                    }
                    
                    if (record.type === 'æ”¶å…¥') {
                        filteredIncome += amountTWD;
                    } else if (record.type === 'æ”¯å‡º') {
                        filteredExpense += amountTWD;
                    }
                }
                
                const filteredNetIncome = filteredIncome - filteredExpense;
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('monthlyIncome').textContent = '$' + this.formatNumber(filteredIncome);
                document.getElementById('monthlyExpense').textContent = '$' + this.formatNumber(filteredExpense);
                
                // æ·¨æ”¶å…¥é¡¯ç¤º
                const netIncomeElement = document.getElementById('monthlyNetIncome');
                netIncomeElement.textContent = '$' + this.formatNumber(Math.abs(filteredNetIncome));
                
                // æ ¹æ“šæ­£è² å€¼è¨­å®šé¡è‰²
                if (filteredNetIncome >= 0) {
                    netIncomeElement.className = 'amount net-income positive';
                } else {
                    netIncomeElement.className = 'amount net-income negative';
                }
                
                console.log(`ç¯©é¸å¾Œçµ±è¨ˆ: æ”¶å…¥ $${filteredIncome}, æ”¯å‡º $${filteredExpense}, æ·¨æ”¶å…¥ $${filteredNetIncome}`);
            }

            // ç²å–ç•¶å‰ç¯©é¸å¾Œçš„è¨˜éŒ„
            getCurrentFilteredRecords() {
                // ç²å–è¡¨æ ¼ç¯©é¸å™¨çš„å€¼ï¼Œå¦‚æœæ²’æœ‰è¨­å®šå‰‡ä½¿ç”¨ç•¶å‰å¹´æœˆä½œç‚ºé è¨­å€¼
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                const yearFilter = document.getElementById('tableFilterYear')?.value || defaultYear;
                const monthFilter = document.getElementById('tableFilterMonth')?.value || defaultMonth;
                
                // ç²å–å¤šé¸çš„å€¼
                const memberSelect = document.getElementById('tableFilterMember');
                const typeSelect = document.getElementById('tableFilterType');
                const mainCategorySelect = document.getElementById('tableFilterMainCategory');
                const subCategorySelect = document.getElementById('tableFilterSubCategory');
                
                const selectedMembers = Array.from(memberSelect?.selectedOptions || []).map(option => option.value);
                const selectedTypes = Array.from(typeSelect?.selectedOptions || []).map(option => option.value);
                const selectedMainCategories = Array.from(mainCategorySelect?.selectedOptions || []).map(option => option.value);
                const selectedSubCategories = Array.from(subCategorySelect?.selectedOptions || []).map(option => option.value);

                console.log('getCurrentFilteredRecords ç¯©é¸æ¢ä»¶:', {
                    yearFilter,
                    monthFilter,
                    selectedMembers,
                    selectedTypes,
                    selectedMainCategories,
                    selectedSubCategories,
                    totalRecords: this.records.length
                });

                // ç¯©é¸è¨˜éŒ„
                const filtered = this.records.filter(record => {
                    const recordYear = record.date.split('-')[0];
                    const recordMonth = record.date.split('-')[1];
                    
                    const matchesYearMonth = (recordYear === yearFilter) && (recordMonth === monthFilter);
                    const matchesMember = selectedMembers.length === 0 || selectedMembers.includes(record.member);
                    const matchesType = selectedTypes.length === 0 || selectedTypes.includes(record.type);
                    const matchesMainCategory = selectedMainCategories.length === 0 || selectedMainCategories.includes(record.mainCategory);
                    const matchesSubCategory = selectedSubCategories.length === 0 || selectedSubCategories.includes(record.subCategory);
                    
                    const matches = matchesYearMonth && matchesMember && matchesType && matchesMainCategory && matchesSubCategory;
                    
                    // å¦‚æœè¨˜éŒ„ä¸åŒ¹é…ï¼Œè¨˜éŒ„è©³ç´°ä¿¡æ¯ï¼ˆç‰¹åˆ¥æ˜¯å°æ–°è¨˜éŒ„ï¼‰
                    if (!matches && record.date) {
                        const recordDate = new Date(record.date);
                        const isNewRecord = recordDate && recordDate.getTime() > Date.now() - 60000; // æœ€è¿‘1åˆ†é˜å…§çš„è¨˜éŒ„
                        if (isNewRecord || this.records.indexOf(record) >= this.records.length - 1) {
                            console.log('è¨˜éŒ„è¢«ç¯©é¸æ‰:', {
                                id: record.id,
                                date: record.date,
                                recordYear,
                                recordMonth,
                                yearFilter,
                                monthFilter,
                                matchesYearMonth,
                                matchesMember,
                                matchesType,
                                matchesMainCategory,
                                matchesSubCategory
                            });
                        }
                    }
                    
                    return matches;
                });
                
                console.log('getCurrentFilteredRecords ç¯©é¸çµæœ:', filtered.length, 'ç­†è¨˜éŒ„');
                
                // æª¢æŸ¥æ–°è¨˜éŒ„æ˜¯å¦åœ¨ç¯©é¸çµæœä¸­
                const latestRecord = this.records[this.records.length - 1];
                if (latestRecord && latestRecord.date) {
                    const isInFiltered = filtered.some(r => r.id === latestRecord.id);
                    console.log('æœ€æ–°è¨˜éŒ„æ˜¯å¦åœ¨ç¯©é¸çµæœä¸­:', isInFiltered, 'è¨˜éŒ„ID:', latestRecord.id, 'è¨˜éŒ„æ—¥æœŸ:', latestRecord.date);
                }
                
                return filtered;
            }

            // åŒ…è£å‡½æ•¸ç”¨æ–¼ HTML äº‹ä»¶è™•ç†
            async handleTableFilterChange(event) {
                // æª¢æŸ¥æ˜¯å“ªå€‹ç¯©é¸å™¨æ”¹è®Šäº†
                const target = event ? event.target : null;
                const mainCategorySelect = document.getElementById('tableFilterMainCategory');
                const subCategorySelect = document.getElementById('tableFilterSubCategory');
                
                // å¦‚æœé¡å‹æ”¹è®Šï¼Œæ¸…é™¤é¡åˆ¥å’Œç´°é …çš„é¸æ“‡
                if (target && target.id === 'tableFilterType') {
                    // æ¸…é™¤é¡åˆ¥é¸æ“‡
                    if (mainCategorySelect) {
                        Array.from(mainCategorySelect.options).forEach(option => {
                            option.selected = false;
                        });
                    }
                    // æ¸…é™¤ç´°é …é¸æ“‡
                    if (subCategorySelect) {
                        Array.from(subCategorySelect.options).forEach(option => {
                            option.selected = false;
                        });
                    }
                }
                
                // å¦‚æœé¡åˆ¥æ”¹è®Šï¼Œæ¸…é™¤ç´°é …çš„é¸æ“‡
                if (target && target.id === 'tableFilterMainCategory') {
                    if (subCategorySelect) {
                        Array.from(subCategorySelect.options).forEach(option => {
                            option.selected = false;
                        });
                    }
                }
                
                await this.applyTableFilter(true);
            }
            
            async handleTableFilterToggle() {
                await this.applyTableFilter(true);
            }
            
            async handleUpdateDisplay(resetPage = false) {
                await this.updateDisplay(resetPage);
            }

            // æ‡‰ç”¨è¡¨æ ¼ç¯©é¸
            async applyTableFilter(resetPage = true) {
                const filteredRecords = this.getCurrentFilteredRecords();

                // åªæœ‰åœ¨éœ€è¦æ™‚æ‰é‡ç½®åˆ°ç¬¬ä¸€é 
                if (resetPage) {
                    this.currentPage = 1;
                }
                this.displayRecords(filteredRecords);
                // çµ±è¨ˆæ‡‰è©²åŸºæ–¼ç¯©é¸å¾Œçš„è¨˜éŒ„ï¼Œèˆ‡è¡¨æ ¼é¡¯ç¤ºä¿æŒä¸€è‡´
                await this.updateSummary(filteredRecords);
            }

            // é‡ç½®ç¯©é¸æ¢ä»¶
            async resetFilters() {
                // å–å¾—ç•¶å‰å¹´æœˆä½œç‚ºé è¨­å€¼
                const currentDate = new Date();
                const defaultYear = currentDate.getFullYear().toString();
                const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                // é‡ç½®æ‰€æœ‰ç¯©é¸é¸å–®åˆ°é è¨­å€¼
                const yearElement = document.getElementById('tableFilterYear');
                const monthElement = document.getElementById('tableFilterMonth');
                const memberElement = document.getElementById('tableFilterMember');
                const typeElement = document.getElementById('tableFilterType');
                const mainCategoryElement = document.getElementById('tableFilterMainCategory');
                const subCategoryElement = document.getElementById('tableFilterSubCategory');
                
                if (yearElement) yearElement.value = defaultYear;
                if (monthElement) monthElement.value = defaultMonth;
                
                // é‡ç½®å¤šé¸æ¬„ä½ï¼ˆæ¸…é™¤æ‰€æœ‰é¸é …ï¼‰
                if (memberElement) {
                    Array.from(memberElement.options).forEach(option => option.selected = false);
                }
                if (typeElement) {
                    Array.from(typeElement.options).forEach(option => option.selected = false);
                }
                if (mainCategoryElement) {
                    Array.from(mainCategoryElement.options).forEach(option => option.selected = false);
                }
                if (subCategoryElement) {
                    Array.from(subCategoryElement.options).forEach(option => option.selected = false);
                }
                
                // é‡æ–°æ‡‰ç”¨ç¯©é¸
                await this.handleTableFilterChange(null);
            }

            // æ›´æ–°åˆ†é 
            updatePagination(totalRecords) {
                const totalPages = Math.ceil(totalRecords / this.recordsPerPage);
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                
                // æ›´æ–°é é¢ä¿¡æ¯
                if (totalRecords === 0) {
                    pageInfo.textContent = 'æš«ç„¡è¨˜éŒ„';
                } else {
                    const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
                    const endRecord = Math.min(this.currentPage * this.recordsPerPage, totalRecords);
                    pageInfo.textContent = `ç¬¬ ${this.currentPage} é ï¼Œå…± ${totalPages} é  (é¡¯ç¤º ${startRecord}-${endRecord} / ${totalRecords} ç­†)`;
                }
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                prevBtn.disabled = this.currentPage <= 1;
                nextBtn.disabled = this.currentPage >= totalPages;
                
                // å¦‚æœç•¶å‰é è¶…éç¸½é æ•¸ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é 
                if (this.currentPage > totalPages && totalPages > 0) {
                    this.currentPage = 1;
                    this.displayRecords(this.getCurrentFilteredRecords());
                }
            }

            // é¡¯ç¤ºåœ–è¡¨å½ˆçª—
            async showChartsModal() {
                console.log('é¡¯ç¤ºåœ–è¡¨å½ˆçª—');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // æ›´æ–°ç¯©é¸å™¨ä¸¦è¨­å®šé è¨­å€¼
                    this.updateChartFilters();
                    
                    // è³‡ç”¢åœ“é¤…åœ–å·²éš±è—ï¼Œä¸éœ€è¦è¼‰å…¥è³‡ç”¢è³‡æ–™
                    console.log('è³‡ç”¢åœ“é¤…åœ–å·²éš±è—ï¼Œè·³éè³‡ç”¢è³‡æ–™è¼‰å…¥');
                    
                    // ç«‹å³è¼‰å…¥åœ–è¡¨
                    await this.updateCharts();
                } else {
                    console.error('æ‰¾ä¸åˆ°åœ–è¡¨å½ˆçª—å…ƒç´ ');
                }
            }

            // æ›´æ–°åœ–è¡¨ç¯©é¸å™¨
            updateChartFilters() {
                console.log('updateChartFilters - è¨˜éŒ„æ•¸é‡:', this.records.length);
                console.log('updateChartFilters - è¨˜éŒ„è³‡æ–™:', this.records);
                
                // æ›´æ–°å¹´ä»½ç¯©é¸å™¨
                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    const allYears = [...new Set(this.records.map(r => r.date.split('-')[0]))].sort((a, b) => b - a);
                    console.log('å¯ç”¨çš„å¹´ä»½:', allYears);
                    chartFilterYear.innerHTML = allYears.map(year => `<option value="${year}">${year}</option>`).join('');
                    
                    // è¨­å®šé è¨­å€¼ç‚ºç•¶å‰å¹´ä»½
                    const currentYear = new Date().getFullYear().toString();
                    console.log('ç•¶å‰å¹´ä»½:', currentYear);
                    if (allYears.includes(currentYear)) {
                        chartFilterYear.value = currentYear;
                        console.log('è¨­å®šå¹´ä»½ç‚ºç•¶å‰å¹´ä»½:', currentYear);
                    } else if (allYears.length > 0) {
                        chartFilterYear.value = allYears[0]; // è¨­å®šç‚ºæœ€æ–°çš„å¹´ä»½
                        console.log('è¨­å®šå¹´ä»½ç‚ºæœ€æ–°å¹´ä»½:', allYears[0]);
                    }
                }
                
                // æ›´æ–°æœˆä»½ç¯©é¸å™¨
                const chartFilterMonth = document.getElementById('chartFilterMonth');
                if (chartFilterMonth) {
                    // é è¨­å€¼è¨­ç‚ºã€Œæ•´å¹´ã€ï¼ˆç©ºå€¼ï¼‰ï¼Œè®“ç”¨æˆ¶å¯ä»¥é¸æ“‡æŸ¥çœ‹æ•´å¹´æˆ–ç‰¹å®šæœˆä»½
                    chartFilterMonth.value = '';
                    console.log('è¨­å®šæœˆä»½ç‚ºã€Œæ•´å¹´ã€');
                }
            }

            // éš±è—åœ–è¡¨å½ˆçª—
            hideChartsModal() {
                console.log('éš±è—åœ–è¡¨å½ˆçª—');
                const modal = document.getElementById('chartsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // ========== åŒ¯ç‡ç®¡ç†åŠŸèƒ½ ==========
            
            // æ¯æ—¥åŒ¯ç‡ç®¡ç†
            async getExchangeRateForDate(currency, date) {
                if (currency === 'TWD') {
                    return 1;
                }
                
                try {
                    const dateStr = this.formatDateForFirebase(date);
                    console.log(`ğŸ” æŸ¥è©¢ ${currency} åœ¨ ${dateStr} çš„åŒ¯ç‡`);
                    
                    // åªå˜—è©¦å–å¾—è©²æ—¥æœŸçš„ç²¾ç¢ºåŒ¯ç‡ï¼ˆèˆ‡èˆŠç³»çµ±è¡Œç‚ºä¸€è‡´ï¼‰
                    let rate = await window.apiService.getExchangeRate(dateStr);
                    
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°è©²æ—¥æœŸçš„åŒ¯ç‡ï¼Œè¿”å› nullï¼ˆè®“ convertToTWD ä½¿ç”¨ç•¶å‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨ï¼‰
                    // é€™æ¨£å¯ä»¥ç¢ºä¿èˆ‡èˆŠç³»çµ±è¡Œç‚ºä¸€è‡´
                    if (!rate) {
                        console.log(`âš ï¸ æ²’æœ‰æ‰¾åˆ° ${dateStr} çš„ç²¾ç¢ºåŒ¯ç‡ï¼Œå°‡ä½¿ç”¨ç•¶å‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨`);
                        return null;
                    }
                    
                        let rateValue = null;
                        switch (currency.toUpperCase()) {
                            case 'USD': rateValue = rate.usdRate ? parseFloat(rate.usdRate) : null; break;
                            case 'EUR': rateValue = rate.eurRate ? parseFloat(rate.eurRate) : null; break;
                            case 'JPY': rateValue = rate.jpyRate ? parseFloat(rate.jpyRate) : null; break;
                            case 'CNY': rateValue = rate.cnyRate ? parseFloat(rate.cnyRate) : null; break;
                        }
                        
                        if (rateValue) {
                        console.log(`ğŸ’° ${currency} åŒ¯ç‡:`, rateValue, rate.date ? `(æ—¥æœŸ: ${rate.date})` : '');
                            return rateValue;
                        } else {
                            console.log(`âŒ æ²’æœ‰æ‰¾åˆ° ${currency} åŒ¯ç‡`);
                        return null;
                    }
                } catch (error) {
                    console.error('âŒ ç²å–æ­·å²åŒ¯ç‡å¤±æ•—:', error);
                    return null;
                }
            }
            
            // æ ¼å¼åŒ–æ—¥æœŸç‚º Firebase æ–‡æª” ID
            formatDateForFirebase(date) {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            }
            
            // ä¿å­˜æ¯æ—¥åŒ¯ç‡
            async saveDailyExchangeRates(rates, date = new Date()) {
                try {
                    const dateStr = this.formatDateForFirebase(date);
                    
                    // ç¢ºä¿æ•¸å­—é¡å‹æ­£ç¢ºè½‰æ›ï¼ˆé¿å… 0 è¢«è½‰ç‚º nullï¼‰
                    const exchangeRate = {
                        date: dateStr,
                        usdRate: rates.USD != null ? parseFloat(rates.USD) : null,
                        eurRate: rates.EUR != null ? parseFloat(rates.EUR) : null,
                        jpyRate: rates.JPY != null ? parseFloat(rates.JPY) : null,
                        cnyRate: rates.CNY != null ? parseFloat(rates.CNY) : null
                    };
                    
                    console.log(`ğŸ“¤ æº–å‚™ä¿å­˜ ${dateStr} çš„åŒ¯ç‡:`, exchangeRate);
                    await window.apiService.saveExchangeRate(exchangeRate);
                    console.log(`âœ… å·²ä¿å­˜ ${dateStr} çš„åŒ¯ç‡:`, rates);
                } catch (error) {
                    console.error('âŒ ä¿å­˜æ¯æ—¥åŒ¯ç‡å¤±æ•—:', error);
                    throw error;
                }
            }
            
            // å¾ API å–å¾—åŒ¯ç‡
            async fetchExchangeRateFromAPI(currency) {
                try {
                    // ä½¿ç”¨å…è²»çš„åŒ¯ç‡ API (ExchangeRate-API)
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // è¨ˆç®—å°å°å¹£çš„åŒ¯ç‡ (API å›å‚³çš„æ˜¯ 1 TWD = ? å…¶ä»–å¹£åˆ¥)
                    // æˆ‘å€‘éœ€è¦çš„æ˜¯ 1 å…¶ä»–å¹£åˆ¥ = ? TWD
                    const rate = 1 / data.rates[currency];
                    
                    if (!rate || rate <= 0) {
                        throw new Error(`ç„¡æ³•å–å¾— ${currency} åŒ¯ç‡`);
                    }
                    
                    return parseFloat(rate.toFixed(4));
                    
                } catch (error) {
                    console.error('API å–å¾—åŒ¯ç‡å¤±æ•—:', error);
                    
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
                    const mockRates = {
                        'USD': 30.5,
                        'EUR': 32.8,
                        'JPY': 0.21,
                        'CNY': 4.3
                    };
                    
                    if (mockRates[currency]) {
                        console.log(`ä½¿ç”¨æ¨¡æ“¬åŒ¯ç‡: ${currency} = ${mockRates[currency]}`);
                        return mockRates[currency];
                    }
                    
                    throw error;
                }
            }
            
            // æ‰‹å‹•æ›´æ–°åŒ¯ç‡æŒ‰éˆ•
            async fetchCurrentExchangeRate() {
                const currency = document.getElementById('currency').value;
                const exchangeRateInput = document.getElementById('exchangeRate');
                const refreshBtn = document.getElementById('refreshRateBtn');
                
                if (currency === 'TWD') {
                    this.showNotification('å°å¹£ä¸éœ€è¦åŒ¯ç‡è½‰æ›', 'info');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
                exchangeRateInput.placeholder = 'æ­£åœ¨æ›´æ–°åŒ¯ç‡...';
                
                try {
                    const rate = await this.fetchExchangeRateFromAPI(currency);
                    exchangeRateInput.value = rate.toFixed(4);
                    exchangeRateInput.placeholder = 'åŒ¯ç‡å·²æ›´æ–°';
                    
                    // æ›´æ–°æœ¬åœ°åŒ¯ç‡å¿«å–
                    this.exchangeRates[currency] = rate;
                    
                    console.log(`å·²æ›´æ–° ${currency} åŒ¯ç‡: ${rate}`);
                    this.showNotification(`${currency} åŒ¯ç‡å·²æ›´æ–°ç‚º ${rate}`, 'success');
                    
                } catch (error) {
                    console.error('æ›´æ–°åŒ¯ç‡å¤±æ•—:', error);
                    exchangeRateInput.value = this.exchangeRates[currency] || 1;
                    exchangeRateInput.placeholder = 'ä½¿ç”¨å¿«å–åŒ¯ç‡';
                    this.showNotification(`ç„¡æ³•å–å¾— ${currency} æœ€æ–°åŒ¯ç‡ï¼Œå·²ä½¿ç”¨å¿«å–æ•¸æ“š`, 'warning');
                } finally {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'ğŸ”„ æ›´æ–°åŒ¯ç‡';
                }
            }
            
            showExchangeRates() {
                console.log('é¡¯ç¤ºåŒ¯ç‡ç®¡ç†');
                const modal = document.getElementById('exchangeRateModal');
                if (modal) {
                    this.loadExchangeRates();
                    modal.style.display = 'block';
                    
                    // è¨­å®šåŒ¯ç‡æ—¥æœŸç‚ºä»Šå¤©ï¼ˆä½¿ç”¨æœ¬åœ°æ™‚é–“ï¼‰
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    console.log('ğŸ“… ä»Šå¤©æ—¥æœŸï¼ˆæœ¬åœ°æ™‚é–“ï¼‰:', todayStr);
                    
                    const rateDateInput = document.getElementById('rateDate');
                    if (rateDateInput) {
                        rateDateInput.value = todayStr;
                        console.log('âœ… åŒ¯ç‡æ—¥æœŸå·²è¨­å®šç‚º:', rateDateInput.value);
                    }
                    
                    // è¨­å®šæ­·å²æŸ¥è©¢æ—¥æœŸç‚ºå‰ä¸€å¤©ï¼ˆä½¿ç”¨æœ¬åœ°æ™‚é–“ï¼‰
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
                    console.log('ğŸ“… æ˜¨å¤©æ—¥æœŸï¼ˆæœ¬åœ°æ™‚é–“ï¼‰:', yesterdayStr);
                    
                    const historyDateInput = document.getElementById('historyDate');
                    if (historyDateInput) {
                        historyDateInput.value = yesterdayStr;
                        console.log('âœ… æŸ¥è©¢æ—¥æœŸå·²è¨­å®šç‚º:', historyDateInput.value);
                    }
                    
                    // è‡ªå‹•è¼‰å…¥åŒ¯ç‡æ—¥æœŸçš„è³‡æ–™åˆ°ç·¨è¼¯è¡¨å–®
                    setTimeout(() => {
                        this.loadRatesForDate();
                    }, 100); // ç¨å¾®å»¶é²ç¢ºä¿ DOM å…ƒç´ å·²æº–å‚™å¥½
                }
            }
            
            hideExchangeRates() {
                console.log('éš±è—åŒ¯ç‡ç®¡ç†');
                const modal = document.getElementById('exchangeRateModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // è¼‰å…¥æŒ‡å®šæ—¥æœŸçš„åŒ¯ç‡
            async loadRatesForDate() {
                const dateInput = document.getElementById('rateDate');
                const loadButton = document.querySelector('button[onclick="expenseTracker.loadRatesForDate()"]');
                
                if (!dateInput.value) {
                    this.showNotification('è«‹é¸æ“‡åŒ¯ç‡æ—¥æœŸ', 'warning');
                    return;
                }
                
                // é¡¯ç¤º loading ç‹€æ…‹
                if (loadButton) {
                    loadButton.disabled = true;
                    loadButton.textContent = 'ğŸ”„ è¼‰å…¥ä¸­...';
                }
                
                // é¡¯ç¤º loading åœ¨è¼¸å…¥æ¡†
                const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                currencies.forEach(currency => {
                    const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                    if (element) {
                        element.value = '';
                        element.placeholder = 'è¼‰å…¥ä¸­...';
                        element.disabled = true;
                    }
                });
                
                try {
                    const selectedDate = new Date(dateInput.value);
                    console.log(`ğŸ” è¼‰å…¥ ${dateInput.value} çš„åŒ¯ç‡åˆ°ç·¨è¼¯è¡¨å–®`);
                    
                    // è¼‰å…¥æ¯å€‹å¹£åˆ¥çš„åŒ¯ç‡
                    for (const currency of currencies) {
                        const rate = await this.getExchangeRateForDate(currency, selectedDate);
                        const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (element) {
                            if (rate !== null) {
                                element.value = rate.toFixed(4);
                                element.placeholder = `${currency} åŒ¯ç‡`;
                            } else {
                                element.value = '';
                                element.placeholder = 'æœªæ‰¾åˆ°è©²æ—¥æœŸçš„åŒ¯ç‡';
                            }
                            element.disabled = false;
                        }
                    }
                    
                    this.showNotification(`å·²è¼‰å…¥ ${dateInput.value} çš„åŒ¯ç‡`, 'success');
                    
                } catch (error) {
                    console.error('è¼‰å…¥åŒ¯ç‡å¤±æ•—:', error);
                    this.showNotification('è¼‰å…¥åŒ¯ç‡å¤±æ•—', 'error');
                    
                    // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
                    currencies.forEach(currency => {
                        const element = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (element) {
                            element.value = '';
                            element.placeholder = 'è¼‰å…¥å¤±æ•—';
                            element.disabled = false;
                        }
                    });
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    if (loadButton) {
                        loadButton.disabled = false;
                        loadButton.textContent = 'ğŸ“… è¼‰å…¥è©²æ—¥æœŸåŒ¯ç‡';
                    }
                }
            }
            
            // å¾APIè¼‰å…¥åŒ¯ç‡
            async loadExchangeRatesFromFirebase() {
                try {
                    console.log('å¾APIè¼‰å…¥åŒ¯ç‡...');
                    // å–å¾—ä»Šå¤©çš„åŒ¯ç‡
                    const today = new Date().toISOString().split('T')[0];
                    try {
                        const rate = await window.apiService.getLatestExchangeRate(today);
                        if (rate) {
                                this.exchangeRates = {
                                'USD': rate.usdRate ? parseFloat(rate.usdRate) : 30.0,
                                'EUR': rate.eurRate ? parseFloat(rate.eurRate) : 32.0,
                                'JPY': rate.jpyRate ? parseFloat(rate.jpyRate) : 0.2,
                                    'CNY': rate.cnyRate ? parseFloat(rate.cnyRate) : 4.2
                            };
                            console.log('å¾APIè¼‰å…¥åŒ¯ç‡æˆåŠŸ:', this.exchangeRates);
                        }
                    } catch (rateError) {
                        console.log('APIä¸­æ²’æœ‰åŒ¯ç‡è³‡æ–™ï¼Œä½¿ç”¨é è¨­å€¼');
                    }
                    
                    // è¼‰å…¥äº¤æ˜“è²»ç”¨é…ç½®
                    await this.loadTradingFeesConfig();
                    
                } catch (error) {
                    console.error('å¾APIè¼‰å…¥åŒ¯ç‡å¤±æ•—:', error);
                }
            }
            
            // è¼‰å…¥äº¤æ˜“è²»ç”¨é…ç½®ï¼ˆå¾æœ¬åœ°å„²å­˜ï¼‰
            async loadTradingFeesConfig() {
                try {
                    console.log('è¼‰å…¥äº¤æ˜“è²»ç”¨é…ç½®...');
                    // å¾ localStorage è¼‰å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
                    const savedConfig = localStorage.getItem('tradingFees');
                    if (savedConfig) {
                        this.tradingFees = JSON.parse(savedConfig);
                        console.log('å¾æœ¬åœ°å„²å­˜è¼‰å…¥äº¤æ˜“è²»ç”¨é…ç½®æˆåŠŸ:', this.tradingFees);
                    } else {
                        console.log('ä½¿ç”¨é è¨­äº¤æ˜“è²»ç”¨é…ç½®');
                        // å„²å­˜é è¨­é…ç½®åˆ°æœ¬åœ°
                        this.saveTradingFeesConfig();
                    }
                } catch (error) {
                    console.error('è¼‰å…¥äº¤æ˜“è²»ç”¨é…ç½®å¤±æ•—:', error);
                }
            }
            
            // å„²å­˜äº¤æ˜“è²»ç”¨é…ç½®ï¼ˆåˆ°æœ¬åœ°å„²å­˜ï¼‰
            async saveTradingFeesConfig() {
                try {
                    localStorage.setItem('tradingFees', JSON.stringify(this.tradingFees));
                    console.log('äº¤æ˜“è²»ç”¨é…ç½®å·²å„²å­˜åˆ°æœ¬åœ°');
                } catch (error) {
                    console.error('å„²å­˜äº¤æ˜“è²»ç”¨é…ç½®å¤±æ•—:', error);
                }
            }
            
            // è¨ˆç®—è‚¡ç¥¨å¯¦éš›æˆäº¤é‡‘é¡ï¼ˆæ‰£é™¤æ‰‹çºŒè²»å’Œäº¤æ˜“ç¨…ï¼‰
            calculateActualAmount(shares, currentPrice, currency, stockCode = '') {
                const marketValue = shares * currentPrice;
                const commission = marketValue * this.tradingFees.commission;
                
                // åˆ¤æ–·äº¤æ˜“ç¨…ç‡
                let taxRate = 0;
                
                // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼åˆ¤æ–·å°è‚¡é¡å‹
                if (currency === 'TWD') {
                    if (this.isTaiwanETF(stockCode)) {
                        taxRate = this.tradingFees.tax.ETF;  // ETFç¨…ç‡
                    } else {
                        taxRate = this.tradingFees.tax.TWD;  // å°è‚¡ç¨…ç‡
                    }
                } else if (currency === 'USD') {
                    taxRate = this.tradingFees.tax.USD;
                } else {
                    // å°æ–¼å…¶ä»–å¹£åˆ¥ï¼Œé è¨­ä½¿ç”¨ ETF ç¨…ç‡
                    taxRate = this.tradingFees.tax.ETF;
                }
                
                const tax = marketValue * taxRate;
                const actualAmount = marketValue - commission - tax;
                
                return {
                    marketValue: marketValue,
                    commission: commission,
                    tax: tax,
                    actualAmount: actualAmount,
                    commissionRate: this.tradingFees.commission,
                    taxRate: taxRate
                };
            }
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå°è‚¡ETF
            isTaiwanETF(stockCode) {
                if (!stockCode) return false;
                
                // å°è‚¡ETFé‚è¼¯ï¼š00xx é–‹é ­ æˆ– 00xxx é–‹é ­
                return stockCode.startsWith('00');
            }
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå°è‚¡
            isTaiwanStock(stockCode) {
                if (!stockCode) return false;
                
                // å°è‚¡é‚è¼¯ï¼š1101ï½8999
                const code = parseInt(stockCode);
                return code >= 1101 && code <= 8999;
            }
            
            // æ›´æ–°äº¤æ˜“è²»ç”¨é…ç½®
            async updateTradingFeesConfig(newConfig) {
                try {
                    this.tradingFees = {
                        commission: newConfig.commission || this.tradingFees.commission,
                        tax: {
                            'TWD': newConfig.tax?.TWD || this.tradingFees.tax.TWD,
                            'USD': newConfig.tax?.USD || this.tradingFees.tax.USD,
                            'ETF': newConfig.tax?.ETF || this.tradingFees.tax.ETF
                        }
                    };
                    
                    await this.saveTradingFeesConfig();
                    this.showNotification('äº¤æ˜“è²»ç”¨é…ç½®å·²æ›´æ–°', 'success');
                    
                    // é‡æ–°è¨ˆç®—è³‡ç”¢çµ„åˆ
                    this.updatePortfolioSummary();
                } catch (error) {
                    console.error('æ›´æ–°äº¤æ˜“è²»ç”¨é…ç½®å¤±æ•—:', error);
                    this.showNotification('æ›´æ–°äº¤æ˜“è²»ç”¨é…ç½®å¤±æ•—', 'error');
                }
            }
            
            // é¡¯ç¤ºäº¤æ˜“è²»ç”¨é…ç½®
            showTradingFeesConfig() {
                console.log('é¡¯ç¤ºäº¤æ˜“è²»ç”¨é…ç½®');
                const modal = document.getElementById('tradingFeesConfigModal');
                if (modal) {
                    // è¼‰å…¥ç•¶å‰é…ç½®åˆ°è¡¨å–®ï¼ˆç›´æ¥ä½¿ç”¨å°æ•¸å€¼ï¼‰
                    document.getElementById('commissionRate').value = this.tradingFees.commission;
                    document.getElementById('taxRateTWD').value = this.tradingFees.tax.TWD;
                    document.getElementById('taxRateUSD').value = this.tradingFees.tax.USD;
                    document.getElementById('taxRateETF').value = this.tradingFees.tax.ETF;
                    
                    modal.style.display = 'block';
                }
            }
            
            // éš±è—äº¤æ˜“è²»ç”¨é…ç½®
            hideTradingFeesConfig() {
                console.log('éš±è—äº¤æ˜“è²»ç”¨é…ç½®');
                const modal = document.getElementById('tradingFeesConfigModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // å¾è¡¨å–®å„²å­˜äº¤æ˜“è²»ç”¨é…ç½®
            async saveTradingFeesConfigFromForm() {
                try {
                    const commissionRate = parseFloat(document.getElementById('commissionRate').value);
                    const taxRateTWD = parseFloat(document.getElementById('taxRateTWD').value);
                    const taxRateUSD = parseFloat(document.getElementById('taxRateUSD').value);
                    const taxRateETF = parseFloat(document.getElementById('taxRateETF').value);
                    
                    const newConfig = {
                        commission: commissionRate,
                        tax: {
                            TWD: taxRateTWD,
                            USD: taxRateUSD,
                            ETF: taxRateETF
                        }
                    };
                    
                    await this.updateTradingFeesConfig(newConfig);
                    this.hideTradingFeesConfig();
                } catch (error) {
                    console.error('å„²å­˜äº¤æ˜“è²»ç”¨é…ç½®å¤±æ•—:', error);
                    this.showNotification('å„²å­˜é…ç½®å¤±æ•—', 'error');
                }
            }
            // é¡¯ç¤ºæç›Šè©³ç´°è³‡æ–™
            async showProfitLossDetails(assetId) {
                console.log('ğŸ”„ showProfitLossDetails è¢«èª¿ç”¨ï¼ŒassetId:', assetId, 'é¡å‹:', typeof assetId);
                
                // å°‡ assetId è½‰æ›ç‚ºèˆ‡è³‡ç”¢ ID ç›¸åŒçš„é¡å‹é€²è¡Œæ¯”è¼ƒ
                const assetIdNum = typeof assetId === 'string' ? parseInt(assetId) : assetId;
                const asset = this.assets.find(a => {
                    // æ”¯æ´æ•¸å­—å’Œå­—ç¬¦ä¸²é¡å‹çš„ ID æ¯”è¼ƒ
                    return a.id === assetId || a.id === assetIdNum || String(a.id) === String(assetId);
                    });
                    
                if (!asset) {
                    console.error('âŒ æ‰¾ä¸åˆ°è³‡ç”¢ï¼ŒassetId:', assetId, 'assetIdé¡å‹:', typeof assetId);
                    console.error('æ‰€æœ‰å¯ç”¨è³‡ç”¢ID:', this.assets.map(a => ({ id: a.id, idType: typeof a.id, name: a.name })));
                    this.showNotification(`æ‰¾ä¸åˆ°å°æ‡‰çš„è³‡ç”¢ (ID: ${assetId})`, 'error');
                    return;
                }
                
                console.log('âœ… æ‰¾åˆ°è³‡ç”¢:', { id: asset.id, name: asset.name, stockCode: asset.stockCode });
                
                const quantity = parseFloat(asset.quantity) || 0;
                const purchasePrice = parseFloat(asset.purchasePrice) || parseFloat(asset.unitPrice) || 0;
                const currentPrice = parseFloat(asset.currentPrice) || purchasePrice;
                
                // è¨ˆç®—è©³ç´°è³‡æ–™
                const costBasis = quantity * purchasePrice;
                const currentValue = quantity * currentPrice;
                
                let actualAmount = null;
                let feeDetails = '';
                
                if (asset.type === 'è‚¡ç¥¨') {
                    actualAmount = this.calculateActualAmount(quantity, currentPrice, asset.currency, asset.stockCode);
                    
                    // è½‰æ›ç‚ºå°å¹£
                    const marketValueTWD = await this.convertToTWD(actualAmount.marketValue, asset.currency);
                    const commissionTWD = await this.convertToTWD(actualAmount.commission, asset.currency);
                    const taxTWD = await this.convertToTWD(actualAmount.tax, asset.currency);
                    const actualAmountTWD = await this.convertToTWD(actualAmount.actualAmount, asset.currency);
                    const costBasisTWD = await this.convertToTWD(costBasis, asset.currency, 1, asset.purchaseDate ? new Date(asset.purchaseDate) : null);
                    
                    const profitLossTWD = actualAmountTWD - costBasisTWD;
                    const profitLossPercent = costBasisTWD > 0 ? (profitLossTWD / costBasisTWD) * 100 : 0;
                    
                    feeDetails = `
                        <div class="profit-loss-details">
                            <h3>ğŸ“Š ${asset.name} (${asset.stockCode}) æç›Šè©³ç´°</h3>
                            
                            <div class="detail-section">
                                <h4>ğŸ’° æˆæœ¬è³‡è¨Š</h4>
                                <div class="detail-row">
                                    <span class="label">è³¼è²·æˆæœ¬:</span>
                                    <span class="value">NT$ ${this.formatNumber(costBasisTWD)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">è‚¡æ•¸:</span>
                                    <span class="value">${this.formatNumber(quantity)} è‚¡</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">è³¼è²·å–®åƒ¹:</span>
                                    <span class="value">${asset.currency} ${purchasePrice.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“ˆ å¸‚å ´åƒ¹å€¼</h4>
                                <div class="detail-row">
                                    <span class="label">ç•¶å‰è‚¡åƒ¹:</span>
                                    <span class="value">${asset.currency} ${currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">å¸‚å ´å¸‚å€¼:</span>
                                    <span class="value">NT$ ${this.formatNumber(marketValueTWD)}</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ’¸ äº¤æ˜“è²»ç”¨</h4>
                                <div class="detail-row">
                                    <span class="label">æ‰‹çºŒè²»:</span>
                                    <span class="value">NT$ ${this.formatNumber(commissionTWD)} (${(actualAmount.commissionRate * 100).toFixed(4)}%)</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">äº¤æ˜“ç¨…:</span>
                                    <span class="value">NT$ ${this.formatNumber(taxTWD)} (${(actualAmount.taxRate * 100).toFixed(3)}%)</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ç¸½è²»ç”¨:</span>
                                    <span class="value">NT$ ${this.formatNumber(commissionTWD + taxTWD)}</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“Š å¯¦éš›æç›Š</h4>
                                <div class="detail-row">
                                    <span class="label">æ‰£è²»å¾Œæ·¨æ”¶å…¥:</span>
                                    <span class="value">NT$ ${this.formatNumber(actualAmountTWD)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">æç›Šé‡‘é¡:</span>
                                    <span class="value ${profitLossTWD >= 0 ? 'profit' : 'loss'}">${profitLossTWD >= 0 ? '+' : ''}NT$ ${this.formatNumber(Math.abs(profitLossTWD))}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">æç›Šç™¾åˆ†æ¯”:</span>
                                    <span class="value ${profitLossTWD >= 0 ? 'profit' : 'loss'}">${profitLossTWD >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // éè‚¡ç¥¨è³‡ç”¢ï¼Œé¡¯ç¤ºç°¡å–®çš„æç›Šè³‡è¨Š
                    const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : null;
                    const costBasisTWD = await this.convertToTWD(costBasis, asset.currency, 1, purchaseDate);
                    const currentValueTWD = await this.convertToTWD(currentValue, asset.currency);
                    const profitLossTWD = currentValueTWD - costBasisTWD;
                    const profitLossPercent = costBasisTWD > 0 ? (profitLossTWD / costBasisTWD) * 100 : 0;
                    
                    feeDetails = `
                        <div class="profit-loss-details">
                            <h3>ğŸ“Š ${asset.name} æç›Šè©³ç´°</h3>
                            
                            <div class="detail-section">
                                <h4>ğŸ’° æˆæœ¬è³‡è¨Š</h4>
                                <div class="detail-row">
                                    <span class="label">è³¼è²·æˆæœ¬:</span>
                                    <span class="value">NT$ ${this.formatNumber(costBasisTWD)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">æ•¸é‡:</span>
                                    <span class="value">${this.formatNumber(quantity)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">è³¼è²·å–®åƒ¹:</span>
                                    <span class="value">${asset.currency} ${purchasePrice.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“ˆ ç•¶å‰åƒ¹å€¼</h4>
                                <div class="detail-row">
                                    <span class="label">ç•¶å‰åƒ¹æ ¼:</span>
                                    <span class="value">${asset.currency} ${currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">ç•¶å‰åƒ¹å€¼:</span>
                                    <span class="value">NT$ ${this.formatNumber(currentValueTWD)}</span>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>ğŸ“Š æç›Š</h4>
                                <div class="detail-row">
                                    <span class="label">æç›Šé‡‘é¡:</span>
                                    <span class="value ${profitLossTWD >= 0 ? 'profit' : 'loss'}">${profitLossTWD >= 0 ? '+' : ''}NT$ ${this.formatNumber(Math.abs(profitLossTWD))}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">æç›Šç™¾åˆ†æ¯”:</span>
                                    <span class="value ${profitLossTWD >= 0 ? 'profit' : 'loss'}">${profitLossTWD >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // é¡¯ç¤ºæ¨¡æ…‹æ¡†
                const modal = document.getElementById('profitLossDetailsModal');
                if (modal) {
                    if (!feeDetails || feeDetails.trim() === '') {
                        console.error('âŒ æç›Šè©³ç´°è³‡æ–™ç‚ºç©º');
                        this.showNotification('ç„¡æ³•ç”Ÿæˆæç›Šè©³ç´°è³‡æ–™', 'error');
                        return;
                    }
                    document.getElementById('profitLossDetailsContent').innerHTML = feeDetails;
                    modal.style.display = 'block';
                    console.log('âœ… æç›Šè©³ç´°è³‡æ–™æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°æç›Šè©³ç´°è³‡æ–™æ¨¡æ…‹æ¡†å…ƒç´ ');
                    this.showNotification('æ‰¾ä¸åˆ°æç›Šè©³ç´°è³‡æ–™è¦–çª—', 'error');
                }
            }
            
            // éš±è—æç›Šè©³ç´°è³‡æ–™
            hideProfitLossDetails() {
                const modal = document.getElementById('profitLossDetailsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // æª¢æŸ¥ä¸¦è‡ªå‹•è£œè¶³ç•¶æ—¥åŒ¯ç‡
            async checkAndAutoFillTodayRates() {
                // é˜²æ­¢é‡è¤‡åŸ·è¡Œ
                if (this.isExchangeRateChecked) {
                    console.log('â­ï¸ åŒ¯ç‡æª¢æŸ¥å·²åŸ·è¡Œéï¼Œè·³éé‡è¤‡åŸ·è¡Œ');
                    return;
                }
                
                this.isExchangeRateChecked = true;
                
                try {
                    console.log('ğŸ” æª¢æŸ¥æ˜¯å¦éœ€è¦è£œè¶³ç•¶æ—¥åŒ¯ç‡...');
                    
                    // æª¢æŸ¥æœ€è¿‘å¹¾å¤©æ˜¯å¦æœ‰åŒ¯ç‡è³‡æ–™
                    const missingDates = await this.checkMissingDates();
                    
                    if (missingDates.length > 0) {
                        console.log(`âš ï¸ ç™¼ç¾ ${missingDates.length} å€‹æ—¥æœŸç¼ºå°‘åŒ¯ç‡è³‡æ–™:`, missingDates);
                        
                        // é¡¯ç¤ºé€²åº¦é€šçŸ¥
                        this.showExchangeRateProgress(0, missingDates.length);
                        
                        // è‡ªå‹•è£œè¶³æ‰€æœ‰ç¼ºå°‘çš„æ—¥æœŸ
                        await this.fillMissingDatesWithProgress(missingDates);
                        
                        console.log(`âœ… æ‰€æœ‰æ—¥æœŸåŒ¯ç‡è£œè¶³å®Œæˆ`);
                        this.showExchangeRateProgress(missingDates.length, missingDates.length, true);
                    } else {
                        console.log('âœ… æ‰€æœ‰æ—¥æœŸåŒ¯ç‡è³‡æ–™å·²å­˜åœ¨ï¼Œç„¡éœ€è£œè¶³');
                        // é¡¯ç¤ºç„¡éœ€æ›´æ–°çš„ç‹€æ…‹
                        this.showExchangeRateProgress(0, 0, true);
                    }
                    
                } catch (error) {
                    console.error('âŒ æª¢æŸ¥ç•¶æ—¥åŒ¯ç‡å¤±æ•—:', error);
                    // ä¸é¡¯ç¤ºéŒ¯èª¤é€šçŸ¥ï¼Œé¿å…å¹²æ“¾ç”¨æˆ¶é«”é©—
                }
            }
            
            // æª¢æŸ¥ç•¶æ—¥åŒ¯ç‡æ˜¯å¦å­˜åœ¨
            async checkTodayRatesExist(dateStr) {
                try {
                    if (!window.apiService || typeof window.apiService.getExchangeRate !== 'function') {
                        console.error('getExchangeRate æ–¹æ³•ä¸å­˜åœ¨');
                        return false;
                    }
                    const rate = await window.apiService.getExchangeRate(dateStr);
                    
                    if (rate) {
                        const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                        
                        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¹£åˆ¥éƒ½æœ‰åŒ¯ç‡
                        for (const currency of currencies) {
                            let hasRate = false;
                            switch (currency) {
                                case 'USD': hasRate = !!rate.usdRate; break;
                                case 'EUR': hasRate = !!rate.eurRate; break;
                                case 'JPY': hasRate = !!rate.jpyRate; break;
                                case 'CNY': hasRate = !!rate.cnyRate; break;
                            }
                            if (!hasRate) {
                                console.log(`âŒ ${currency} åŒ¯ç‡ç¼ºå¤±`);
                                return false;
                            }
                        }
                        
                        console.log('âœ… ç•¶æ—¥æ‰€æœ‰åŒ¯ç‡éƒ½å­˜åœ¨');
                        return true;
                    } else {
                        console.log('âŒ ç•¶æ—¥åŒ¯ç‡ä¸å­˜åœ¨');
                        return false;
                    }
                } catch (error) {
                    console.error('æª¢æŸ¥ç•¶æ—¥åŒ¯ç‡å­˜åœ¨æ€§å¤±æ•—:', error);
                    return false;
                }
            }

            // æª¢æŸ¥æœ€è¿‘å¹¾å¤©ç¼ºå°‘åŒ¯ç‡çš„æ—¥æœŸ
            async checkMissingDates() {
                const missingDates = [];
                const today = new Date();
                
                console.log(`ğŸ“… ä»Šå¤©æ—¥æœŸ: ${today.toISOString()}`);
                console.log(`ğŸ“… ä»Šå¤©æ ¼å¼åŒ–: ${this.formatDateForFirebase(today)}`);
                
                // æª¢æŸ¥æœ€è¿‘ 7 å¤©ï¼ˆåªæª¢æŸ¥éå»æ—¥æœŸï¼Œä¸æª¢æŸ¥æœªä¾†æ—¥æœŸï¼‰
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() - i);
                    const dateStr = this.formatDateForFirebase(checkDate);
                    
                    console.log(`ğŸ” æª¢æŸ¥æ—¥æœŸ ${i}: ${dateStr}`);
                    
                    const hasRates = await this.checkTodayRatesExist(dateStr);
                    console.log(`ğŸ“Š ${dateStr} åŒ¯ç‡ç‹€æ…‹: ${hasRates ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`);
                    
                    if (!hasRates) {
                        missingDates.push(dateStr);
                    }
                }
                
                console.log(`ğŸ“‹ ç¼ºå°‘åŒ¯ç‡çš„æ—¥æœŸ:`, missingDates);
                return missingDates;
            }
            
            // é¡¯ç¤ºåŒ¯ç‡è£œè¶³é€²åº¦
            showExchangeRateProgress(current, total, completed = false) {
                const progressText = completed ? 'âœ…' : `${current}/${total}`;
                console.log(`ğŸ“Š åŒ¯ç‡è£œè¶³é€²åº¦: ${progressText}`);
                
                // æ›´æ–°åŒ¯ç‡ç®¡ç†æŒ‰éˆ•çš„æ–‡å­—
                const exchangeRateBtn = document.querySelector('button[onclick="expenseTracker.showExchangeRates()"]');
                if (exchangeRateBtn) {
                    const originalText = exchangeRateBtn.textContent.replace(/\s*\(\d+\/\d+\)|\s*\(âœ…\)/, '');
                    exchangeRateBtn.textContent = `${originalText} (${progressText})`;
                }
                
                // ä½¿ç”¨ç¾æœ‰çš„é€šçŸ¥ç³»çµ±
                if (completed) {
                    // é‡ç½®é€šçŸ¥æ¨™è¨˜
                    this.hasShownStartNotification = false;
                    
                    if (total === 0) {
                        this.showNotification(`âœ… åŒ¯ç‡å·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€æ›´æ–°`, 'success');
                    } else {
                        this.showNotification(`âœ… åŒæ­¥ ${total} ç­†åŒ¯ç‡å®Œæˆ`, 'success');
                    }
                } else if (total > 0 && current === 0) {
                    // é˜²æ­¢é‡è¤‡é€šçŸ¥ï¼šæª¢æŸ¥æ˜¯å¦å·²ç¶“é¡¯ç¤ºéé–‹å§‹é€šçŸ¥
                    if (!this.hasShownStartNotification) {
                        this.showNotification(`ğŸ”„ åŒ¯ç‡æœ‰ ${total} ç­†è³‡æ–™éœ€è¦åŒæ­¥`, 'info');
                        this.hasShownStartNotification = true;
                    }
                }
            }
            
            // å¸¶é€²åº¦é¡¯ç¤ºçš„æ—¥æœŸè£œè¶³
            async fillMissingDatesWithProgress(missingDates) {
                for (let i = 0; i < missingDates.length; i++) {
                    const dateStr = missingDates[i];
                    console.log(`ğŸ”„ æ­£åœ¨è£œè¶³ç¬¬ ${i + 1} ç­†æ—¥æœŸ: ${dateStr}`);
                    
                    // æ›´æ–°é€²åº¦é¡¯ç¤º
                    this.showExchangeRateProgress(i, missingDates.length);
                    
                    // è£œè¶³è©²æ—¥æœŸçš„æ‰€æœ‰åŒ¯ç‡
                    await this.fillDateRates(dateStr);
                    
                    console.log(`âœ… ç¬¬ ${i + 1} ç­†æ—¥æœŸè£œè¶³å®Œæˆ: ${dateStr}`);
                }
            }
            
            // è£œè¶³æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰åŒ¯ç‡
            async fillDateRates(dateStr) {
                const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                const date = new Date(dateStr);
                const ratesData = {};
                
                console.log(`ğŸ”„ é–‹å§‹è£œè¶³ ${dateStr} çš„åŒ¯ç‡...`);
                
                // å…ˆç²å–æ‰€æœ‰å¹£åˆ¥çš„åŒ¯ç‡
                for (const currency of currencies) {
                    try {
                        // å˜—è©¦å¾å¤–éƒ¨ API ç²å–åŒ¯ç‡
                        const externalRate = await this.fetchExchangeRateFromAPI(currency);
                        
                        if (externalRate !== null) {
                            ratesData[currency] = externalRate;
                            console.log(`âœ… ${currency} åŒ¯ç‡ç²å–æˆåŠŸ: ${externalRate}`);
                        } else {
                            console.log(`âŒ ${currency} åŒ¯ç‡ç²å–å¤±æ•—`);
                            // ä½¿ç”¨ç¾æœ‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨
                            ratesData[currency] = this.exchangeRates[currency] || 1;
                        }
                    } catch (error) {
                        console.error(`âŒ ${currency} åŒ¯ç‡è™•ç†å¤±æ•—:`, error);
                        // ä½¿ç”¨ç¾æœ‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨
                        ratesData[currency] = this.exchangeRates[currency] || 1;
                    }
                }
                
                // ä¸€æ¬¡æ€§å„²å­˜æ‰€æœ‰åŒ¯ç‡åˆ° API
                try {
                    const exchangeRate = {
                        date: dateStr,
                        usdRate: ratesData.USD || null,
                        eurRate: ratesData.EUR || null,
                        jpyRate: ratesData.JPY || null,
                        cnyRate: ratesData.CNY || null
                    };
                    
                    if (!window.apiService || typeof window.apiService.saveExchangeRate !== 'function') {
                        throw new Error('saveExchangeRate æ–¹æ³•ä¸å­˜åœ¨');
                    }
                    await window.apiService.saveExchangeRate(exchangeRate);
                    console.log(`âœ… ${dateStr} æ‰€æœ‰åŒ¯ç‡å„²å­˜æˆåŠŸ:`, ratesData);
                } catch (error) {
                    console.error(`âŒ ${dateStr} åŒ¯ç‡å„²å­˜å¤±æ•—:`, error);
                }
            }

            // å„²å­˜æŒ‡å®šæ—¥æœŸçš„åŒ¯ç‡åˆ° API
            async saveExchangeRateForDate(currency, date, rate) {
                try {
                    const dateStr = this.formatDateForFirebase(date);
                    console.log(`ğŸ’¾ å„²å­˜ ${currency} åœ¨ ${dateStr} çš„åŒ¯ç‡: ${rate}`);
                    
                    // å…ˆå–å¾—è©²æ—¥æœŸçš„ç¾æœ‰åŒ¯ç‡
                    let exchangeRate = {
                        date: dateStr,
                        usdRate: null,
                        eurRate: null,
                        jpyRate: null,
                        cnyRate: null
                    };
                    
                    try {
                        const existing = await window.apiService.getExchangeRate(dateStr);
                        if (existing) {
                            exchangeRate = existing;
                        }
                    } catch (e) {
                        // å¦‚æœæ²’æœ‰ç¾æœ‰åŒ¯ç‡ï¼Œä½¿ç”¨æ–°çš„ç‰©ä»¶
                    }
                    
                    // æ›´æ–°å°æ‡‰å¹£åˆ¥çš„åŒ¯ç‡
                    switch (currency.toUpperCase()) {
                        case 'USD': exchangeRate.usdRate = rate; break;
                        case 'EUR': exchangeRate.eurRate = rate; break;
                        case 'JPY': exchangeRate.jpyRate = rate; break;
                        case 'CNY': exchangeRate.cnyRate = rate; break;
                    }
                    
                    // å„²å­˜åˆ° API
                    await window.apiService.saveExchangeRate(exchangeRate);
                    
                    console.log(`âœ… ${currency} åŒ¯ç‡å„²å­˜æˆåŠŸ`);
                    
                } catch (error) {
                    console.error(`âŒ å„²å­˜ ${currency} åŒ¯ç‡å¤±æ•—:`, error);
                    throw error;
                }
            }

            async loadExchangeRates() {
                console.log('è¼‰å…¥åŒ¯ç‡è³‡æ–™:', this.exchangeRates);
                
                try {
                    // å¾Firebaseè¼‰å…¥åŒ¯ç‡
                    await this.loadExchangeRatesFromFirebase();
                } catch (error) {
                    console.error('å¾Firebaseè¼‰å…¥åŒ¯ç‡å¤±æ•—:', error);
                }
                
                // è¼‰å…¥ç•¶å‰åŒ¯ç‡åˆ°è¡¨å–®
                const usdRateInput = document.getElementById('usdRate');
                const eurRateInput = document.getElementById('eurRate');
                const jpyRateInput = document.getElementById('jpyRate');
                const cnyRateInput = document.getElementById('cnyRate');
                
                if (usdRateInput) usdRateInput.value = this.exchangeRates.USD || 30.0;
                if (eurRateInput) eurRateInput.value = this.exchangeRates.EUR || 32.0;
                if (jpyRateInput) jpyRateInput.value = this.exchangeRates.JPY || 0.2;
                if (cnyRateInput) cnyRateInput.value = this.exchangeRates.CNY || 4.2;
                
                console.log('åŒ¯ç‡è¡¨å–®å·²æ›´æ–°');
            }
            
            updateExchangeRate(currency) {
                const rateInput = document.getElementById(`${currency.toLowerCase()}Rate`);
                const newRate = parseFloat(rateInput.value);
                
                if (isNaN(newRate) || newRate <= 0) {
                    this.showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡', 'error');
                    return;
                }
                
                this.exchangeRates[currency] = newRate;
                console.log(`æ›´æ–° ${currency} åŒ¯ç‡: ${newRate}`);
                this.showNotification(`${currency} åŒ¯ç‡å·²æ›´æ–°ç‚º ${newRate}`, 'success');
            }
            
            async fetchLatestRates(event) {
                let button = null;
                let originalText = 'ğŸ”„ è‡ªå‹•æ›´æ–°åŒ¯ç‡';
                
                try {
                    console.log('æ­£åœ¨ç²å–æœ€æ–°åŒ¯ç‡...');
                    
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    button = event ? event.target : document.querySelector('button[onclick*="fetchLatestRates"]');
                    originalText = button ? button.textContent : 'ğŸ”„ è‡ªå‹•æ›´æ–°åŒ¯ç‡';
                    if (button) {
                        button.disabled = true;
                        button.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
                    }
                    
                    // ç²å–æ‰€æœ‰å¹£åˆ¥çš„æœ€æ–°åŒ¯ç‡
                    const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                    const updatedRates = {};
                    
                    for (const currency of currencies) {
                        try {
                            const rate = await this.fetchExchangeRateFromAPI(currency);
                            updatedRates[currency] = rate;
                            console.log(`å·²ç²å– ${currency} åŒ¯ç‡: ${rate}`);
                        } catch (error) {
                            console.error(`ç²å– ${currency} åŒ¯ç‡å¤±æ•—:`, error);
                            // å¦‚æœAPIå¤±æ•—ï¼Œä¿æŒç¾æœ‰åŒ¯ç‡
                            updatedRates[currency] = this.exchangeRates[currency];
                        }
                    }
                    
                    // æ›´æ–°åŒ¯ç‡
                    Object.keys(updatedRates).forEach(currency => {
                        this.exchangeRates[currency] = updatedRates[currency];
                        const input = document.getElementById(`${currency.toLowerCase()}Rate`);
                        if (input) {
                            input.value = updatedRates[currency];
                        }
                    });
                    
                    // ä¿å­˜ä»Šæ—¥åŒ¯ç‡åˆ°æ¯æ—¥åŒ¯ç‡è¨˜éŒ„
                    await this.saveDailyExchangeRates(updatedRates, new Date());
                    
                    this.showNotification('åŒ¯ç‡å·²æ›´æ–°ç‚ºæœ€æ–°æ•¸æ“š', 'success');
                    
                } catch (error) {
                    console.error('ç²å–åŒ¯ç‡å¤±æ•—:', error);
                    this.showNotification('ç²å–åŒ¯ç‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
            }
            
            async saveExchangeRates() {
                const dateInput = document.getElementById('rateDate');
                if (!dateInput.value) {
                    this.showNotification('è«‹é¸æ“‡åŒ¯ç‡æ—¥æœŸ', 'warning');
                    return;
                }
                
                // å¾è¡¨å–®ä¸­è®€å–æœ€æ–°çš„åŒ¯ç‡å€¼
                const usdRate = parseFloat(document.getElementById('usdRate').value) || 30.0;
                const eurRate = parseFloat(document.getElementById('eurRate').value) || 32.0;
                const jpyRate = parseFloat(document.getElementById('jpyRate').value) || 0.2;
                const cnyRate = parseFloat(document.getElementById('cnyRate').value) || 4.2;
                
                // æ›´æ–°æœ¬åœ°åŒ¯ç‡è³‡æ–™
                const newRates = {
                    'USD': usdRate,
                    'EUR': eurRate,
                    'JPY': jpyRate,
                    'CNY': cnyRate
                };
                
                this.exchangeRates = newRates;
                
                console.log('æº–å‚™å„²å­˜åŒ¯ç‡:', this.exchangeRates);
                
                try {
                    // ä¿å­˜æŒ‡å®šæ—¥æœŸçš„åŒ¯ç‡åˆ° API
                    const selectedDate = new Date(dateInput.value);
                    await this.saveDailyExchangeRates(newRates, selectedDate);
                    
                    console.log('åŒ¯ç‡å·²å„²å­˜åˆ° API:', this.exchangeRates);
                    this.showNotification(`å·²å„²å­˜ ${dateInput.value} çš„åŒ¯ç‡`, 'success');
                    // å„²å­˜æˆåŠŸå¾Œé—œé–‰è¦–çª—
                    this.hideExchangeRates();
                } catch (error) {
                    console.error('å„²å­˜åŒ¯ç‡å¤±æ•—:', error);
                    this.showNotification('å„²å­˜åŒ¯ç‡å¤±æ•—', 'error');
                }
            }
            
            // è‡ªå‹•è£œè¶³ç¼ºå°‘çš„åŒ¯ç‡
            async autoFillMissingRates() {
                try {
                    // ç°¡åŒ–è™•ç†ï¼šå¾ä»Šå¤©å¾€å‰æ¨ 30 å¤©ï¼Œè£œè¶³ç¼ºå°‘çš„åŒ¯ç‡
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    
                    const currencies = ['USD', 'EUR', 'JPY', 'CNY'];
                    let successCount = 0;
                    let errorCount = 0;
                    
                    console.log(`ğŸš€ é–‹å§‹è£œè¶³ ${this.formatDateForFirebase(startDate)} åˆ° ${this.formatDateForFirebase(endDate)} çš„åŒ¯ç‡...`);
                    
                    const currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateStr = this.formatDateForFirebase(currentDate);
                        
                        try {
                            // å…ˆæª¢æŸ¥è©²æ—¥æœŸæ˜¯å¦å·²æœ‰åŒ¯ç‡
                            try {
                                const existingRate = await window.apiService.getExchangeRate(dateStr);
                                if (existingRate) {
                                    console.log(`â­ï¸ ${dateStr} åŒ¯ç‡å·²å­˜åœ¨ï¼Œè·³é`);
                                    currentDate.setDate(currentDate.getDate() + 1);
                                    continue;
                                }
                            } catch (e) {
                                // å¦‚æœæŸ¥è©¢å¤±æ•—ï¼ˆ404ï¼‰ï¼Œè¡¨ç¤ºæ²’æœ‰åŒ¯ç‡ï¼Œç¹¼çºŒè£œè¶³
                            }
                            
                            // ç²å–è©²æ—¥æœŸçš„åŒ¯ç‡
                            const rates = {};
                            for (const currency of currencies) {
                                try {
                                    const rate = await this.fetchExchangeRateFromAPI(currency);
                                    rates[currency] = rate;
                                } catch (error) {
                                    rates[currency] = this.exchangeRates[currency] || 1;
                                }
                            }
                            
                            // ä¿å­˜åˆ° API
                            await this.saveDailyExchangeRates(rates, currentDate);
                            successCount++;
                            console.log(`âœ… ${dateStr} åŒ¯ç‡å·²è£œè¶³`);
                            
                        } catch (error) {
                            console.error(`âŒ ${dateStr} è£œè¶³å¤±æ•—:`, error);
                            errorCount++;
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.showNotification(`è£œè¶³å®Œæˆï¼æˆåŠŸ: ${successCount} å¤©ï¼Œå¤±æ•—: ${errorCount} å¤©`, 'success');
                    
                } catch (error) {
                    console.error('âŒ è£œè¶³åŒ¯ç‡å¤±æ•—:', error);
                    this.showNotification('è£œè¶³åŒ¯ç‡å¤±æ•—', 'error');
                }
            }
            
            // è¼‰å…¥æ­·å²åŒ¯ç‡
            
            // ========== è³‡ç”¢çµ„åˆç®¡ç†åŠŸèƒ½ ==========
            
            // è‡ªå‹•è¨ˆç®—è³¼è²·å¹³å‡æˆæœ¬åƒ¹
            calculateUnitPrice() {
                const quantity = parseFloat(document.getElementById('assetQuantity').value) || 0;
                const cost = parseFloat(document.getElementById('assetCost').value) || 0;
                const unitPriceInput = document.getElementById('assetUnitPrice');
                
                if (quantity > 0 && cost > 0) {
                    const unitPrice = cost / quantity;
                    unitPriceInput.value = unitPrice.toFixed(4);
                    unitPriceInput.style.backgroundColor = '#f0f8ff';
                } else {
                    unitPriceInput.value = '';
                    unitPriceInput.style.backgroundColor = '';
                }
            }
            
            showAssetPortfolio() {
                console.log('é¡¯ç¤ºè³‡ç”¢çµ„åˆç®¡ç†');
                const modal = document.getElementById('assetPortfolioModal');
                if (modal) {
                    this.loadAssets();
                    modal.style.display = 'block';
                    
                    // æ·»åŠ æ‹–æ‹‰æ’åºåŠŸèƒ½
                    this.initDragAndDrop();
                }
            }
            
            hideAssetPortfolio() {
                console.log('éš±è—è³‡ç”¢çµ„åˆç®¡ç†');
                const modal = document.getElementById('assetPortfolioModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            async loadAssets() {
                console.log('é–‹å§‹è¼‰å…¥è³‡ç”¢...');
                
                try {
                    console.log('æ­£åœ¨é€£æ¥ API è¼‰å…¥è³‡ç”¢...');
                    
                    // ä½¿ç”¨ API è¼‰å…¥è³‡ç”¢
                    const assets = await window.apiService.getAssets();
                    console.log('API æŸ¥è©¢çµæœ:', assets);
                    console.log('è³‡ç”¢æ•¸é‡:', assets.length);
                    
                    // å¾ stock_code åˆ¤æ–·å¹£åˆ¥
                    const getCurrencyFromStockCode = (stockCode) => {
                        if (!stockCode) return 'TWD';
                        // ç¾è‚¡ï¼šå­—æ¯é–‹é ­
                        if (/^[A-Za-z]/.test(stockCode)) {
                            return 'USD';
                        }
                        // å°è‚¡ï¼šæ•¸å­—é–‹é ­
                        if (/^\d/.test(stockCode)) {
                            return 'TWD';
                        }
                        return 'TWD'; // é è¨­å°å¹£
                    };
                    
                    // ç”Ÿæˆè³‡ç”¢åç¨±ï¼ˆå¦‚æœæ²’æœ‰ï¼‰
                    const generateAssetName = (asset) => {
                        const assetType = asset.assetType || 'è³‡ç”¢';
                        const stockCode = asset.stockCode;
                        
                        if (stockCode) {
                            // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼ç”Ÿæˆæœ‰æ„ç¾©çš„åç¨±
                            if (/^[A-Za-z]/.test(stockCode)) {
                                return `${stockCode} ${assetType}`;
                            } else if (/^\d/.test(stockCode)) {
                                // å°è‚¡ ETF/å‚µåˆ¸é€šå¸¸ä»¥ 00 é–‹é ­
                                if (stockCode.startsWith('00')) {
                                    return `å°è‚¡ ETF ${stockCode}`;
                                } else {
                                    return `å°è‚¡ ${stockCode}`;
                                }
                            }
                            return `${assetType} (${stockCode})`;
                        }
                        
                        return assetType || 'è³‡ç”¢';
                    };
                    
                    this.assets = assets.map(asset => {
                        const assetType = asset.assetType || null;
                        // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„ currencyï¼Œå¦‚æœæ²’æœ‰å‰‡æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼åˆ¤æ–·
                        const currency = asset.currency || getCurrencyFromStockCode(asset.stockCode);
                        // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„ nameï¼Œå¦‚æœæ²’æœ‰æˆ–ç‚ºç©ºå‰‡è‡ªå‹•ç”Ÿæˆ
                        const name = (asset.name && asset.name.trim()) ? asset.name : generateAssetName(asset);
                        
                        return {
                        id: asset.id,
                        firebaseId: asset.firebaseId,
                            name: name, // ä½¿ç”¨è³‡æ–™åº«ä¸­çš„åç¨±ï¼Œå¦‚æœæ²’æœ‰å‰‡ç”Ÿæˆ
                        stockCode: asset.stockCode,
                            assetType: assetType,
                            type: assetType, // å‰ç«¯æœŸæœ› type æ¬„ä½
                        quantity: parseFloat(asset.quantity) || 0,
                        cost: parseFloat(asset.cost) || 0,
                        unitPrice: asset.unitPrice ? parseFloat(asset.unitPrice) : null,
                        purchasePrice: asset.unitPrice ? parseFloat(asset.unitPrice) : null,
                        currentPrice: parseFloat(asset.currentPrice) || 0,
                            currency: currency, // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­çš„å¹£åˆ¥ï¼Œå¦‚æœæ²’æœ‰å‰‡åˆ¤æ–·
                        purchaseDate: asset.purchaseDate || null,
                        member: asset.member,
                        category: asset.category,
                        order: asset.orderIndex || 0
                        };
                    });
                        
                        // æŒ‰ order æ¬„ä½æ’åºï¼Œå¦‚æœæ²’æœ‰ order å‰‡æŒ‰å‰µå»ºæ™‚é–“æ’åº
                        this.assets.sort((a, b) => {
                            const orderA = a.order !== undefined ? a.order : 999999;
                            const orderB = b.order !== undefined ? b.order : 999999;
                            return orderA - orderB;
                        });
                        
                        console.log('è¼‰å…¥çš„è³‡ç”¢ï¼ˆå·²æ’åºï¼‰:', this.assets);
                    
                    await this.renderAssetsTable();
                    await this.updatePortfolioSummary();
                    
                } catch (error) {
                    console.error('è¼‰å…¥è³‡ç”¢å¤±æ•—:', error);
                    console.error('éŒ¯èª¤è©³æƒ…:', {
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                    let errorMessage = 'è¼‰å…¥è³‡ç”¢å¤±æ•—';
                    if (error.code === 'permission-denied') {
                        errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™è¨­å®š';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                    } else if (error.message) {
                        errorMessage = `è¼‰å…¥è³‡ç”¢å¤±æ•—: ${error.message}`;
                    }
                    
                    this.showNotification(errorMessage, 'error');
                }
            }
            
            // åˆå§‹åŒ–æ‹–æ‹‰æ’åºåŠŸèƒ½
            initDragAndDrop() {
                const tbody = document.getElementById('assetsTableBody');
                if (!tbody) return;
                
                // æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
                const existingRows = tbody.querySelectorAll('tr[data-asset-id]');
                existingRows.forEach(row => {
                    row.removeEventListener('dragstart', this.handleDragStart);
                    row.removeEventListener('dragend', this.handleDragEnd);
                    row.removeEventListener('dragover', this.handleDragOver);
                    row.removeEventListener('drop', this.handleDrop);
                });
                
                // ç‚ºæ¯å€‹è³‡ç”¢è¡Œæ·»åŠ æ‹–æ‹‰åŠŸèƒ½
                const rows = tbody.querySelectorAll('tr[data-asset-id]');
                rows.forEach(row => {
                    row.draggable = true;
                    row.classList.add('draggable-row');
                    
                    // æ·»åŠ æ‹–æ‹‰æ‰‹æŠŠ
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && !firstCell.querySelector('.drag-handle')) {
                        const dragHandle = document.createElement('span');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = 'â‹®â‹®';
                        dragHandle.title = 'æ‹–æ‹‰æ’åº';
                        dragHandle.style.cursor = 'grab';
                        dragHandle.draggable = false; // é˜²æ­¢æ‰‹æŠŠæœ¬èº«è¢«æ‹–æ‹‰
                        firstCell.insertBefore(dragHandle, firstCell.firstChild);
                    }
                    
                    // ç¶å®šæ‹–æ‹‰äº‹ä»¶
                    row.addEventListener('dragstart', this.handleDragStart.bind(this));
                    row.addEventListener('dragend', this.handleDragEnd.bind(this));
                    row.addEventListener('dragover', this.handleDragOver.bind(this));
                    row.addEventListener('drop', this.handleDrop.bind(this));
                });
            }
            
            // æ‹–æ‹‰é–‹å§‹äº‹ä»¶
            handleDragStart(e) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                e.target.classList.add('dragging');
                console.log('é–‹å§‹æ‹–æ‹‰:', e.target.getAttribute('data-asset-id'));
                console.log('æ‹–æ‹‰ç›®æ¨™:', e.target);
            }
            
            // æ‹–æ‹‰çµæŸäº‹ä»¶
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                console.log('æ‹–æ‹‰çµæŸ');
            }
            
            // æ‹–æ‹‰æ‡¸åœäº‹ä»¶
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                console.log('æ‹–æ‹‰æ‡¸åœ:', e.target);
            }
            
            // æ‹–æ‹‰æ”¾ç½®äº‹ä»¶
            handleDrop(e) {
                e.preventDefault();
                const draggedRow = document.querySelector('.dragging');
                const targetRow = e.target.closest('tr[data-asset-id]');
                
                console.log('æ‹–æ‹‰æ”¾ç½®äº‹ä»¶è§¸ç™¼');
                console.log('è¢«æ‹–æ‹‰çš„è¡Œ:', draggedRow);
                console.log('ç›®æ¨™è¡Œ:', targetRow);
                console.log('äº‹ä»¶ç›®æ¨™:', e.target);
                
                if (draggedRow && targetRow && draggedRow !== targetRow) {
                    console.log('æ”¾ç½®åˆ°:', targetRow.getAttribute('data-asset-id'));
                    this.handleRowDrop(draggedRow, targetRow);
                } else {
                    console.log('æ”¾ç½®æ¢ä»¶ä¸æ»¿è¶³');
                }
            }
            
            // è™•ç†è¡Œæ‹–æ‹‰æ”¾ç½®
            handleRowDrop(draggedRow, targetRow) {
                const tbody = document.getElementById('assetsTableBody');
                const draggedId = draggedRow.getAttribute('data-asset-id');
                const targetId = targetRow.getAttribute('data-asset-id');
                
                console.log('æ‹–æ‹‰æ”¾ç½®:', draggedId, 'åˆ°', targetId);
                
                // ç§»é™¤è¢«æ‹–æ‹‰çš„è¡Œ
                draggedRow.remove();
                
                // å°‡æ‹–æ‹‰çš„è¡Œæ’å…¥åˆ°ç›®æ¨™ä½ç½®
                tbody.insertBefore(draggedRow, targetRow);
                
                console.log('DOM æ›´æ–°å®Œæˆ');
                
                // æ›´æ–°è³‡ç”¢é †åº
                this.updateAssetOrder();
            }
            
            // æ›´æ–°è³‡ç”¢é †åºåˆ° Firestore
            async updateAssetOrder() {
                const tbody = document.getElementById('assetsTableBody');
                const rows = tbody.querySelectorAll('tr[data-asset-id]');
                
                try {
                    // æ‰¹é‡æ›´æ–°é †åº
                    const updates = [];
                    rows.forEach((row, index) => {
                        const assetIdStr = row.getAttribute('data-asset-id');
                        // å°‡å­—ç¬¦ä¸² ID è½‰æ›ç‚ºæ•¸å­—ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                        const assetIdNum = assetIdStr ? parseInt(assetIdStr) : null;
                        const asset = this.assets.find(a => {
                            // æ”¯æ´æ•¸å­—å’Œå­—ç¬¦ä¸²é¡å‹çš„ ID æ¯”è¼ƒ
                            return a.id === assetIdStr || a.id === assetIdNum || String(a.id) === String(assetIdStr);
                        });
                        if (asset) {
                            updates.push({
                                id: asset.id, // ä½¿ç”¨å¯¦éš›çš„è³‡ç”¢ IDï¼ˆæ•¸å­—é¡å‹ï¼‰
                                order: index
                            });
                        }
                    });
                    
                    // æ›´æ–° API
                    for (const update of updates) {
                        await window.apiService.updateAsset(update.id, {
                            orderIndex: update.order
                        });
                    }
                    
                    console.log('âœ… è³‡ç”¢é †åºå·²æ›´æ–°');
                    
                } catch (error) {
                    console.error('âŒ æ›´æ–°è³‡ç”¢é †åºå¤±æ•—:', error);
                    this.showNotification('æ›´æ–°é †åºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                }
            }
            
            async renderAssetsTable() {
                const tbody = document.getElementById('assetsTableBody');
                if (!tbody) return;
                
                if (this.assets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">å°šç„¡è³‡ç”¢è¨˜éŒ„</td></tr>';
                    return;
                }
                
                const tableHTML = await Promise.all(this.assets.map(async asset => {
                    const purchasePrice = asset.purchasePrice || asset.unitPrice || 1;
                    const currentPrice = asset.currentPrice || purchasePrice;
                    const quantity = asset.quantity;
                    
                    // è¨ˆç®—æç›Š
                    // å„ªå…ˆä½¿ç”¨æ•¸æ“šåº«ä¸­çš„ cost æ¬„ä½ï¼ˆå¯¦éš›å„²å­˜çš„ç¸½æˆæœ¬ï¼‰ï¼Œå¦‚æœæ²’æœ‰æˆ–ç‚º0ï¼Œå‰‡ä½¿ç”¨ quantity * purchasePrice
                    const costBasis = (asset.cost && asset.cost > 0) ? asset.cost : (quantity * purchasePrice);
                    const currentValue = quantity * currentPrice;
                    
                    // å¦‚æœæ˜¯è‚¡ç¥¨ï¼Œè¨ˆç®—å¯¦éš›æˆäº¤é‡‘é¡ï¼ˆæ‰£é™¤æ‰‹çºŒè²»å’Œäº¤æ˜“ç¨…ï¼‰
                    let actualValue = currentValue;
                    let feeDetails = '';
                    if (asset.type === 'è‚¡ç¥¨') {
                        const actualAmount = this.calculateActualAmount(quantity, currentPrice, asset.currency, asset.stockCode);
                        actualValue = actualAmount.actualAmount;
                        
                        // æº–å‚™ tooltip å…§å®¹
                        const marketValueTWD = await this.convertToTWD(actualAmount.marketValue, asset.currency);
                        const commissionTWD = await this.convertToTWD(actualAmount.commission, asset.currency);
                        const taxTWD = await this.convertToTWD(actualAmount.tax, asset.currency);
                        const actualAmountTWD = await this.convertToTWD(actualAmount.actualAmount, asset.currency);
                        
                        feeDetails = `
                            å¸‚å ´å¸‚å€¼: NT$ ${this.formatNumber(marketValueTWD)}
                            æ‰‹çºŒè²»: NT$ ${this.formatNumber(commissionTWD)} (${(actualAmount.commissionRate * 100).toFixed(4)}%)
                            äº¤æ˜“ç¨…: NT$ ${this.formatNumber(taxTWD)} (${(actualAmount.taxRate * 100).toFixed(3)}%)
                            å¯¦éš›é‡‘é¡: NT$ ${this.formatNumber(actualAmountTWD)}
                        `;
                    }
                    
                    const profitLoss = actualValue - costBasis;
                    const profitLossPercent = costBasis > 0 ? (profitLoss / costBasis) * 100 : 0;
                    
                    // è½‰æ›ç‚ºå°å¹£ï¼ˆä½¿ç”¨è³¼è²·æ—¥æœŸçš„åŒ¯ç‡ï¼‰
                    // æ³¨æ„ï¼šå¦‚æœæ²’æœ‰è³¼è²·æ—¥æœŸï¼Œæœƒä½¿ç”¨ç•¶å‰åŒ¯ç‡
                    const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : null;
                    const costBasisTWD = await this.convertToTWD(costBasis, asset.currency, 1, purchaseDate);
                    const currentValueTWD = await this.convertToTWD(currentValue, asset.currency);
                    const actualValueTWD = await this.convertToTWD(actualValue, asset.currency);
                    const profitLossTWD = actualValueTWD - costBasisTWD;
                    
                    // æç›Šé¡è‰²
                    const pnlClass = profitLoss >= 0 ? 'profit' : 'loss';
                    const pnlSign = profitLoss >= 0 ? '+' : '';
                    
                    // æç›Š tooltip
                    const profitLossTooltip = asset.type === 'è‚¡ç¥¨' ? 
                        `title="${feeDetails}"` : '';
                    
                    // æç›Šç™¾åˆ†æ¯” tooltip
                    const profitLossPercentTooltip = asset.type === 'è‚¡ç¥¨' ? 
                        `title="${feeDetails}"` : '';
                    
                    // æç›Šè©³ç´°è³‡æ–™æŒ‰éˆ•
                    const profitLossDetailButton = asset.type === 'è‚¡ç¥¨' ? 
                        `<button onclick="if(window.expenseTracker){window.expenseTracker.showProfitLossDetails(${asset.id})}else{console.error('expenseTracker not found')}" class="btn-detail" title="æŸ¥çœ‹è©³ç´°æç›Š">ğŸ“Š</button>` : '';
                    
                    return `
                        <tr data-asset-id="${asset.id}">
                            <td class="operation-cell">
                                ${asset.type === 'è‚¡ç¥¨' && asset.stockCode ? 
                                    `<button onclick="if(window.expenseTracker){window.expenseTracker.updateCurrentPrice(${asset.id})}else{console.error('expenseTracker not found')}" class="btn-update" title="å–å¾—æœ€æ–°åƒ¹æ ¼" data-update-price="${asset.id}" data-asset-id="${asset.id}">ğŸ“ˆ æ›´æ–°è‚¡åƒ¹</button>` : 
                                    '<span style="color: #999;">-</span>'
                                }
                            </td>
                            <td>${asset.name}</td>
                            <td>${asset.stockCode || '-'}</td>
                            <td>${asset.type}</td>
                            <td>${this.formatNumber(quantity)}</td>
                            <td>${asset.currency} ${purchasePrice.toFixed(2)}</td>
                            <td>${asset.currency} ${currentPrice.toFixed(2)}</td>
                            <td>NT$ ${this.formatNumber(costBasisTWD)}</td>
                            <td>NT$ ${this.formatNumber(currentValueTWD)}</td>
                            <td class="${pnlClass}" ${profitLossTooltip}>
                                ${pnlSign}NT$ ${this.formatNumber(Math.abs(profitLossTWD))}
                            </td>
                            <td class="${pnlClass}" ${profitLossPercentTooltip}>
                                ${pnlSign}${profitLossPercent.toFixed(2)}%
                            </td>
                            <td class="operation-cell">
                                <div class="btn-group">
                                    ${profitLossDetailButton}
                                    <button onclick="if(window.expenseTracker){window.expenseTracker.editAsset(${asset.id})}else{console.error('expenseTracker not found')}" class="btn-edit" title="ç·¨è¼¯">âœï¸</button>
                                    <button onclick="if(window.expenseTracker){window.expenseTracker.deleteAsset(${asset.id})}else{console.error('expenseTracker not found')}" class="btn-delete" title="åˆªé™¤">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }));
                
                tbody.innerHTML = tableHTML.join('');
                
                // é‡æ–°åˆå§‹åŒ–æ‹–æ‹‰åŠŸèƒ½
                this.initDragAndDrop();
            }
            
            async updatePortfolioSummary() {
                let totalValue = 0;
                let totalCost = 0;
                let totalActualValue = 0; // å¯¦éš›æˆäº¤é‡‘é¡ï¼ˆæ‰£é™¤è²»ç”¨ï¼‰
                
                for (const asset of this.assets) {
                    const quantity = parseFloat(asset.quantity) || 0;
                    const purchasePrice = parseFloat(asset.purchasePrice) || parseFloat(asset.unitPrice) || 0;
                    const currentPrice = parseFloat(asset.currentPrice) || purchasePrice;
                    
                    // è¨ˆç®—æˆæœ¬ï¼ˆå°å¹£ï¼Œä½¿ç”¨è³¼è²·æ—¥æœŸçš„åŒ¯ç‡ï¼‰
                    const cost = quantity * purchasePrice;
                    const purchaseDate = asset.purchaseDate ? new Date(asset.purchaseDate) : null;
                    const costTWD = await this.convertToTWD(cost, asset.currency, 1, purchaseDate);
                    totalCost += costTWD;
                    
                    // è¨ˆç®—ç•¶å‰åƒ¹å€¼ï¼ˆå°å¹£ï¼Œä½¿ç”¨ç•¶å‰åŒ¯ç‡ï¼‰
                    const currentValue = quantity * currentPrice;
                    const currentValueTWD = await this.convertToTWD(currentValue, asset.currency);
                    totalValue += currentValueTWD;
                    
                    // å¦‚æœæ˜¯è‚¡ç¥¨ï¼Œè¨ˆç®—å¯¦éš›æˆäº¤é‡‘é¡ï¼ˆæ‰£é™¤æ‰‹çºŒè²»å’Œäº¤æ˜“ç¨…ï¼‰
                    if (asset.type === 'è‚¡ç¥¨') {
                        const actualAmount = this.calculateActualAmount(quantity, currentPrice, asset.currency, asset.stockCode);
                        const actualAmountTWD = await this.convertToTWD(actualAmount.actualAmount, asset.currency);
                        totalActualValue += actualAmountTWD;
                    } else {
                        // éè‚¡ç¥¨è³‡ç”¢ï¼Œå¯¦éš›é‡‘é¡ç­‰æ–¼å¸‚å ´åƒ¹å€¼
                        totalActualValue += currentValueTWD;
                    }
                }
                
                // è¨ˆç®—ç¸½æç›Šï¼ˆä½¿ç”¨å¯¦éš›æˆäº¤é‡‘é¡ï¼‰
                const totalProfitLoss = totalActualValue - totalCost;
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('portfolioTotalValue').textContent = '$' + this.formatNumber(totalValue);
                document.getElementById('portfolioTotalCost').textContent = '$' + this.formatNumber(totalCost);
                
                // æç›Šé¡¯ç¤ºï¼ˆæ­£æ•¸é¡¯ç¤ºç¶ è‰²ï¼Œè² æ•¸é¡¯ç¤ºç´…è‰²ï¼‰
                const profitLossElement = document.getElementById('portfolioTotalProfitLoss');
                if (profitLossElement) {
                    const sign = totalProfitLoss >= 0 ? '+' : '';
                    profitLossElement.textContent = sign + '$' + this.formatNumber(Math.abs(totalProfitLoss));
                    profitLossElement.className = totalProfitLoss >= 0 ? 'amount profit' : 'amount loss';
                }
                
                // æ›´æ–°æ¨™é¡Œä¸­çš„è³‡ç”¢é …ç›®æ•¸
                const assetCountDisplay = document.getElementById('assetCountDisplay');
                if (assetCountDisplay) {
                    assetCountDisplay.textContent = `(${this.assets.length} é …)`;
                }
                
                console.log('è³‡ç”¢çµ„åˆæ‘˜è¦æ›´æ–°:', {
                    totalValue: totalValue,
                    totalCost: totalCost,
                    totalActualValue: totalActualValue,
                    totalProfitLoss: totalProfitLoss
                });
            }
            
            async convertToTWD(quantity, currency, unitPrice = 1, date = null) {
                if (currency === 'TWD') {
                    return quantity * unitPrice;
                }
                
                // å¦‚æœæ²’æœ‰æŒ‡å®šæ—¥æœŸï¼Œä½¿ç”¨ç•¶å‰åŒ¯ç‡
                if (!date) {
                const rate = this.exchangeRates[currency] || 1;
                return quantity * unitPrice * rate;
                }
                
                // ä½¿ç”¨æŒ‡å®šæ—¥æœŸçš„åŒ¯ç‡
                try {
                    const rate = await this.getExchangeRateForDate(currency, date);
                    if (rate !== null) {
                        return quantity * unitPrice * rate;
                    } else {
                        // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ­·å²åŒ¯ç‡ï¼Œä½¿ç”¨ç•¶å‰åŒ¯ç‡
                        console.log(`ä½¿ç”¨ç•¶å‰åŒ¯ç‡ä½œç‚ºå‚™ç”¨: ${this.exchangeRates[currency]}`);
                        return quantity * unitPrice * (this.exchangeRates[currency] || 1);
                    }
                } catch (error) {
                    console.error('ç²å–æ­·å²åŒ¯ç‡å¤±æ•—ï¼Œä½¿ç”¨ç•¶å‰åŒ¯ç‡:', error);
                    const rate = this.exchangeRates[currency] || 1;
                    return quantity * unitPrice * rate;
                }
            }
            
            showAddAssetForm() {
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    // ç¢ºä¿æ˜¯æ–°å¢æ¨¡å¼
                    this.editingAssetId = null;
                    
                    // é‡ç½®è¡¨å–®
                    document.getElementById('addAssetForm').reset();
                    
                    // é‡ç½®è¡¨å–®æ¨™é¡Œå’ŒæŒ‰éˆ•æ–‡å­—
                    const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'â• æ–°å¢è³‡ç”¢';
                    }
                    
                    const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'æ–°å¢è³‡ç”¢';
                    }
                    
                    // éš±è—æ‰€æœ‰å‹•æ…‹æ¬„ä½
                    document.getElementById('currentPriceGroup').style.display = 'none';
                    document.getElementById('purchaseDateGroup').style.display = 'none';
                    document.getElementById('stockCodeGroup').style.display = 'none';
                    document.getElementById('exchangeRateGroup').style.display = 'none';
                    
                    modal.style.display = 'block';
                }
            }
            
            hideAddAssetForm() {
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.getElementById('addAssetForm').reset();
                    
                    // é‡ç½®ç·¨è¼¯æ¨¡å¼
                    this.editingAssetId = null;
                    
                    // é‡ç½®è¡¨å–®æ¨™é¡Œå’ŒæŒ‰éˆ•æ–‡å­—
                    const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                    if (modalTitle) {
                        modalTitle.textContent = 'â• æ–°å¢è³‡ç”¢';
                    }
                    
                    const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'æ–°å¢è³‡ç”¢';
                    }
                    
                    // é‡ç½®è³¼è²·å¹³å‡æˆæœ¬åƒ¹æ¬„ä½æ¨£å¼
                    const unitPriceInput = document.getElementById('assetUnitPrice');
                    if (unitPriceInput) {
                        unitPriceInput.style.backgroundColor = '';
                    }
                    
                    // éš±è—æ‰€æœ‰å‹•æ…‹æ¬„ä½
                    document.getElementById('currentPriceGroup').style.display = 'none';
                    document.getElementById('purchaseDateGroup').style.display = 'none';
                    document.getElementById('stockCodeGroup').style.display = 'none';
                    document.getElementById('exchangeRateGroup').style.display = 'none';
                }
            }
            
            async addAsset() {
                // æäº¤å‰ç¢ºä¿è³¼è²·å¹³å‡æˆæœ¬åƒ¹å·²è¨ˆç®—
                this.calculateUnitPrice();
                
                const quantity = parseFloat(document.getElementById('assetQuantity').value);
                const cost = parseFloat(document.getElementById('assetCost').value);
                const unitPrice = parseFloat(document.getElementById('assetUnitPrice').value);
                
                // é©—è­‰å¿…è¦æ¬„ä½
                if (!quantity || quantity <= 0 || !cost || cost <= 0 || !unitPrice || unitPrice <= 0) {
                    this.showNotification('è«‹ç¢ºèªè‚¡æ•¸ã€ç¸½æˆæœ¬å’Œè³¼è²·å¹³å‡æˆæœ¬åƒ¹éƒ½å·²æ­£ç¢ºå¡«å¯«ä¸”å¤§æ–¼0', 'error');
                    return;
                }
                
                const assetData = {
                    name: document.getElementById('assetName').value || null,
                    stockCode: document.getElementById('assetStockCode').value || null,
                    assetType: document.getElementById('assetType').value,
                    currency: document.getElementById('assetCurrency').value || 'TWD',
                    quantity: quantity,
                    cost: cost,
                    unitPrice: unitPrice,
                    currentPrice: parseFloat(document.getElementById('assetCurrentPrice').value) || 0,
                    purchaseDate: document.getElementById('assetPurchaseDate').value || null,
                    member: null, // å¯ä»¥æ ¹æ“šéœ€è¦æ·»åŠ 
                    category: null, // å¯ä»¥æ ¹æ“šéœ€è¦æ·»åŠ 
                    orderIndex: this.assets.length // æ–°è³‡ç”¢æ’åœ¨æœ€å¾Œ
                };
                
                try {
                    if (this.editingAssetId) {
                        // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°ç¾æœ‰è³‡ç”¢
                        await window.apiService.updateAsset(this.editingAssetId, assetData);
                        
                        console.log('è³‡ç”¢æ›´æ–°æˆåŠŸ');
                        this.showNotification('è³‡ç”¢æ›´æ–°æˆåŠŸ', 'success');
                        
                        // æ¸…é™¤ç·¨è¼¯æ¨¡å¼
                        this.editingAssetId = null;
                    } else {
                        // æ–°å¢æ¨¡å¼ï¼šå»ºç«‹æ–°è³‡ç”¢
                        await window.apiService.createAsset(assetData);
                        
                        console.log('è³‡ç”¢æ–°å¢æˆåŠŸ');
                        this.showNotification('è³‡ç”¢æ–°å¢æˆåŠŸ', 'success');
                    }
                    
                    // é‡æ–°è¼‰å…¥è³‡ç”¢åˆ—è¡¨
                    await this.loadAssets();
                    
                    // é—œé–‰è¡¨å–®
                    this.hideAddAssetForm();
                    
                } catch (error) {
                    console.error('è³‡ç”¢æ“ä½œå¤±æ•—:', error);
                    this.showNotification('è³‡ç”¢æ“ä½œå¤±æ•—', 'error');
                }
            }
            
            editAsset(assetId) {
                console.log('ğŸ”„ editAsset è¢«èª¿ç”¨ï¼ŒassetId:', assetId, 'é¡å‹:', typeof assetId);
                
                // å°‡ assetId è½‰æ›ç‚ºèˆ‡è³‡ç”¢ ID ç›¸åŒçš„é¡å‹é€²è¡Œæ¯”è¼ƒ
                const assetIdNum = typeof assetId === 'string' ? parseInt(assetId) : assetId;
                const asset = this.assets.find(a => {
                    // æ”¯æ´æ•¸å­—å’Œå­—ç¬¦ä¸²é¡å‹çš„ ID æ¯”è¼ƒ
                    return a.id === assetId || a.id === assetIdNum || String(a.id) === String(assetId);
                });
                
                if (!asset) {
                    console.error('âŒ æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è³‡ç”¢ï¼ŒassetId:', assetId, 'assetIdé¡å‹:', typeof assetId);
                    console.error('æ‰€æœ‰å¯ç”¨è³‡ç”¢ID:', this.assets.map(a => ({ id: a.id, idType: typeof a.id, name: a.name })));
                    this.showNotification(`æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è³‡ç”¢ (ID: ${assetId})`, 'error');
                    return;
                }
                
                console.log('âœ… æ‰¾åˆ°è¦ç·¨è¼¯çš„è³‡ç”¢:', { id: asset.id, name: asset.name });
                
                // è¨­å®šç·¨è¼¯æ¨¡å¼
                this.editingAssetId = assetId;
                
                // å…ˆé¡¯ç¤ºè¡¨å–®ï¼ˆä¸é‡ç½®ï¼‰
                const modal = document.getElementById('addAssetModal');
                if (modal) {
                    modal.style.display = 'block';
                }
                
                // é å¡«è¡¨å–®è³‡æ–™
                document.getElementById('assetName').value = asset.name || '';
                document.getElementById('assetType').value = asset.type || '';
                document.getElementById('assetQuantity').value = asset.quantity || '';
                document.getElementById('assetCurrency').value = asset.currency || 'TWD';
                document.getElementById('assetCost').value = asset.cost || (asset.purchasePrice * asset.quantity) || '';
                document.getElementById('assetUnitPrice').value = asset.purchasePrice || asset.unitPrice || '';
                document.getElementById('assetCurrentPrice').value = asset.currentPrice || '';
                document.getElementById('assetPurchaseDate').value = asset.purchaseDate || '';
                document.getElementById('assetStockCode').value = asset.stockCode || '';
                document.getElementById('assetDescription').value = asset.description || '';
                
                console.log('è¡¨å–®é å¡«å®Œæˆ');
                
                // è§¸ç™¼é¡å‹è®Šæ›´äº‹ä»¶ä»¥é¡¯ç¤º/éš±è—ç›¸é—œæ¬„ä½
                const typeEvent = new Event('change');
                document.getElementById('assetType').dispatchEvent(typeEvent);
                
                // è§¸ç™¼å¹£åˆ¥è®Šæ›´äº‹ä»¶ä»¥é¡¯ç¤º/éš±è—åŒ¯ç‡æ¬„ä½
                const currencyEvent = new Event('change');
                document.getElementById('assetCurrency').dispatchEvent(currencyEvent);
                
                // æ›´æ–°è¡¨å–®æ¨™é¡Œ
                const modalTitle = document.querySelector('#addAssetModal .modal-header h2');
                if (modalTitle) {
                    modalTitle.textContent = 'âœï¸ ç·¨è¼¯è³‡ç”¢';
                }
                
                // æ›´æ–°æäº¤æŒ‰éˆ•æ–‡å­—
                const submitBtn = document.querySelector('#addAssetForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ›´æ–°è³‡ç”¢';
                }
                
                console.log('ç·¨è¼¯è³‡ç”¢:', asset);
            }
            
            async deleteAsset(assetId) {
                console.log('ğŸ”„ deleteAsset è¢«èª¿ç”¨ï¼ŒassetId:', assetId, 'é¡å‹:', typeof assetId);
                
                // å°‡ assetId è½‰æ›ç‚ºèˆ‡è³‡ç”¢ ID ç›¸åŒçš„é¡å‹é€²è¡Œæ¯”è¼ƒ
                const assetIdNum = typeof assetId === 'string' ? parseInt(assetId) : assetId;
                const asset = this.assets.find(a => {
                    // æ”¯æ´æ•¸å­—å’Œå­—ç¬¦ä¸²é¡å‹çš„ ID æ¯”è¼ƒ
                    return a.id === assetId || a.id === assetIdNum || String(a.id) === String(assetId);
                });
                
                if (!asset) {
                    console.error('âŒ æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è³‡ç”¢ï¼ŒassetId:', assetId, 'assetIdé¡å‹:', typeof assetId);
                    console.error('æ‰€æœ‰å¯ç”¨è³‡ç”¢ID:', this.assets.map(a => ({ id: a.id, idType: typeof a.id, name: a.name })));
                    this.showNotification(`æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è³‡ç”¢ (ID: ${assetId})`, 'error');
                    return;
                }
                
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${asset.name || asset.stockCode || 'æ­¤è³‡ç”¢'}ã€å—ï¼Ÿ`)) {
                    return;
                }
                
                try {
                    console.log('ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤è³‡ç”¢:', { id: asset.id, name: asset.name });
                    await window.apiService.deleteAsset(asset.id);
                    
                    console.log('è³‡ç”¢åˆªé™¤æˆåŠŸ');
                    this.showNotification('è³‡ç”¢åˆªé™¤æˆåŠŸ', 'success');
                    
                    this.loadAssets();
                } catch (error) {
                    console.error('åˆªé™¤è³‡ç”¢å¤±æ•—:', error);
                    this.showNotification('åˆªé™¤è³‡ç”¢å¤±æ•—', 'error');
                }
            }

            // ========== è‚¡ç¥¨åƒ¹æ ¼åŠŸèƒ½ ==========
            
            // è‚¡ç¥¨åƒ¹æ ¼æ›´æ–°åŠŸèƒ½
            async fetchCurrentStockPrice() {
                const assetName = document.getElementById('assetName').value;
                const assetType = document.getElementById('assetType').value;
                const stockCode = document.getElementById('assetStockCode').value;
                const currentPriceInput = document.getElementById('assetCurrentPrice');
                const fetchBtn = document.getElementById('fetchCurrentPriceBtn');
                
                if (assetType !== 'è‚¡ç¥¨') {
                    this.showNotification('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼è‚¡ç¥¨', 'warning');
                    return;
                }
                
                if (!assetName) {
                    this.showNotification('è«‹å…ˆè¼¸å…¥è‚¡ç¥¨åç¨±', 'error');
                    return;
                }
                
                if (!stockCode) {
                    this.showNotification('è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼', 'error');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                fetchBtn.disabled = true;
                fetchBtn.textContent = 'ğŸ“ˆ å–å¾—ä¸­...';
                
                try {
                    // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼å–å¾—åƒ¹æ ¼
                    const stockData = await this.getStockPrice(stockCode);
                    currentPriceInput.value = stockData.price.toFixed(2);
                    
                    // åŒæ™‚æ›´æ–°å¹£åˆ¥æ¬„ä½
                    const currencySelect = document.getElementById('assetCurrency');
                    currencySelect.value = stockData.currency;
                    
                    // è§¸ç™¼å¹£åˆ¥è®Šæ›´äº‹ä»¶
                    const currencyEvent = new Event('change');
                    currencySelect.dispatchEvent(currencyEvent);
                    
                    console.log(`å–å¾— ${stockCode} (${assetName}) æœ€æ–°åƒ¹æ ¼: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                    this.showNotification(`${stockCode} (${assetName}) æœ€æ–°åƒ¹æ ¼: ${stockData.price.toFixed(2)} ${stockData.currency}`, 'success');
                    
                } catch (error) {
                    console.error('å–å¾—è‚¡ç¥¨åƒ¹æ ¼å¤±æ•—:', error);
                    this.showNotification(`å–å¾— ${stockCode} åƒ¹æ ¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥`, 'error');
                } finally {
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = 'ğŸ“ˆ å–å¾—æœ€æ–°åƒ¹æ ¼';
                }
            }
            
            // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼å–å¾—åƒ¹æ ¼
            async getStockPrice(stockCode) {
                try {
                    // å˜—è©¦å–å¾—çœŸå¯¦è‚¡ç¥¨åƒ¹æ ¼
                    const realPrice = await this.fetchRealStockPrice(stockCode);
                    if (realPrice) {
                        console.log(`å–å¾— ${stockCode} çœŸå¯¦åƒ¹æ ¼: ${realPrice.price.toFixed(2)} ${realPrice.currency}`);
                        return realPrice;
                    }
                } catch (error) {
                    console.warn(`å–å¾— ${stockCode} çœŸå¯¦åƒ¹æ ¼å¤±æ•—:`, error.message);
                }
                
                // å¦‚æœçœŸå¯¦ API å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤è€Œä¸æ˜¯ä½¿ç”¨å›ºå®šåƒ¹æ ¼
                throw new Error(`ç„¡æ³•å–å¾— ${stockCode} çš„åƒ¹æ ¼è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç•¶å‰åƒ¹æ ¼`);
            }
            
            // å–å¾—çœŸå¯¦è‚¡ç¥¨åƒ¹æ ¼ - å¤š API æ”¯æ´
            async fetchRealStockPrice(stockCode) {
                console.log(`ğŸ” é–‹å§‹æŸ¥è©¢ ${stockCode} çš„åƒ¹æ ¼...`);
                
                // å„ªå…ˆä½¿ç”¨ Yahoo Finance API
                try {
                    console.log(`å˜—è©¦ Yahoo Finance API`);
                    const result = await this.tryYahooFinance(stockCode);
                    if (result) {
                        console.log(`âœ… Yahoo Finance æˆåŠŸ: ${stockCode} = ${result.price} ${result.currency}`);
                        return result;
                    }
                } catch (error) {
                    console.warn(`âŒ Yahoo Finance å¤±æ•—:`, error.message);
                }
                
                // å‚™ç”¨ API
                const apis = [
                    () => this.tryYahooFinance(stockCode),
                    () => this.tryFinancialModelingPrep(stockCode),
                    () => this.tryMarketStack(stockCode),
                    () => this.tryAlphaVantage(stockCode),
                    () => this.tryIEXCloud(stockCode)
                ];
                
                for (let i = 0; i < apis.length; i++) {
                    try {
                        console.log(`å˜—è©¦å‚™ç”¨ API ${i + 1}/${apis.length}`);
                        const result = await apis[i]();
                        if (result) {
                            console.log(`âœ… å‚™ç”¨ API ${i + 1} æˆåŠŸ: ${stockCode} = ${result.price} ${result.currency}`);
                            return result;
                        }
                    } catch (error) {
                        console.warn(`âŒ å‚™ç”¨ API ${i + 1} å¤±æ•—:`, error.message);
                        if (i === apis.length - 1) {
                            throw new Error(`æ‰€æœ‰ API éƒ½å¤±æ•—: ${error.message}`);
                        }
                        continue;
                    }
                }
            }
            
            // Yahoo Finance API (é€é allorigins.win ä»£ç†)
            async tryYahooFinance(stockCode) {
                console.log(`ğŸ“Š Yahoo Finance: ${stockCode}`);
                
                try {
                    // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼è‡ªå‹•æ·»åŠ å¸‚å ´å¾Œç¶´
                    let yahooSymbol = stockCode;
                    
                    // å¸¸è¦‹ç¾åœ‹ETFåˆ—è¡¨
                    const usEtfSymbols = ["SPY", "VOO", "VTI", "IVV", "QQQ", "SCHD", "JEPI", "VT", "ARKK", "ARKQ", "ARKW", "ARKG", "ARKF", "XLF", "XLK", "XLE", "XLI", "XLV", "XLY", "XLP", "XLU", "XLRE", "XLB", "XLC", "XLNX"];
                    
                    // æª¢æ¸¬è‚¡ç¥¨ä»£ç¢¼é¡å‹ä¸¦æ·»åŠ ç›¸æ‡‰çš„å¸‚å ´å¾Œç¶´
                    if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                        // å°è‚¡ï¼š4ä½æ•¸å­—æˆ–4ä½æ•¸å­—+å­—æ¯ï¼ˆå¦‚00692Bï¼‰
                        yahooSymbol = `${stockCode}.TW`;
                        console.log(`å°è‚¡ä»£ç¢¼: ${stockCode} -> ${yahooSymbol}`);
                    } else if (usEtfSymbols.includes(stockCode.toUpperCase())) {
                        // ç¾åœ‹ETFï¼šç›´æ¥ä½¿ç”¨ä»£ç¢¼
                        yahooSymbol = stockCode;
                        console.log(`ç¾åœ‹ETF: ${stockCode} -> ${yahooSymbol}`);
                    } else if (/^[A-Za-z]{1,5}$/.test(stockCode)) {
                        // ç¾åœ‹è‚¡ç¥¨ï¼šç›´æ¥ä½¿ç”¨ä»£ç¢¼
                        yahooSymbol = stockCode;
                        console.log(`ç¾åœ‹è‚¡ç¥¨: ${stockCode} -> ${yahooSymbol}`);
                    } else if (/^\d{4}$/.test(stockCode)) {
                        // 4ä½ç´”æ•¸å­—ï¼šå¯èƒ½æ˜¯å°è‚¡
                        yahooSymbol = `${stockCode}.TW`;
                        console.log(`4ä½æ•¸å­—å°è‚¡: ${stockCode} -> ${yahooSymbol}`);
                    } else {
                        // å…¶ä»–æƒ…æ³ï¼šé è¨­ç‚ºç¾è‚¡
                        yahooSymbol = stockCode;
                        console.log(`é è¨­ç¾è‚¡: ${stockCode} -> ${yahooSymbol}`);
                    }
                    
                    const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=1mo`;
                    console.log(`Yahoo Finance API URL: ${apiUrl}`);
                    
                    // ä½¿ç”¨ allorigins.win çš„ raw ç«¯é»
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
                    console.log(`CORS ä»£ç† URL: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä»£ç†è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Yahoo Finance å›æ‡‰:', data);
                    
                    // è§£æ Yahoo Finance å›æ‡‰
                    if (data.chart && data.chart.result && data.chart.result.length > 0) {
                        const result = data.chart.result[0];
                        const meta = result.meta;
                        
                        if (meta && meta.regularMarketPrice) {
                            const price = meta.regularMarketPrice;
                            const currency = meta.currency || 'USD';
                            const symbol = meta.symbol || stockCode;
                            
                            console.log(`âœ… Yahoo Finance è§£ææˆåŠŸ: ${price} ${currency}`);
                            return {
                                price: price,
                                currency: currency,
                                symbol: symbol
                            };
                        } else {
                            throw new Error('ç„¡æ³•å¾ Yahoo Finance å›æ‡‰ä¸­æå–åƒ¹æ ¼æ•¸æ“š');
                        }
                    } else {
                        throw new Error('Yahoo Finance å›æ‡‰æ ¼å¼ç•°å¸¸');
                    }
                    
                } catch (error) {
                    console.error(`Yahoo Finance ä»£ç†å¤±æ•—:`, error);
                    throw error;
                }
            }
            
            // è§£æ Google Finance å›æ‡‰
            parseGoogleFinanceResponse(html, stockCode) {
                // è§£æ HTML ä¸­çš„åƒ¹æ ¼æ•¸æ“š
                // Google Finance ä½¿ç”¨ JSON-LD çµæ§‹åŒ–æ•¸æ“š
                const jsonLdMatch = html.match(/<script type="application\/ld\+json">(.*?)<\/script>/s);
                if (jsonLdMatch) {
                    try {
                        const jsonData = JSON.parse(jsonLdMatch[1]);
                        console.log('Google Finance JSON æ•¸æ“š:', jsonData);
                        
                        if (jsonData.price) {
                            const price = parseFloat(jsonData.price);
                            const currency = this.getCurrencyByMarket(stockCode);
                            console.log(`âœ… Google Finance è§£ææˆåŠŸ: ${price} ${currency}`);
                            return { price, currency };
                        }
                    } catch (jsonError) {
                        console.warn('JSON è§£æå¤±æ•—:', jsonError);
                    }
                }
                
                // å‚™ç”¨è§£ææ–¹æ³•ï¼šå¾ HTML ä¸­æå–åƒ¹æ ¼
                const priceMatch = html.match(/"price":"([^"]+)"/);
                if (priceMatch) {
                    const price = parseFloat(priceMatch[1]);
                    const currency = this.getCurrencyByMarket(stockCode);
                    console.log(`âœ… Google Finance å‚™ç”¨è§£ææˆåŠŸ: ${price} ${currency}`);
                    return { price, currency };
                }
                
                // å¦ä¸€å€‹å‚™ç”¨è§£ææ–¹æ³•
                const pricePattern = /data-last-price="([^"]+)"/;
                const priceMatch2 = html.match(pricePattern);
                if (priceMatch2) {
                    const price = parseFloat(priceMatch2[1]);
                    const currency = this.getCurrencyByMarket(stockCode);
                    console.log(`âœ… Google Finance ç¬¬äºŒå‚™ç”¨è§£ææˆåŠŸ: ${price} ${currency}`);
                    return { price, currency };
                }
                
                // å˜—è©¦å¾é é¢æ¨™é¡Œæˆ–å…§å®¹ä¸­æå–åƒ¹æ ¼
                const titleMatch = html.match(/<title[^>]*>([^<]*\$[0-9.]+[^<]*)<\/title>/i);
                if (titleMatch) {
                    const priceMatch3 = titleMatch[1].match(/\$([0-9.]+)/);
                    if (priceMatch3) {
                        const price = parseFloat(priceMatch3[1]);
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`âœ… Google Finance æ¨™é¡Œè§£ææˆåŠŸ: ${price} ${currency}`);
                        return { price, currency };
                    }
                }
                
                throw new Error('ç„¡æ³•å¾ Google Finance è§£æåƒ¹æ ¼æ•¸æ“š');
            }
            
            // Yahoo Finance API
            async tryYahooFinance(stockCode) {
                console.log(`ğŸ“Š Yahoo Finance: ${stockCode}`);
                
                // å˜—è©¦ä¸åŒçš„å¾Œç¶´
                const suffixes = [];
                
                if (/^[A-Za-z]/.test(stockCode)) {
                    suffixes.push(''); // ç¾è‚¡ç„¡å¾Œç¶´
                } else if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                    suffixes.push('.TWO', '.TW'); // å°è‚¡ï¼šå…ˆè©¦ .TWO (ETF/å‚µåˆ¸)ï¼Œå†è©¦ .TW (ä¸€èˆ¬è‚¡ç¥¨)
                } else {
                    suffixes.push('.TWO', '.TW'); // å…¶ä»–æƒ…æ³
                }
                
                for (const suffix of suffixes) {
                    const yahooCode = stockCode + suffix;
                    console.log(`å˜—è©¦ Yahoo Finance: ${stockCode} -> ${yahooCode}`);
                    
                    const proxyServices = [
                        `https://cors-anywhere.herokuapp.com/https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`,
                        `https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`)}`,
                        `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`,
                        `https://thingproxy.freeboard.io/fetch/https://query1.finance.yahoo.com/v8/finance/chart/${yahooCode}`
                    ];
                    
                    for (const proxyUrl of proxyServices) {
                        try {
                            const response = await fetch(proxyUrl);
                            if (!response.ok) continue;
                            
                            let data;
                            if (proxyUrl.includes('allorigins.win')) {
                                const proxyData = await response.json();
                                data = JSON.parse(proxyData.contents);
                            } else {
                                data = await response.json();
                            }
                            
                            if (!data.chart?.result?.[0]) continue;
                            
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            const currentPrice = meta.regularMarketPrice || result.indicators.quote[0].close.slice(-1)[0];
                            const currency = meta.currency || this.getCurrencyByMarket(stockCode);
                            
                            if (currentPrice && currentPrice > 0) {
                                console.log(`âœ… Yahoo Finance æˆåŠŸ: ${yahooCode} = ${currentPrice} ${currency}`);
                                return { price: currentPrice, currency };
                            }
                        } catch (error) {
                            continue;
                        }
                    }
                }
                throw new Error('Yahoo Finance API å¤±æ•—');
            }
            
            // Financial Modeling Prep API (å…è²»ç‰ˆï¼Œç„¡éœ€ API Key)
            async tryFinancialModelingPrep(stockCode) {
                console.log(`ğŸ’° Financial Modeling Prep: ${stockCode}`);
                
                try {
                    // å…è²» APIï¼Œç„¡éœ€ API Key
                    const url = `https://financialmodelingprep.com/api/v3/quote/${stockCode}`;
                    console.log(`FMP URL: ${url}`);
                    
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    console.log(`FMP å›æ‡‰ç‹€æ…‹: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`FMP è«‹æ±‚å¤±æ•—: ${response.status}`);
                    
                    const proxyData = await response.json();
                    console.log(`FMP ä»£ç†å›æ‡‰:`, proxyData);
                    
                    const data = JSON.parse(proxyData.contents);
                    console.log(`FMP è³‡æ–™:`, data);
                    
                    if (data && data.length > 0 && data[0].price) {
                        const price = data[0].price;
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`FMP æˆåŠŸ: ${stockCode} = ${price} ${currency}`);
                        return { price, currency };
                    } else {
                        throw new Error('FMP ç„¡æœ‰æ•ˆåƒ¹æ ¼è³‡æ–™');
                    }
                } catch (error) {
                    console.error(`FMP éŒ¯èª¤:`, error.message);
                    throw new Error(`Financial Modeling Prep API å¤±æ•—: ${error.message}`);
                }
            }
            
            // MarketStack API (å…è²»ç‰ˆï¼Œç„¡éœ€ API Key)
            async tryMarketStack(stockCode) {
                console.log(`ğŸ“Š MarketStack: ${stockCode}`);
                
                try {
                    // å…è²» APIï¼Œç„¡éœ€ API Key
                    const url = `http://api.marketstack.com/v1/eod/latest?access_key=free&symbols=${stockCode}`;
                    console.log(`MarketStack URL: ${url}`);
                    
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    console.log(`MarketStack å›æ‡‰ç‹€æ…‹: ${response.status}`);
                    
                    if (!response.ok) throw new Error(`MarketStack è«‹æ±‚å¤±æ•—: ${response.status}`);
                    
                    const proxyData = await response.json();
                    console.log(`MarketStack ä»£ç†å›æ‡‰:`, proxyData);
                    
                    const data = JSON.parse(proxyData.contents);
                    console.log(`MarketStack è³‡æ–™:`, data);
                    
                    if (data.data && data.data.length > 0 && data.data[0].close) {
                        const price = data.data[0].close;
                        const currency = this.getCurrencyByMarket(stockCode);
                        console.log(`MarketStack æˆåŠŸ: ${stockCode} = ${price} ${currency}`);
                        return { price, currency };
                    } else {
                        throw new Error('MarketStack ç„¡æœ‰æ•ˆåƒ¹æ ¼è³‡æ–™');
                    }
                } catch (error) {
                    console.error(`MarketStack éŒ¯èª¤:`, error.message);
                    throw new Error(`MarketStack API å¤±æ•—: ${error.message}`);
                }
            }
            
            // Alpha Vantage API (éœ€è¦ API Key)
            async tryAlphaVantage(stockCode) {
                console.log(`ğŸ“ˆ Alpha Vantage: ${stockCode} (éœ€è¦ API Key)`);
                throw new Error('Alpha Vantage éœ€è¦ API Keyï¼Œè«‹ç”³è«‹å¾Œä½¿ç”¨');
            }
            
            // IEX Cloud API (éœ€è¦ API Token)
            async tryIEXCloud(stockCode) {
                console.log(`ğŸ¦ IEX Cloud: ${stockCode} (éœ€è¦ API Token)`);
                throw new Error('IEX Cloud éœ€è¦ API Tokenï¼Œè«‹ç”³è«‹å¾Œä½¿ç”¨');
            }
            
            
            // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼åˆ¤æ–·å¹£åˆ¥
            getCurrencyByMarket(stockCode) {
                // ç¾è‚¡ï¼šç¬¬ä¸€ç¢¼ç‚ºè‹±æ–‡å­—æ¯
                if (/^[A-Za-z]/.test(stockCode)) {
                    return 'USD';
                }
                // å°è‚¡ï¼š4ä½æ•¸å­— æˆ– 4ä½æ•¸å­—+å­—æ¯ï¼ˆå¦‚00937Bï¼‰
                else if (/^\d{4}[A-Za-z]?$/.test(stockCode)) {
                    return 'TWD';
                }
                // å…¶ä»–æƒ…æ³é è¨­ç‚ºå°å¹£
                else {
                    return 'TWD';
                }
            }
            
            // å›ºå®šåƒ¹æ ¼å‚™ç”¨æ–¹æ¡ˆ
            getFixedPrice(stockCode) {
                // ä¸å†æä¾›å›ºå®šåƒ¹æ ¼ï¼Œç›´æ¥æ‹‹å‡ºéŒ¯èª¤
                throw new Error(`ç„¡æ³•å–å¾— ${stockCode} çš„åƒ¹æ ¼è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç•¶å‰åƒ¹æ ¼`);
            }
            
            // æ›´æ–°å–®ä¸€è³‡ç”¢çš„ç•¶å‰åƒ¹æ ¼
            async updateCurrentPrice(assetId) {
                console.log('ğŸ”„ updateCurrentPrice è¢«èª¿ç”¨ï¼ŒassetId:', assetId, 'é¡å‹:', typeof assetId);
                console.log('ğŸ“Š ç•¶å‰è³‡ç”¢åˆ—è¡¨:', this.assets.map(a => ({ id: a.id, idType: typeof a.id, name: a.name, stockCode: a.stockCode })));
                
                // å°‡ assetId è½‰æ›ç‚ºèˆ‡è³‡ç”¢ ID ç›¸åŒçš„é¡å‹é€²è¡Œæ¯”è¼ƒ
                const assetIdNum = typeof assetId === 'string' ? parseInt(assetId) : assetId;
                const asset = this.assets.find(a => {
                    // æ”¯æ´æ•¸å­—å’Œå­—ç¬¦ä¸²é¡å‹çš„ ID æ¯”è¼ƒ
                    const match = a.id === assetId || a.id === assetIdNum || String(a.id) === String(assetId);
                    if (match) {
                        console.log('âœ… æ‰¾åˆ°åŒ¹é…çš„è³‡ç”¢:', { assetId: a.id, name: a.name, stockCode: a.stockCode });
                    }
                    return match;
                });
                if (!asset) {
                    console.error('âŒ æ‰¾ä¸åˆ°è³‡ç”¢ï¼ŒassetId:', assetId, 'assetIdé¡å‹:', typeof assetId);
                    console.error('æ‰€æœ‰å¯ç”¨è³‡ç”¢ID:', this.assets.map(a => ({ id: a.id, idType: typeof a.id, name: a.name })));
                    this.showNotification(`æ‰¾ä¸åˆ°å°æ‡‰çš„è³‡ç”¢ (ID: ${assetId})`, 'error');
                    return;
                }
                
                if (asset.type !== 'è‚¡ç¥¨') {
                    this.showNotification('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼è‚¡ç¥¨', 'warning');
                    return;
                }
                
                if (!asset.stockCode) {
                    this.showNotification('æ­¤è‚¡ç¥¨æ²’æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼Œç„¡æ³•è‡ªå‹•æ›´æ–°åƒ¹æ ¼', 'warning');
                    return;
                }
                
                // æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦é¡¯ç¤º loading ç‹€æ…‹
                const updateBtn = document.querySelector(`[data-update-price="${assetId}"], [data-asset-id="${assetId}"]`);
                let originalButtonContent = '';
                if (updateBtn) {
                    originalButtonContent = updateBtn.innerHTML;
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = 'ğŸ”„ å–å¾—ä¸­...';
                    updateBtn.style.opacity = '0.6';
                    updateBtn.style.cursor = 'not-allowed';
                    updateBtn.style.backgroundColor = '#f0f0f0';
                    updateBtn.style.color = '#999';
                }
                
                try {
                    console.log(`ğŸ”„ é–‹å§‹æ›´æ–° ${asset.stockCode} (${asset.name}) çš„åƒ¹æ ¼...`);
                    console.log('ğŸ“‹ æ›´æ–°å‰çš„è³‡ç”¢è³‡æ–™:', {
                        id: asset.id,
                        quantity: asset.quantity,
                        cost: asset.cost,
                        currentPrice: asset.currentPrice
                    });
                    
                    // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼å–å¾—æœ€æ–°åƒ¹æ ¼
                    const stockData = await this.getStockPrice(asset.stockCode);
                    
                    // åªæ›´æ–° currentPriceï¼Œæ˜ç¢ºä¸åŒ…å«å…¶ä»–æ¬„ä½
                    const updateData = {
                        currentPrice: stockData.price
                    };
                    console.log('ğŸ“¤ æº–å‚™æ›´æ–°çš„è³‡æ–™:', updateData);
                    
                    const updatedAsset = await window.apiService.updateAsset(assetId, updateData);
                    console.log('ğŸ“¥ æ›´æ–°å¾Œçš„è³‡ç”¢è³‡æ–™:', {
                        id: updatedAsset.id,
                        quantity: updatedAsset.quantity,
                        cost: updatedAsset.cost,
                        currentPrice: updatedAsset.currentPrice
                    });
                    
                    console.log(`âœ… æ›´æ–° ${asset.stockCode} (${asset.name}) åƒ¹æ ¼: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                    this.showNotification(`${asset.stockCode} (${asset.name}) åƒ¹æ ¼å·²æ›´æ–°ç‚º ${stockData.price.toFixed(2)} ${stockData.currency}`, 'success');
                    
                    // é‡æ–°è¼‰å…¥è³‡ç”¢
                    await this.loadAssets();
                    
                } catch (error) {
                    console.error('âŒ æ›´æ–°åƒ¹æ ¼å¤±æ•—:', error);
                    this.showNotification(`æ›´æ–°åƒ¹æ ¼å¤±æ•—: ${error.message}`, 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    if (updateBtn) {
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = originalButtonContent;
                        updateBtn.style.opacity = '1';
                        updateBtn.style.cursor = 'pointer';
                        updateBtn.style.backgroundColor = '';
                        updateBtn.style.color = '';
                    }
                }
            }

            // æ›´æ–°æ‰€æœ‰è‚¡åƒ¹
            async updateAllStockPrices() {
                const stockAssets = this.assets.filter(asset => 
                    asset.type === 'è‚¡ç¥¨' && asset.stockCode
                );
                
                if (stockAssets.length === 0) {
                    this.showNotification('æ²’æœ‰æ‰¾åˆ°å¯æ›´æ–°çš„è‚¡ç¥¨', 'warning');
                    return;
                }
                
                // é¡¯ç¤º loading æ¨¡æ…‹æ¡†
                this.showUpdateStocksLoading(stockAssets);
                
                let successCount = 0;
                let failCount = 0;
                
                try {
                    console.log(`ğŸ”„ é–‹å§‹æ‰¹é‡æ›´æ–° ${stockAssets.length} æ”¯è‚¡ç¥¨...`);
                    
                    for (let i = 0; i < stockAssets.length; i++) {
                        const asset = stockAssets[i];
                        
                        // æ›´æ–°é€²åº¦æ¢
                        const progress = ((i + 1) / stockAssets.length) * 100;
                        this.updateProgress(progress, `æ­£åœ¨æ›´æ–° ${asset.name} (${asset.stockCode})...`);
                        
                        // æ›´æ–°è‚¡ç¥¨ç‹€æ…‹ç‚ºã€Œæ›´æ–°ä¸­ã€
                        this.updateStockStatus(asset.id, 'updating', `æ­£åœ¨å–å¾—åƒ¹æ ¼...`);
                        
                        try {
                            console.log(`ğŸ”„ æ­£åœ¨æ›´æ–° ${asset.stockCode} (${asset.name})...`);
                            
                            // æ›´æ–°ç‹€æ…‹ç‚ºæ­£åœ¨å˜—è©¦
                            this.updateStockStatus(asset.id, 'updating', `å˜—è©¦å–å¾—åƒ¹æ ¼...`);
                            
                            // æ ¹æ“šè‚¡ç¥¨ä»£ç¢¼å–å¾—æœ€æ–°åƒ¹æ ¼
                            const stockData = await this.getStockPriceWithProgress(asset.stockCode, asset.id);
                            
                            // æ›´æ–°ç‹€æ…‹ç‚ºæ­£åœ¨å„²å­˜
                            this.updateStockStatus(asset.id, 'updating', `æ­£åœ¨å„²å­˜è³‡æ–™...`);
                            
                            await window.apiService.updateAsset(asset.id, {
                                currentPrice: stockData.price
                            });
                            
                            successCount++;
                            this.updateStockStatus(asset.id, 'success', `æˆåŠŸ: ${stockData.price.toFixed(2)} ${stockData.currency}`);
                            console.log(`âœ… æ›´æ–° ${asset.stockCode} æˆåŠŸ`);
                            
                        } catch (error) {
                            failCount++;
                            this.updateStockStatus(asset.id, 'fail', `å¤±æ•—: ${error.message}`);
                            console.error(`âŒ æ›´æ–° ${asset.stockCode} å¤±æ•—:`, error.message);
                        }
                        
                        // æ›´æ–°é€²åº¦æ¨™ç±¤
                        this.updateProgressBadge(successCount + failCount, stockAssets.length);
                        
                        // æ·»åŠ å°å»¶é²é¿å… API é™åˆ¶
                        if (i < stockAssets.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    // æ›´æ–°å®Œæˆ
                    this.updateProgress(100, 'æ›´æ–°å®Œæˆï¼');
                    this.showUpdateResultInTitle(successCount, failCount);
                    
                    // é‡æ–°è¼‰å…¥è³‡ç”¢
                    await this.loadAssets();
                    
                } catch (error) {
                    console.error('âŒ æ‰¹é‡æ›´æ–°å¤±æ•—:', error);
                    this.updateProgress(0, 'æ›´æ–°å¤±æ•—');
                }
            }

            // å¸¶é€²åº¦é¡¯ç¤ºçš„è‚¡ç¥¨åƒ¹æ ¼å–å¾—
            async getStockPriceWithProgress(stockCode, assetId) {
                try {
                    // å˜—è©¦å–å¾—çœŸå¯¦è‚¡ç¥¨åƒ¹æ ¼
                    const realPrice = await this.fetchRealStockPriceWithProgress(stockCode, assetId);
                    if (realPrice) {
                        console.log(`å–å¾— ${stockCode} çœŸå¯¦åƒ¹æ ¼: ${realPrice.price.toFixed(2)} ${realPrice.currency}`);
                        return realPrice;
                    }
                } catch (error) {
                    console.warn(`å–å¾— ${stockCode} çœŸå¯¦åƒ¹æ ¼å¤±æ•—:`, error.message);
                }
                
                // å¦‚æœçœŸå¯¦ API å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤è€Œä¸æ˜¯ä½¿ç”¨å›ºå®šåƒ¹æ ¼
                throw new Error(`ç„¡æ³•å–å¾— ${stockCode} çš„åƒ¹æ ¼è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ç•¶å‰åƒ¹æ ¼`);
            }

            // å¸¶é€²åº¦é¡¯ç¤ºçš„çœŸå¯¦è‚¡ç¥¨åƒ¹æ ¼å–å¾—
            async fetchRealStockPriceWithProgress(stockCode, assetId) {
                console.log(`ğŸ” é–‹å§‹æŸ¥è©¢ ${stockCode} çš„åƒ¹æ ¼...`);
                
                // å„ªå…ˆä½¿ç”¨ Yahoo Finance API
                try {
                    this.updateStockStatus(assetId, 'updating', 'å˜—è©¦ Yahoo Finance API');
                    console.log(`å˜—è©¦ Yahoo Finance API`);
                    const result = await this.tryYahooFinance(stockCode);
                    if (result) {
                        console.log(`âœ… Yahoo Finance æˆåŠŸ: ${stockCode} = ${result.price} ${result.currency}`);
                        return result;
                    }
                } catch (error) {
                    console.warn(`âŒ Yahoo Finance å¤±æ•—:`, error.message);
                }
                
                // å‚™ç”¨ API
                const apis = [
                    () => this.tryYahooFinance(stockCode),
                    () => this.tryFinancialModelingPrep(stockCode),
                    () => this.tryMarketStack(stockCode),
                    () => this.tryAlphaVantage(stockCode),
                    () => this.tryIEXCloud(stockCode)
                ];
                
                for (let i = 0; i < apis.length; i++) {
                    try {
                        // æ›´æ–°ç‹€æ…‹é¡¯ç¤ºå˜—è©¦æ¬¡æ•¸
                        this.updateStockStatus(assetId, 'updating', `ç¬¬ ${i + 1} æ¬¡å˜—è©¦ (å‚™ç”¨ API ${i + 1}/${apis.length})`);
                        
                        console.log(`å˜—è©¦å‚™ç”¨ API ${i + 1}/${apis.length}`);
                        const result = await apis[i]();
                        if (result) {
                            console.log(`âœ… å‚™ç”¨ API ${i + 1} æˆåŠŸ: ${stockCode} = ${result.price} ${result.currency}`);
                            return result;
                        }
                    } catch (error) {
                        console.warn(`âŒ å‚™ç”¨ API ${i + 1} å¤±æ•—:`, error.message);
                        if (i === apis.length - 1) {
                            throw new Error(`æ‰€æœ‰ API éƒ½å¤±æ•—: ${error.message}`);
                        }
                        continue;
                    }
                }
            }

            // é¡¯ç¤ºæ›´æ–°è‚¡åƒ¹ Loading æ¨¡æ…‹æ¡†
            showUpdateStocksLoading(stockAssets) {
                const modal = document.getElementById('updateStocksLoadingModal');
                if (!modal) return;
                
                // é‡ç½®ç‹€æ…‹
                document.getElementById('updateProgressFill').style.width = '0%';
                document.getElementById('updateProgressText').textContent = 'æº–å‚™ä¸­...';
                document.getElementById('updateProgressBadge').style.display = 'none';
                document.getElementById('updateResultBadge').style.display = 'none';
                
                // åˆå§‹åŒ–é€²åº¦æ¨™ç±¤
                this.updateProgressBadge(0, stockAssets.length);
                
                // ç”Ÿæˆè‚¡ç¥¨åˆ—è¡¨
                const stocksList = document.getElementById('stocksUpdateList');
                stocksList.innerHTML = stockAssets.map(asset => `
                    <div class="stock-update-item" id="stock-${asset.id}">
                        <div class="stock-info">
                            <div class="stock-name">${asset.name}</div>
                            <div class="stock-code">${asset.stockCode}</div>
                        </div>
                        <div class="update-status status-updating">ç­‰å¾…ä¸­...</div>
                    </div>
                `).join('');
                
                modal.style.display = 'block';
            }

            // éš±è—æ›´æ–°è‚¡åƒ¹ Loading æ¨¡æ…‹æ¡†
            hideUpdateStocksLoading() {
                const modal = document.getElementById('updateStocksLoadingModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // æ›´æ–°é€²åº¦æ¢
            updateProgress(percentage, text) {
                const progressFill = document.getElementById('updateProgressFill');
                const progressText = document.getElementById('updateProgressText');
                
                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }
                if (progressText) {
                    progressText.textContent = text;
                }
            }

            // æ›´æ–°è‚¡ç¥¨ç‹€æ…‹
            updateStockStatus(assetId, status, message) {
                const stockItem = document.getElementById(`stock-${assetId}`);
                if (!stockItem) return;
                
                // ç§»é™¤æ‰€æœ‰ç‹€æ…‹é¡åˆ¥
                stockItem.classList.remove('updating', 'success', 'fail');
                
                // æ·»åŠ æ–°çš„ç‹€æ…‹é¡åˆ¥
                stockItem.classList.add(status);
                
                // æ›´æ–°ç‹€æ…‹æ–‡å­—
                const statusElement = stockItem.querySelector('.update-status');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `update-status status-${status}`;
                }
            }

            // æ›´æ–°é€²åº¦æ¨™ç±¤
            updateProgressBadge(current, total) {
                const progressBadge = document.getElementById('updateProgressBadge');
                if (progressBadge) {
                    progressBadge.style.display = 'inline-block';
                    progressBadge.innerHTML = `${current}/${total}`;
                    
                    // æ ¹æ“šé€²åº¦è¨­ç½®ä¸åŒçš„èƒŒæ™¯è‰²
                    const percentage = (current / total) * 100;
                    if (percentage === 0) {
                        progressBadge.style.background = 'rgba(255,255,255,0.2)'; // åˆå§‹ç‹€æ…‹
                    } else if (percentage < 50) {
                        progressBadge.style.background = 'rgba(255, 193, 7, 0.8)'; // é»ƒè‰²
                    } else if (percentage < 100) {
                        progressBadge.style.background = 'rgba(0, 123, 255, 0.8)'; // è—è‰²
                    } else {
                        progressBadge.style.background = 'rgba(40, 167, 69, 0.8)'; // ç¶ è‰²
                    }
                }
            }

            // åœ¨æ¨™é¡Œä¸­é¡¯ç¤ºæ›´æ–°çµæœ
            showUpdateResultInTitle(successCount, failCount) {
                const resultBadge = document.getElementById('updateResultBadge');
                if (resultBadge) {
                    resultBadge.style.display = 'inline-block';
                    resultBadge.innerHTML = `âœ… ${successCount} æˆåŠŸ âŒ ${failCount} å¤±æ•—`;
                    
                    // æ ¹æ“šçµæœè¨­ç½®ä¸åŒçš„èƒŒæ™¯è‰²
                    if (failCount === 0) {
                        resultBadge.style.background = 'rgba(40, 167, 69, 0.8)'; // ç¶ è‰²
                    } else if (successCount === 0) {
                        resultBadge.style.background = 'rgba(220, 53, 69, 0.8)'; // ç´…è‰²
                    } else {
                        resultBadge.style.background = 'rgba(255, 193, 7, 0.8)'; // é»ƒè‰²
                    }
                }
            }

            // æ›´æ–°åœ–è¡¨
            async updateCharts() {
                const chartTypeFilter = document.getElementById('chartFilterType')?.value || '';
                const chartYearFilter = document.getElementById('chartFilterYear')?.value || '';
                const chartMonthFilter = document.getElementById('chartFilterMonth')?.value || '';
                const chartMemberFilter = document.getElementById('chartFilterMember')?.value || '';
                
                console.log('æ›´æ–°åœ–è¡¨ - ç¯©é¸æ¢ä»¶:', { chartTypeFilter, chartYearFilter, chartMonthFilter, chartMemberFilter });
                console.log('ç•¶å‰è³‡ç”¢æ•¸é‡:', this.assets.length);
                console.log('ç•¶å‰è¨˜éŒ„æ•¸é‡:', this.records.length);
                
                // æª¢æŸ¥å¹´ä»½ç¯©é¸å™¨æ˜¯å¦æœ‰å€¼ï¼ˆæœˆä»½å¯ä»¥ç‚ºç©ºï¼Œè¡¨ç¤ºæ•´å¹´ï¼‰
                if (!chartYearFilter) {
                    console.error('å¹´ä»½ç¯©é¸å™¨æ²’æœ‰å€¼:', { chartYearFilter });
                    return;
                }
                
                // æ ¹æ“šåœ–è¡¨ç¯©é¸å™¨éæ¿¾è¨˜éŒ„
                const filteredRecords = this.records.filter(record => {
                    const recordDate = new Date(record.date);
                    const recordYear = recordDate.getFullYear().toString();
                    const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                    
                    // é¡å‹ç¯©é¸
                    const matchesType = !chartTypeFilter || record.type === chartTypeFilter;
                    
                    // å¹´ä»½ç¯©é¸
                    const matchesYear = recordYear === chartYearFilter;
                    
                    // æœˆä»½ç¯©é¸ï¼šå¦‚æœ chartMonthFilter ç‚ºç©ºæˆ–ã€Œæ•´å¹´ã€ï¼Œå‰‡ä¸ç¯©é¸æœˆä»½
                    const matchesMonth = !chartMonthFilter || recordMonth === chartMonthFilter;
                    
                    // æˆå“¡ç¯©é¸
                    const matchesMember = !chartMemberFilter || record.member === chartMemberFilter;

                    return matchesType && matchesYear && matchesMonth && matchesMember;
                });
                
                console.log('ç¯©é¸å¾Œçš„è¨˜éŒ„æ•¸é‡:', filteredRecords.length);
                console.log('ç¯©é¸å¾Œçš„è¨˜éŒ„:', filteredRecords);
                
                // æ§åˆ¶åœ–è¡¨é¡¯ç¤º/éš±è—
                this.toggleChartSections(chartTypeFilter);
                
                // åˆ†åˆ¥è™•ç†æ”¶å…¥ã€æ”¯å‡ºå’Œè³‡ç”¢çš„æ•¸æ“š
                const incomeRecords = filteredRecords.filter(r => r.type === 'æ”¶å…¥');
                const expenseRecords = filteredRecords.filter(r => r.type === 'æ”¯å‡º');
                const assetRecords = filteredRecords.filter(r => r.type === 'è³‡ç”¢');
                
                // æ›´æ–°æ”¯å‡ºé¡åˆ¥åœ–è¡¨
                const expenseCategoryData = this.getCategoryData(expenseRecords);
                this.expenseCategoryChart.data.labels = expenseCategoryData.labels;
                this.expenseCategoryChart.data.datasets[0].data = expenseCategoryData.data;
                
                // å¦‚æœæ²’æœ‰æ”¯å‡ºè³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
                if (expenseCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter, chartMemberFilter);
                    this.expenseCategoryChart.data.labels = [`${filterText}æš«ç„¡æ”¯å‡ºè³‡æ–™`];
                    this.expenseCategoryChart.data.datasets[0].data = [1];
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // æ¢å¾©åŸå§‹é¡è‰²
                    this.expenseCategoryChart.data.datasets[0].backgroundColor = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56', '#9966FF'
                    ];
                }
                
                this.expenseCategoryChart.update();

                // æ›´æ–°æ”¯å‡ºæˆå“¡åœ–è¡¨
                const expenseMemberData = this.getMemberData(expenseRecords);
                this.expenseMemberChart.data.labels = expenseMemberData.labels;
                this.expenseMemberChart.data.datasets[0].data = expenseMemberData.data;
                
                // å¦‚æœæ²’æœ‰æ”¯å‡ºè³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
                if (expenseMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter, chartMemberFilter);
                    this.expenseMemberChart.data.labels = [`${filterText}æš«ç„¡æ”¯å‡ºè³‡æ–™`];
                    this.expenseMemberChart.data.datasets[0].data = [1];
                    this.expenseMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // æ¢å¾©åŸå§‹é¡è‰²
                    this.expenseMemberChart.data.datasets[0].backgroundColor = [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c'
                    ];
                }
                
                this.expenseMemberChart.update();

                // æ›´æ–°æ”¶å…¥é¡åˆ¥åœ–è¡¨
                const incomeCategoryData = this.getCategoryData(incomeRecords);
                this.incomeCategoryChart.data.labels = incomeCategoryData.labels;
                this.incomeCategoryChart.data.datasets[0].data = incomeCategoryData.data;
                
                // å¦‚æœæ²’æœ‰æ”¶å…¥è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
                if (incomeCategoryData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter, chartMemberFilter);
                    this.incomeCategoryChart.data.labels = [`${filterText}æš«ç„¡æ”¶å…¥è³‡æ–™`];
                    this.incomeCategoryChart.data.datasets[0].data = [1];
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // æ¢å¾©åŸå§‹é¡è‰²
                    this.incomeCategoryChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#27ae60', '#2ecc71'
                    ];
                }
                
                this.incomeCategoryChart.update();

                // æ›´æ–°æ”¶å…¥æˆå“¡åœ–è¡¨
                const incomeMemberData = this.getMemberData(incomeRecords);
                this.incomeMemberChart.data.labels = incomeMemberData.labels;
                this.incomeMemberChart.data.datasets[0].data = incomeMemberData.data;
                
                // å¦‚æœæ²’æœ‰æ”¶å…¥è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
                if (incomeMemberData.labels.length === 0) {
                    const filterText = this.getFilterText(chartTypeFilter, chartYearFilter, chartMonthFilter, chartMemberFilter);
                    this.incomeMemberChart.data.labels = [`${filterText}æš«ç„¡æ”¶å…¥è³‡æ–™`];
                    this.incomeMemberChart.data.datasets[0].data = [1];
                    this.incomeMemberChart.data.datasets[0].backgroundColor = ['#e0e0e0'];
                } else {
                    // æ¢å¾©åŸå§‹é¡è‰²
                    this.incomeMemberChart.data.datasets[0].backgroundColor = [
                        '#27ae60', '#2ecc71', '#16a085', '#1abc9c'
                    ];
                }
                
                this.incomeMemberChart.update();

                // è³‡ç”¢åœ“é¤…åœ–å·²éš±è—ï¼Œåœæ­¢è³‡æ–™è®€å–ä»¥æå‡æ•ˆèƒ½
                console.log('è³‡ç”¢åœ“é¤…åœ–å·²éš±è—ï¼Œè·³éè³‡æ–™è®€å–');
            }

            // ç²å–è³‡ç”¢é¡åˆ¥è³‡æ–™ï¼ˆå¾è³‡ç”¢çµ„åˆç®¡ç†ï¼‰
            async getAssetCategoryData() {
                console.log('getAssetCategoryData - è³‡ç”¢æ•¸é‡:', this.assets.length);
                console.log('getAssetCategoryData - è³‡ç”¢è³‡æ–™:', this.assets);
                
                if (this.assets.length === 0) {
                    console.log('æ²’æœ‰è³‡ç”¢è³‡æ–™ï¼Œè¿”å›ç©ºé™£åˆ—');
                    return { labels: [], data: [] };
                }

                const categoryMap = new Map();
                
                for (const asset of this.assets) {
                    const quantity = parseFloat(asset.quantity) || 0;
                    const currentPrice = parseFloat(asset.currentPrice) || parseFloat(asset.purchasePrice) || parseFloat(asset.unitPrice) || 0;
                    const currentValue = quantity * currentPrice;
                    
                    // è½‰æ›ç‚ºå°å¹£
                    const currentValueTWD = await this.convertToTWD(currentValue, asset.currency);
                    
                    const category = asset.type || 'å…¶ä»–';
                    console.log(`è³‡ç”¢: ${asset.name}, é¡åˆ¥: ${category}, åƒ¹å€¼: ${currentValueTWD}`);
                    
                    if (categoryMap.has(category)) {
                        categoryMap.set(category, categoryMap.get(category) + currentValueTWD);
                    } else {
                        categoryMap.set(category, currentValueTWD);
                    }
                }

                const labels = Array.from(categoryMap.keys());
                const data = Array.from(categoryMap.values());
                
                console.log('è³‡ç”¢é¡åˆ¥è³‡æ–™:', { labels, data });
                return { labels, data };
            }

            // ç²å–è³‡ç”¢æˆå“¡è³‡æ–™ï¼ˆå¾è³‡ç”¢çµ„åˆç®¡ç†ï¼‰
            async getAssetMemberData() {
                console.log('getAssetMemberData - è³‡ç”¢æ•¸é‡:', this.assets.length);
                
                if (this.assets.length === 0) {
                    console.log('æ²’æœ‰è³‡ç”¢è³‡æ–™ï¼Œè¿”å›ç©ºé™£åˆ—');
                    return { labels: [], data: [] };
                }

                const memberMap = new Map();
                
                for (const asset of this.assets) {
                    const quantity = parseFloat(asset.quantity) || 0;
                    const currentPrice = parseFloat(asset.currentPrice) || parseFloat(asset.purchasePrice) || parseFloat(asset.unitPrice) || 0;
                    const currentValue = quantity * currentPrice;
                    
                    // è½‰æ›ç‚ºå°å¹£
                    const currentValueTWD = await this.convertToTWD(currentValue, asset.currency);
                    
                    const member = asset.member || 'æœªæŒ‡å®š';
                    console.log(`è³‡ç”¢: ${asset.name}, æˆå“¡: ${member}, åƒ¹å€¼: ${currentValueTWD}`);
                    
                    if (memberMap.has(member)) {
                        memberMap.set(member, memberMap.get(member) + currentValueTWD);
                    } else {
                        memberMap.set(member, currentValueTWD);
                    }
                }

                const labels = Array.from(memberMap.keys());
                const data = Array.from(memberMap.values());
                
                console.log('è³‡ç”¢æˆå“¡è³‡æ–™:', { labels, data });
                return { labels, data };
            }

            // æ§åˆ¶åœ–è¡¨å€åŸŸé¡¯ç¤º/éš±è—
            toggleChartSections(typeFilter) {
                // æ§åˆ¶æ”¯å‡ºçµ±è¨ˆå€åŸŸ
                const expenseTitle = document.querySelector('.expense-section-title');
                const expenseSection = document.querySelector('.expense-section');
                if (expenseTitle && expenseSection) {
                    const showExpense = !typeFilter || typeFilter === 'æ”¯å‡º';
                    expenseTitle.style.display = showExpense ? 'block' : 'none';
                    expenseSection.style.display = showExpense ? 'flex' : 'none';
                }
                
                // æ§åˆ¶æ”¶å…¥çµ±è¨ˆå€åŸŸ
                const incomeTitle = document.querySelector('.income-section-title');
                const incomeSection = document.querySelector('.income-section');
                if (incomeTitle && incomeSection) {
                    const showIncome = !typeFilter || typeFilter === 'æ”¶å…¥';
                    incomeTitle.style.display = showIncome ? 'block' : 'none';
                    incomeSection.style.display = showIncome ? 'flex' : 'none';
                }
                
                // æ§åˆ¶è³‡ç”¢çµ±è¨ˆå€åŸŸï¼ˆå·²éš±è—ï¼‰
                const assetTitle = document.querySelector('.asset-section-title');
                const assetSection = document.querySelector('.asset-section');
                if (assetTitle && assetSection) {
                    // è³‡ç”¢åœ“é¤…åœ–å·²éš±è—ï¼Œå§‹çµ‚ä¿æŒéš±è—ç‹€æ…‹
                    assetTitle.style.display = 'none';
                    assetSection.style.display = 'none';
                }
            }

            // ç²å–ç¯©é¸æ–‡å­—
            getFilterText(typeFilter, yearFilter, monthFilter, memberFilter) {
                let text = '';
                if (typeFilter) text += `${typeFilter} `;
                if (yearFilter) text += `${yearFilter}å¹´ `;
                if (monthFilter) {
                    const monthNames = ['', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    text += `${monthNames[parseInt(monthFilter)]} `;
                }
                if (memberFilter) text += `${memberFilter} `;
                return text;
            }

            // ç²å–é¡åˆ¥æ•¸æ“š
            getCategoryData(records) {
                const categoryMap = {};

                records.forEach(record => {
                    const categoryKey = record.mainCategory || 'æœªåˆ†é¡';
                    categoryMap[categoryKey] = (categoryMap[categoryKey] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(categoryMap),
                    data: Object.values(categoryMap)
                };
            }

            // ç²å–æˆå“¡æ•¸æ“š
            getMemberData(records) {
                const memberMap = {};
                records.forEach(record => {
                    memberMap[record.member] = (memberMap[record.member] || 0) + record.amount;
                });

                return {
                    labels: Object.keys(memberMap),
                    data: Object.values(memberMap)
                };
            }

            // åˆå§‹åŒ–åœ–è¡¨
            initCharts() {
                console.log('åˆå§‹åŒ–åœ–è¡¨');
                
                // æ”¯å‡ºé¡åˆ¥åœ“é¤…åœ–
                this.expenseCategoryChart = new Chart(document.getElementById('expenseCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF',
                                '#FF9F40',
                                '#C9CBCF',
                                '#4BC0C0',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // æ”¯å‡ºæˆå“¡åœ“é¤…åœ–
                this.expenseMemberChart = new Chart(document.getElementById('expenseMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#f093fb',
                                '#f5576c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // æ”¶å…¥é¡åˆ¥åœ“é¤…åœ–
                this.incomeCategoryChart = new Chart(document.getElementById('incomeCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c',
                                '#27ae60',
                                '#2ecc71'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // æ”¶å…¥æˆå“¡åœ“é¤…åœ–
                this.incomeMemberChart = new Chart(document.getElementById('incomeMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#27ae60',
                                '#2ecc71',
                                '#16a085',
                                '#1abc9c'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // è³‡ç”¢é¡åˆ¥åœ“é¤…åœ–
                this.assetCategoryChart = new Chart(document.getElementById('assetCategoryChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b',
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#e74c3c',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // è³‡ç”¢æˆå“¡åœ“é¤…åœ–
                this.assetMemberChart = new Chart(document.getElementById('assetMemberChart'), {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#f39c12',
                                '#e67e22',
                                '#d35400',
                                '#c0392b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: $${expenseTracker.formatNumber(value)} (TWD) (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨
            initFormEventListeners() {
                console.log('åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨');
                
                // è¡¨å–®æäº¤äº‹ä»¶
                document.getElementById('recordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addRecord();
                });
                
                // æ–°å¢è³‡ç”¢è¡¨å–®äº‹ä»¶ç›£è½å™¨
                document.getElementById('addAssetForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAsset();
                });
                
                // ç›£è½è‚¡æ•¸å’Œç¸½æˆæœ¬è®Šæ›´ï¼Œè‡ªå‹•è¨ˆç®—è³¼è²·å¹³å‡æˆæœ¬åƒ¹
                document.getElementById('assetQuantity').addEventListener('input', this.calculateUnitPrice.bind(this));
                document.getElementById('assetCost').addEventListener('input', this.calculateUnitPrice.bind(this));
                
                // å¹£åˆ¥é¸æ“‡è®ŠåŒ–æ™‚é¡¯ç¤º/éš±è—åŒ¯ç‡æ¬„ä½
                document.getElementById('currency').addEventListener('change', async (e) => {
                    const currency = e.target.value;
                    const exchangeRateGroup = document.getElementById('exchangeRateGroup');
                    const exchangeRateInput = document.getElementById('exchangeRate');
                    const refreshBtn = document.getElementById('refreshRateBtn');
                    
                    if (currency === 'TWD') {
                        exchangeRateGroup.style.display = 'none';
                    } else {
                        exchangeRateGroup.style.display = 'block';
                        
                        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                        exchangeRateInput.value = '';
                        exchangeRateInput.placeholder = 'æ­£åœ¨å–å¾—åŒ¯ç‡...';
                        refreshBtn.disabled = true;
                        refreshBtn.textContent = 'ğŸ”„ å–å¾—ä¸­...';
                        
                        try {
                            // è‡ªå‹•å–å¾—ç•¶å‰åŒ¯ç‡
                            const rate = await this.fetchExchangeRateFromAPI(currency);
                            exchangeRateInput.value = rate;
                            exchangeRateInput.placeholder = 'åŒ¯ç‡å·²æ›´æ–°';
                            
                            // æ›´æ–°æœ¬åœ°åŒ¯ç‡å¿«å–
                            this.exchangeRates[currency] = rate;
                            
                            console.log(`å·²å–å¾— ${currency} åŒ¯ç‡: ${rate}`);
                        } catch (error) {
                            console.error('å–å¾—åŒ¯ç‡å¤±æ•—:', error);
                            exchangeRateInput.value = this.exchangeRates[currency] || 1;
                            exchangeRateInput.placeholder = 'ä½¿ç”¨å¿«å–åŒ¯ç‡';
                            this.showNotification(`ç„¡æ³•å–å¾— ${currency} æœ€æ–°åŒ¯ç‡ï¼Œå·²ä½¿ç”¨å¿«å–æ•¸æ“š`, 'warning');
                        } finally {
                            refreshBtn.disabled = false;
                            refreshBtn.textContent = 'ğŸ”„ æ›´æ–°åŒ¯ç‡';
                        }
                    }
                });
                
                // è³‡ç”¢é¡å‹é¸æ“‡è®ŠåŒ–æ™‚é¡¯ç¤º/éš±è—ç›¸é—œæ¬„ä½
                document.getElementById('assetType').addEventListener('change', (e) => {
                    const assetType = e.target.value;
                    const currentPriceGroup = document.getElementById('currentPriceGroup');
                    const purchaseDateGroup = document.getElementById('purchaseDateGroup');
                    const stockCodeGroup = document.getElementById('stockCodeGroup');
                    
                    if (assetType === 'è‚¡ç¥¨') {
                        currentPriceGroup.style.display = 'block';
                        purchaseDateGroup.style.display = 'block';
                        stockCodeGroup.style.display = 'block';
                    } else if (assetType === 'åŸºé‡‘') {
                        currentPriceGroup.style.display = 'block';
                        purchaseDateGroup.style.display = 'block';
                        stockCodeGroup.style.display = 'none';
                    } else {
                        currentPriceGroup.style.display = 'none';
                        purchaseDateGroup.style.display = 'none';
                        stockCodeGroup.style.display = 'none';
                    }
                });
                
                // é¡åˆ¥é¸æ“‡è®ŠåŒ–æ™‚æ›´æ–°ç´°é …é¸é …
                const mainCategorySelect = document.getElementById('mainCategory');
                if (mainCategorySelect) {
                    mainCategorySelect.addEventListener('change', () => {
                        this.updateSubCategoryOptions();
                    });
                }

                // é¡å‹é¸æ“‡è®ŠåŒ–æ™‚æ›´æ–°é¡åˆ¥é¸é …
                const typeSelect = document.getElementById('type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => {
                        this.updateMainCategoryOptions();
                    });
                }

                // åˆ†é äº‹ä»¶ç›£è½å™¨
                const pageSizeSelect = document.getElementById('pageSize');
                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', async (e) => {
                        this.recordsPerPage = parseInt(e.target.value);
                        this.currentPage = 1;
                        await this.handleTableFilterChange(null);
                    });
                }

                // ä¸Šä¸€é æŒ‰éˆ•
                const prevPageBtn = document.getElementById('prevPage');
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', async () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            await this.applyTableFilter(false);
                        }
                    });
                }

                // ä¸‹ä¸€é æŒ‰éˆ•
                const nextPageBtn = document.getElementById('nextPage');
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', async () => {
                        const filteredRecords = this.getCurrentFilteredRecords();
                        const totalPages = Math.ceil(filteredRecords.length / this.recordsPerPage);
                        if (this.currentPage < totalPages) {
                            this.currentPage++;
                            await this.applyTableFilter(false);
                        }
                    });
                }

                // åœ–è¡¨ç¯©é¸äº‹ä»¶ç›£è½å™¨
                const chartFilterType = document.getElementById('chartFilterType');
                if (chartFilterType) {
                    chartFilterType.addEventListener('change', async () => {
                        await this.updateCharts();
                    });
                }

                const chartFilterYear = document.getElementById('chartFilterYear');
                if (chartFilterYear) {
                    chartFilterYear.addEventListener('change', async () => {
                        await this.updateCharts();
                    });
                }

                const chartFilterMonth = document.getElementById('chartFilterMonth');
                if (chartFilterMonth) {
                    chartFilterMonth.addEventListener('change', async () => {
                        await this.updateCharts();
                    });
                }

                const chartFilterMember = document.getElementById('chartFilterMember');
                if (chartFilterMember) {
                    chartFilterMember.addEventListener('change', async () => {
                        await this.updateCharts();
                    });
                }

                // ç‡ˆç®±é»æ“Šå¤–éƒ¨é—œé–‰åŠŸèƒ½
                window.addEventListener('click', (event) => {
                    // æª¢æŸ¥æ‰€æœ‰ç‡ˆç®±
                    const modals = [
                        'chartsModal',
                        'exchangeRateModal', 
                        'updateStocksLoadingModal',
                        'assetPortfolioModal',
                        'addAssetModal',
                        'tradingFeesConfigModal',
                        'profitLossDetailsModal'
                    ];
                    
                    modals.forEach(modalId => {
                        const modal = document.getElementById(modalId);
                        if (modal && modal.style.display === 'block') {
                            // å¦‚æœé»æ“Šçš„æ˜¯ç‡ˆç®±æœ¬èº«ï¼ˆä¸æ˜¯å…§å®¹å€åŸŸï¼‰ï¼Œå‰‡é—œé–‰ç‡ˆç®±
                            if (event.target === modal) {
                                // æ ¹æ“šä¸åŒçš„ç‡ˆç®±èª¿ç”¨å°æ‡‰çš„é—œé–‰æ–¹æ³•
                                switch(modalId) {
                                    case 'chartsModal':
                                        this.hideChartsModal();
                                        break;
                                    case 'exchangeRateModal':
                                        this.hideExchangeRates();
                                        break;
                                    case 'updateStocksLoadingModal':
                                        this.hideUpdateStocksLoading();
                                        break;
                                    case 'assetPortfolioModal':
                                        this.hideAssetPortfolio();
                                        break;
                                    case 'addAssetModal':
                                        this.hideAddAssetForm();
                                        break;
                                    case 'tradingFeesConfigModal':
                                        this.hideTradingFeesConfig();
                                        break;
                                    case 'profitLossDetailsModal':
                                        this.hideProfitLossDetails();
                                        break;
                                }
                            }
                        }
                    });
                });
            }

            // æ›´æ–°ç´°é …é¸é …
            updateSubCategoryOptions() {
                const mainCategory = document.getElementById('mainCategory').value;
                const subCategorySelect = document.getElementById('subCategory');
                
                // æ¸…ç©ºå°é …ç›®é¸é …
                subCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡ç´°é …</option>';
                
                if (mainCategory && this.categoryStructure[mainCategory]) {
                    this.categoryStructure[mainCategory].forEach(subCategory => {
                        const option = document.createElement('option');
                        option.value = subCategory;
                        option.textContent = subCategory;
                        subCategorySelect.appendChild(option);
                    });
                }
            }

            // æ›´æ–°ä¸»é¡åˆ¥é¸é …
            updateMainCategoryOptions() {
                const type = document.getElementById('type').value;
                const mainCategorySelect = document.getElementById('mainCategory');
                const options = mainCategorySelect.querySelectorAll('option');
                
                // é‡ç½®å¤§é …ç›®é¸æ“‡
                mainCategorySelect.value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>';
                
                // é¡¯ç¤º/éš±è—é¸é …
                options.forEach(option => {
                    if (option.value === '') {
                        option.style.display = 'block';
                    } else {
                        const optionType = option.getAttribute('data-type');
                        option.style.display = (!type || optionType === type) ? 'block' : 'none';
                    }
                });
            }

            // æ–°å¢è¨˜éŒ„
            async addRecord() {
                // ç²å–æäº¤æŒ‰éˆ•
                const submitBtn = document.querySelector('#recordForm button[type="submit"]');
                const isEditing = !!this.editingId;
                
                // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è™•ç†ä¸­
                if (submitBtn && submitBtn.disabled) {
                    console.log('æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...');
                    return;
                }
                
                // è¨­ç½® loading ç‹€æ…‹
                if (submitBtn) {
                    submitBtn.disabled = true;
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = isEditing ? 'æ›´æ–°ä¸­...' : 'æ–°å¢ä¸­...';
                    submitBtn.style.opacity = '0.6';
                    submitBtn.style.cursor = 'not-allowed';
                    
                    // ä¿å­˜åŸå§‹æ–‡å­—ä»¥ä¾¿æ¢å¾©
                    submitBtn.dataset.originalText = originalText;
                }
                
                const formData = {
                    type: document.getElementById('type').value,
                    member: document.getElementById('member').value,
                    mainCategory: document.getElementById('mainCategory').value,
                    subCategory: document.getElementById('subCategory').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    currency: document.getElementById('currency').value,
                    exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 1,
                    description: document.getElementById('description').value,
                    date: document.getElementById('date').value
                };

                console.log('æº–å‚™æ–°å¢è¨˜éŒ„:', formData);

                try {
                    if (this.editingId) {
                        // ç·¨è¼¯æ¨¡å¼
                        await this.updateRecordInFirebase(this.editingId, formData);
                        this.editingId = null;
                        // ç·¨è¼¯å¾Œé‡æ–°è¼‰å…¥è¨˜éŒ„
                        await this.loadRecordsFromFirebase();
                    } else {
                        // æ–°å¢æ¨¡å¼
                        await this.addRecordToFirebase(formData);
                        // æ–°å¢å¾Œé‡æ–°è¼‰å…¥è¨˜éŒ„
                        await this.loadRecordsFromFirebase();
                    }

                    this.resetForm();
                    console.log('è¨˜éŒ„å·²æˆåŠŸå„²å­˜ä¸¦é‡æ–°è¼‰å…¥');
                } catch (error) {
                    console.error('å„²å­˜è¨˜éŒ„å¤±æ•—:', error);
                    this.showNotification('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = submitBtn.dataset.originalText || (isEditing ? 'æ›´æ–°è¨˜éŒ„' : 'æ–°å¢è¨˜éŒ„');
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                    }
                }
            }

            // æ–°å¢è¨˜éŒ„åˆ° API
            async addRecordToFirebase(formData) {
                console.log('é–‹å§‹å¯«å…¥ API...');
                
                // è½‰æ›è³‡æ–™æ ¼å¼
                const expenseData = {
                    date: formData.date,
                    member: formData.member,
                    type: formData.type,
                    mainCategory: formData.mainCategory,
                    subCategory: formData.subCategory,
                    amount: parseFloat(formData.amount),
                    currency: formData.currency || 'TWD',
                    exchangeRate: parseFloat(formData.exchangeRate) || 1,
                    description: formData.description || null
                };
                
                const expense = await window.apiService.createExpense(expenseData);
                console.log('è¨˜éŒ„å·²æ–°å¢åˆ° API:', expense.id);
                this.showNotification('è¨˜éŒ„å·²æˆåŠŸæ–°å¢ï¼', 'success');
                return expense;
            }

            // æ›´æ–° API è¨˜éŒ„
            async updateRecordInFirebase(recordId, formData) {
                // è½‰æ›è³‡æ–™æ ¼å¼
                const expenseData = {
                    date: formData.date,
                    member: formData.member,
                    type: formData.type,
                    mainCategory: formData.mainCategory,
                    subCategory: formData.subCategory,
                    amount: parseFloat(formData.amount),
                    currency: formData.currency || 'TWD',
                    exchangeRate: parseFloat(formData.exchangeRate) || 1,
                    description: formData.description || null
                };
                
                await window.apiService.updateExpense(recordId, expenseData);
                console.log('è¨˜éŒ„å·²æ›´æ–°åˆ° API:', recordId);
                this.showNotification('è¨˜éŒ„å·²æˆåŠŸä¿®æ”¹ï¼', 'success');
            }

            // ç·¨è¼¯è¨˜éŒ„
            async editRecord(recordId) {
                console.log('ç·¨è¼¯è¨˜éŒ„:', recordId);
                
                // å°‡ recordId è½‰æ›ç‚ºæ•¸å­—ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œä»¥è™•ç†é¡å‹ä¸åŒ¹é…å•é¡Œ
                const id = typeof recordId === 'string' ? (isNaN(recordId) ? recordId : Number(recordId)) : recordId;
                const record = this.records.find(r => r.id == id || r.id === id);
                if (!record) {
                    console.error('æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„è¨˜éŒ„ï¼ŒrecordId:', recordId);
                    return;
                }
                
                // å¡«å…¥è¡¨å–®è³‡æ–™
                document.getElementById('type').value = record.type;
                document.getElementById('member').value = record.member;
                document.getElementById('mainCategory').value = record.mainCategory;
                document.getElementById('amount').value = record.amount;
                document.getElementById('description').value = record.description;
                document.getElementById('date').value = record.date;
                document.getElementById('currency').value = record.currency || 'TWD';
                
                // æ›´æ–°ç´°é …é¸é …
                this.updateSubCategoryOptions();
                document.getElementById('subCategory').value = record.subCategory;
                
                // è¨­å®šç·¨è¼¯ç‹€æ…‹
                this.editingId = recordId;
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ›´æ–°è¨˜éŒ„';
                }
                
                // æ»¾å‹•åˆ°è¡¨å–®
                document.querySelector('.add-record').scrollIntoView({ behavior: 'smooth' });
                
                console.log('è¨˜éŒ„å·²è¼‰å…¥è¡¨å–®ï¼Œæº–å‚™ç·¨è¼¯');
            }

            // è¤‡è£½è¨˜éŒ„ï¼ˆè¼‰å…¥åˆ°è¡¨å–®ï¼Œä½†æ—¥æœŸä¸è¼‰å…¥ï¼‰
            copyRecord(recordId) {
                console.log('è¤‡è£½è¨˜éŒ„:', recordId);
                
                // å°‡ recordId è½‰æ›ç‚ºæ•¸å­—ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œä»¥è™•ç†é¡å‹ä¸åŒ¹é…å•é¡Œ
                const id = typeof recordId === 'string' ? (isNaN(recordId) ? recordId : Number(recordId)) : recordId;
                const record = this.records.find(r => r.id == id || r.id === id);
                if (!record) {
                    console.error('æ‰¾ä¸åˆ°è¦è¤‡è£½çš„è¨˜éŒ„ï¼ŒrecordId:', recordId, 'records:', this.records.map(r => ({ id: r.id, type: typeof r.id })));
                    return;
                }
                
                // æ¸…é™¤ç·¨è¼¯ç‹€æ…‹ï¼ˆå› ç‚ºæ˜¯è¤‡è£½ï¼Œä¸æ˜¯ç·¨è¼¯ï¼‰
                this.editingId = null;
                
                // å¡«å…¥è¡¨å–®è³‡æ–™ï¼ˆä½†æ—¥æœŸä¸è¼‰å…¥ï¼‰
                document.getElementById('type').value = record.type;
                document.getElementById('member').value = record.member;
                document.getElementById('mainCategory').value = record.mainCategory;
                document.getElementById('amount').value = record.amount;
                document.getElementById('description').value = record.description || '';
                // æ—¥æœŸä¸è¼‰å…¥ï¼Œä¿ç•™ç•¶å‰é è¨­å€¼ï¼ˆä»Šå¤©çš„æ—¥æœŸï¼‰
                // document.getElementById('date').value = record.date; // è¨»è§£æ‰ï¼Œä¸è¼‰å…¥æ—¥æœŸ
                document.getElementById('currency').value = record.currency || 'TWD';
                
                // æ›´æ–°ç´°é …é¸é …
                this.updateSubCategoryOptions();
                document.getElementById('subCategory').value = record.subCategory;
                
                // ç¢ºä¿æŒ‰éˆ•æ–‡å­—æ˜¯ã€Œæ–°å¢è¨˜éŒ„ã€ï¼ˆå› ç‚ºæ˜¯è¤‡è£½æ¨¡å¼ï¼Œä¸æ˜¯ç·¨è¼¯æ¨¡å¼ï¼‰
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ–°å¢è¨˜éŒ„';
                }
                
                // æ»¾å‹•åˆ°è¡¨å–®
                document.querySelector('.add-record').scrollIntoView({ behavior: 'smooth' });
                
                console.log('è¨˜éŒ„å·²è¤‡è£½åˆ°è¡¨å–®ï¼Œæ—¥æœŸä¿ç•™ç‚ºé è¨­å€¼');
                this.showNotification('è¨˜éŒ„å·²è¤‡è£½åˆ°è¡¨å–®ï¼Œè«‹ç¢ºèªä¸¦æ–°å¢', 'success');
            }

            // åˆªé™¤è¨˜éŒ„
            async deleteRecord(recordId) {
                console.log('åˆªé™¤è¨˜éŒ„:', recordId);
                
                if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                    return;
                }
                
                try {
                    // å°‡ recordId è½‰æ›ç‚ºæ•¸å­—ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼Œä»¥ç¢ºä¿é¡å‹ä¸€è‡´æ€§
                    const id = typeof recordId === 'string' ? (isNaN(recordId) ? recordId : Number(recordId)) : recordId;
                    await window.apiService.deleteExpense(id);
                    
                    console.log('è¨˜éŒ„å·²åˆªé™¤:', id);
                    this.showNotification('è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ï¼', 'success');
                    
                    // åˆªé™¤å¾Œé‡æ–°è¼‰å…¥è¨˜éŒ„
                    await this.loadRecordsFromFirebase();
                    
                } catch (error) {
                    console.error('åˆªé™¤è¨˜éŒ„å¤±æ•—:', error);
                    this.showNotification('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                }
            }

            // æ¸…ç©ºè¡¨å–®
            resetForm() {
                // æ¸…ç©ºæ‰€æœ‰è¡¨å–®æ¬„ä½
                document.getElementById('member').value = '';
                document.getElementById('type').value = '';
                document.getElementById('mainCategory').value = '';
                document.getElementById('subCategory').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>';
                document.getElementById('amount').value = '';
                document.getElementById('description').value = '';
                document.getElementById('currency').value = 'TWD';
                
                // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // é‡ç½®ç·¨è¼¯ç‹€æ…‹
                this.editingId = null;
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œç‹€æ…‹
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ–°å¢è¨˜éŒ„';
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    if (submitBtn.dataset.originalText) {
                        delete submitBtn.dataset.originalText;
                    }
                }
                
                console.log('è¡¨å–®å·²æ¸…ç©ºï¼Œæ—¥æœŸå·²è¨­å®šç‚ºä»Šæ—¥');
            }

            // åˆå§‹åŒ–
            async init() {
                // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // ç›´æ¥è¼‰å…¥è³‡æ–™ï¼ˆä¸éœ€è¦ Firebase èªè­‰ï¼‰
                try {
                    this.showLoading('è¼‰å…¥è¨˜å¸³è³‡æ–™', 'æ­£åœ¨å¾è³‡æ–™åº«è®€å–è¨˜éŒ„...');
                    this.isFirebaseReady = true; // æ¨™è¨˜ç‚ºå°±ç·’
                    
                    // è¼‰å…¥è¨˜éŒ„
                    await this.loadRecordsFromFirebase();
                    
                    // è¼‰å…¥åŒ¯ç‡
                    try {
                        await this.loadExchangeRatesFromFirebase();
                        console.log('åŒ¯ç‡è¼‰å…¥å®Œæˆ');
                    } catch (error) {
                        console.error('åŒ¯ç‡è¼‰å…¥å¤±æ•—:', error);
                    }
                    
                    this.hideLoading();
                    
                    // ç•«é¢è¼‰å…¥å®Œæˆå¾Œï¼Œå»¶é²åŸ·è¡Œè‡ªå‹•æ›´æ–°åŒ¯ç‡
                    setTimeout(async () => {
                        if (!this.isExchangeRateChecked) {
                            await this.checkAndAutoFillTodayRates();
                        }
                    }, 2000);
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                    this.hideLoading();
                    alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
                
                // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initFormEventListeners();
                        this.initCharts();
                    });
                } else {
                    this.initFormEventListeners();
                    this.initCharts();
                }
            }
        }

        // ç¢ºä¿ apiService å·²è¼‰å…¥å¾Œå†å‰µå»º ExpenseTracker å¯¦ä¾‹
        let initAttempts = 0;
        const maxInitAttempts = 50; // æœ€å¤šå˜—è©¦ 5 ç§’ (50 * 100ms)
        
        function initExpenseTracker() {
            initAttempts++;
            
            console.log(`åˆå§‹åŒ–å˜—è©¦ ${initAttempts}/${maxInitAttempts}`);
            console.log('window.apiService:', window.apiService);
            console.log('typeof window.apiService:', typeof window.apiService);
            
            if (!window.apiService) {
                if (initAttempts < maxInitAttempts) {
                    console.warn(`API Service å°šæœªè¼‰å…¥ï¼Œç­‰å¾…è¼‰å…¥... (${initAttempts}/${maxInitAttempts})`);
                    setTimeout(initExpenseTracker, 100);
                    return;
                } else {
                    console.error('API Service è¼‰å…¥è¶…æ™‚ï¼è«‹æª¢æŸ¥ api.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                    console.error('è«‹ç¢ºèª api.js æ–‡ä»¶å­˜åœ¨ä¸”è·¯å¾‘æ­£ç¢º');
                    alert('API Service è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯');
                    return;
                }
            }
            
            // è©³ç´°æª¢æŸ¥ apiService çš„çµæ§‹
            console.log('window.apiService é¡å‹:', window.apiService.constructor.name);
            console.log('window.apiService åŸå‹:', Object.getPrototypeOf(window.apiService));
            console.log('window.apiService æ‰€æœ‰å±¬æ€§:', Object.getOwnPropertyNames(window.apiService));
            console.log('window.apiService åŸå‹æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.apiService)));
            console.log('window.apiService å¯æšèˆ‰å±¬æ€§:', Object.keys(window.apiService));
            
            // æª¢æŸ¥ apiService æ˜¯å¦æœ‰å¿…è¦çš„æ–¹æ³•ï¼ˆç›´æ¥æª¢æŸ¥å¯¦ä¾‹ï¼‰
            const requiredMethods = ['getAllExpenses', 'getExchangeRate', 'saveExchangeRate', 'getAssets', 'createExpense', 'updateExpense', 'deleteExpense'];
            const missingMethods = requiredMethods.filter(method => {
                // æª¢æŸ¥å¯¦ä¾‹æœ¬èº«å’ŒåŸå‹éˆ
                const exists = typeof window.apiService[method] === 'function' || 
                              typeof Object.getPrototypeOf(window.apiService)[method] === 'function';
                console.log(`æª¢æŸ¥æ–¹æ³• ${method}:`, {
                    'å¯¦ä¾‹æ–¹æ³•': typeof window.apiService[method],
                    'åŸå‹æ–¹æ³•': typeof Object.getPrototypeOf(window.apiService)[method],
                    'å­˜åœ¨': exists
                });
                return !exists;
            });
            
            if (missingMethods.length > 0) {
                console.error('API Service ç¼ºå°‘å¿…è¦çš„æ–¹æ³•:', missingMethods);
                console.error('window.apiService çš„å¯¦éš›å…§å®¹:', window.apiService);
                console.error('è«‹æª¢æŸ¥ api.js æ–‡ä»¶æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                alert(`API Service åˆå§‹åŒ–ä¸å®Œæ•´ï¼Œç¼ºå°‘æ–¹æ³•: ${missingMethods.join(', ')}\n\nè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„è©³ç´°éŒ¯èª¤è¨Šæ¯`);
                return;
            }
            
            console.log('âœ… API Service å·²è¼‰å…¥ï¼Œæ‰€æœ‰æ–¹æ³•æª¢æŸ¥é€šéï¼Œå‰µå»º ExpenseTracker å¯¦ä¾‹');
            console.log('API Service å¯ç”¨æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.apiService)).filter(name => name !== 'constructor'));
            window.expenseTracker = new ExpenseTracker();
        }
        
        // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExpenseTracker);
        } else {
            initExpenseTracker();
        }
    </script>

    <!-- äº¤æ˜“è²»ç”¨é…ç½®æ¨¡æ…‹æ¡† -->
    <div id="tradingFeesConfigModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ğŸ’° äº¤æ˜“è²»ç”¨é…ç½®</h2>
                <span class="close" onclick="expenseTracker.hideTradingFeesConfig()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h3>æ‰‹çºŒè²»è¨­å®š</h3>
                    <div class="form-group">
                        <label for="commissionRate">æ‰‹çºŒè²»ç‡</label>
                        <input type="number" id="commissionRate" step="0.000001" min="0" max="0.1" 
                               value="0.001425" placeholder="0.001425">
                        <small>é è¨­å€¼ï¼š0.001425 (0.1425%)</small>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>äº¤æ˜“ç¨…è¨­å®š</h3>
                    <div class="form-group">
                        <label for="taxRateTWD">å°è‚¡äº¤æ˜“ç¨…ç‡</label>
                        <input type="number" id="taxRateTWD" step="0.000001" min="0" max="0.1" 
                               value="0.003" placeholder="0.003">
                        <small>é è¨­å€¼ï¼š0.003 (0.3%)</small>
                    </div>
                    <div class="form-group">
                        <label for="taxRateUSD">ç¾è‚¡äº¤æ˜“ç¨…ç‡</label>
                        <input type="number" id="taxRateUSD" step="0.000001" min="0" max="0.1" 
                               value="0.003" placeholder="0.003">
                        <small>é è¨­å€¼ï¼š0.003 (0.3%)</small>
                    </div>
                    <div class="form-group">
                        <label for="taxRateETF">ETFäº¤æ˜“ç¨…ç‡</label>
                        <input type="number" id="taxRateETF" step="0.000001" min="0" max="0.1" 
                               value="0.001" placeholder="0.001">
                        <small>é è¨­å€¼ï¼š0.001 (0.1%)</small>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>è¨ˆç®—å…¬å¼</h3>
                    <div class="formula-display">
                        <p><strong>å¯¦éš›æˆäº¤é‡‘é¡ = è‚¡æ•¸ Ã— ç¾åƒ¹ Ã— (1 - æ‰‹çºŒè²»ç‡ - äº¤æ˜“ç¨…ç‡)</strong></p>
                        <p>ä¾‹å¦‚ï¼š100è‚¡ Ã— $50 Ã— (1 - 0.001425 - 0.003) = $4,977.86</p>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="expenseTracker.saveTradingFeesConfigFromForm()">
                        ğŸ’¾ å„²å­˜é…ç½®
                    </button>
                    <button class="btn btn-secondary" onclick="expenseTracker.hideTradingFeesConfig()">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç›Šè©³ç´°è³‡æ–™æ¨¡æ…‹æ¡† -->
    <div id="profitLossDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ğŸ“Š æç›Šè©³ç´°è³‡æ–™</h2>
                <span class="close" onclick="expenseTracker.hideProfitLossDetails()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="profitLossDetailsContent">
                    <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>
    </div>

</body>
</html>
