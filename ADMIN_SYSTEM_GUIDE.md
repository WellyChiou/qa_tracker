# 系統管理功能使用指南

## 📚 五大功能概述

本系統提供了五個核心管理功能，它們相互關聯，共同構建了一個完整的權限管理體系：

1. **用戶管理** 👥 - 管理系統使用者
2. **角色管理** 🔐 - 定義角色（如：管理員、一般用戶）
3. **權限管理** 🔑 - 定義具體的權限代碼
4. **菜單管理** 📑 - 管理系統菜單結構
5. **URL 權限管理** 🔗 - 控制 API 端點和頁面的訪問權限

---

## 🔗 五大功能的關係圖

```
用戶 (User)
  ↓ 分配
角色 (Role) ← 分配 → 權限 (Permission)
  ↓                    ↓
URL 權限 (UrlPermission) ← 參考
  ↓
菜單 (Menu) ← 參考 → 權限 (Permission)
```

**關係說明：**
- **用戶** 被分配 **角色**
- **角色** 可以擁有多個 **權限**
- **URL 權限** 可以要求特定 **角色** 或 **權限**
- **菜單** 可以要求特定 **權限** 才顯示

---

## 1️⃣ 用戶管理 (Users) 👥

### 功能說明
管理系統中的所有使用者帳號。

### 使用步驟

#### 新增用戶
1. 點擊「新增用戶」按鈕
2. 填寫必填項目：
   - **用戶名**：登入時使用的帳號（必填，唯一）
   - **電子郵件**：用戶的電子郵件（必填，唯一）
   - **密碼**：登入密碼（新增時必填）
   - **顯示名稱**：用戶的顯示名稱（選填）
3. 設置帳號狀態：
   - **啟用帳號**：是否啟用該帳號
   - **帳號未鎖定**：是否鎖定帳號
4. 分配角色：勾選該用戶應擁有的角色
5. 點擊「儲存」

#### 編輯用戶
1. 在用戶列表中點擊「編輯」按鈕
2. 修改用戶信息（密碼可選填，不填則不修改）
3. 調整角色分配
4. 點擊「儲存」

#### 分配/修改用戶角色
1. 在用戶列表中點擊「角色」按鈕
2. 勾選該用戶應擁有的角色
3. 點擊「儲存」

**範例：**
- 用戶：`admin`
- 分配角色：`ROLE_ADMIN`

---

## 2️⃣ 角色管理 (Roles) 🔐

### 功能說明
定義系統中的角色類型，角色是用戶權限的分組方式。

### 使用步驟

#### 新增角色
1. 點擊「新增角色」按鈕
2. 填寫信息：
   - **角色名稱**：例如 `ROLE_ADMIN`、`ROLE_USER`（必填，唯一）
   - **描述**：角色的說明（選填）
3. 點擊「儲存」

#### 為角色分配權限
1. 在角色列表中點擊「權限」按鈕
2. 勾選該角色應擁有的權限
3. 點擊「儲存」

**範例：**
- 角色：`ROLE_ADMIN`
- 描述：`系統管理員`
- 權限：`ADMIN_ACCESS`、`EXPENSES_READ`、`EXPENSES_WRITE`

---

## 3️⃣ 權限管理 (Permissions) 🔑

### 功能說明
定義系統中的具體權限代碼，權限是系統資源訪問的最小單位。

### 使用步驟

#### 新增權限
1. 點擊「新增權限」按鈕
2. 填寫信息：
   - **權限代碼**：例如 `EXPENSES_READ`、`ADMIN_ACCESS`（必填，唯一）
   - **權限名稱**：例如 `記帳讀取`、`管理員存取`（必填）
   - **資源**：例如 `expenses`、`admin`（選填）
   - **操作**：例如 `read`、`write`、`delete`（選填）
   - **描述**：權限的詳細說明（選填）
3. 點擊「儲存」

**權限代碼命名建議：**
- 格式：`RESOURCE_ACTION`
- 範例：
  - `EXPENSES_READ` - 記帳讀取
  - `EXPENSES_WRITE` - 記帳寫入
  - `TRACKER_READ` - QA 記錄讀取
  - `ADMIN_ACCESS` - 管理員存取

**範例：**
- 權限代碼：`EXPENSES_READ`
- 權限名稱：`記帳讀取`
- 資源：`expenses`
- 操作：`read`
- 描述：`可以查看記帳記錄`

---

## 4️⃣ 菜單管理 (Menus) 📑

### 功能說明
管理系統的菜單結構，控制哪些用戶可以看到哪些菜單。

### 使用步驟

#### 新增根菜單（父菜單）
1. 點擊「新增菜單」按鈕
2. 填寫信息：
   - **菜單代碼**：例如 `DASHBOARD`、`ADMIN`（必填，唯一）
   - **菜單名稱**：例如 `儀表板`、`系統管理`（必填）
   - **圖標**：例如 `📊`、`⚙️`（選填，可使用 emoji）
   - **URL**：如果這是父菜單（只有子菜單），填寫 `#`；如果有實際頁面，填寫頁面路徑如 `/index.html`
   - **父菜單**：選擇「無（根菜單）」
   - **排序順序**：數字越小越靠前（必填）
   - **所需權限**：如果菜單需要特定權限才顯示，填寫權限代碼（選填）
3. 點擊「儲存」

#### 新增子菜單
1. 點擊「新增菜單」按鈕
2. 填寫信息（與根菜單相同）
3. **父菜單**：選擇對應的父菜單
4. 點擊「儲存」

**範例：**
- **根菜單：**
  - 菜單代碼：`ADMIN`
  - 菜單名稱：`系統管理`
  - URL：`#`（因為只有子菜單）
  - 所需權限：`ADMIN_ACCESS`

- **子菜單：**
  - 菜單代碼：`ADMIN_USERS`
  - 菜單名稱：`用戶管理`
  - URL：`/admin/users.html`
  - 父菜單：`ADMIN - 系統管理`
  - 所需權限：`ADMIN_ACCESS`

---

## 5️⃣ URL 權限管理 (UrlPermissions) 🔗

### 功能說明
**這是系統安全的核心！** URL 權限控制哪些 API 端點和頁面可以被哪些用戶訪問。

### 工作原理

URL 權限是一個**動態過濾器**，在每個 HTTP 請求到達 Spring Security 之前進行檢查。系統會按照 `order_index`（從小到大）順序匹配 URL 規則，找到第一個匹配的規則後執行相應的權限檢查。

### URL 模式語法

支援通配符：
- `*` - 匹配單一層級（不包括 `/`）
- `**` - 匹配多層級（包括 `/`）

**範例：**
- `/api/users/**` - 匹配 `/api/users/123`、`/api/users/123/roles` 等
- `/api/users/*` - 匹配 `/api/users/123`，但不匹配 `/api/users/123/roles`
- `/api/**` - 匹配所有 `/api/` 開頭的 URL
- `/login.html` - 只匹配 `/login.html`

### 使用步驟

#### 新增 URL 權限規則

1. 點擊「新增權限配置」按鈕
2. 填寫信息：

   **URL 模式** (必填)
   - 例如：`/api/users/**`、`/api/expenses/**`、`/admin/**`
   - 支援通配符 `*` 和 `**`

   **HTTP 方法** (選填)
   - `GET`、`POST`、`PUT`、`DELETE`、`PATCH`
   - 留空表示所有方法

   **需要角色** (選填)
   - 如果選擇了角色，只有擁有該角色的用戶才能訪問
   - 留空表示只需要通過身份驗證即可

   **需要權限** (選填)
   - 如果填寫了權限代碼，只有擁有該權限的用戶才能訪問
   - 留空表示不需要特定權限

   **公開訪問**
   - 勾選：任何人都可以訪問，無需登入
   - 不勾選：需要身份驗證

   **匹配順序** (必填)
   - 數字越小，優先級越高
   - **重要：** 更具體的規則應該有更小的順序號

   **描述** (選填)
   - 規則的說明

3. 點擊「儲存」

### 配置建議

#### 1. 先配置公開訪問的規則（順序號小）

```
順序  URL 模式               HTTP方法  公開  需要角色    描述
1     /api/auth/**          -        是    -          認證相關 API
2     /api/public/**        -        是    -          公開 API
3     /api/hello            GET      是    -          健康檢查
4     /login.html           -        是    -          登入頁面
5     /index.html           -        是    -          首頁
```

#### 2. 然後配置需要 ADMIN 角色的規則（順序號中等）

```
順序  URL 模式                  HTTP方法  公開  需要角色      描述
20    /api/users/**            -        否    ROLE_ADMIN   用戶管理 API
21    /api/roles/**            -        否    ROLE_ADMIN   角色管理 API
22    /api/permissions/**      -        否    ROLE_ADMIN   權限管理 API
23    /api/menus/**            -        否    ROLE_ADMIN   菜單管理 API
24    /api/url-permissions/**  -        否    ROLE_ADMIN   URL 權限管理 API
25    /admin/**                -        否    ROLE_ADMIN   所有管理頁面
```

#### 3. 最後配置需要認證的通用規則（順序號大）

```
順序  URL 模式               HTTP方法  公開  需要角色  描述
30    /api/expenses/**       -        否    -        記帳 API（需認證）
31    /api/assets/**         -        否    -        資產 API（需認證）
32    /api/records/**        -        否    -        記錄 API（需認證）
90    /api/**                -        否    -        所有其他 API（需認證）
91    /*.html                -        否    -        所有其他頁面（需認證）
99    /**                    -        否    -        所有其他請求（需認證）
```

### ⚠️ 重要注意事項

1. **順序很重要！** 系統按 `order_index` 從小到大匹配，找到第一個匹配的規則就停止。
2. **更具體的規則應該放在前面**（順序號更小）
3. **通用規則應該放在後面**（順序號更大）
4. 如果沒有匹配到任何規則，系統會使用 `SecurityConfig` 中的靜態配置

### 實際範例

#### 範例 1：允許所有人訪問登入頁面

```
URL 模式: /login.html
HTTP 方法: (留空)
公開訪問: 是
匹配順序: 5
```

#### 範例 2：只允許 ADMIN 訪問用戶管理 API

```
URL 模式: /api/users/**
HTTP 方法: (留空)
公開訪問: 否
需要角色: ROLE_ADMIN
匹配順序: 20
```

#### 範例 3：允許所有認證用戶訪問記帳 API

```
URL 模式: /api/expenses/**
HTTP 方法: (留空)
公開訪問: 否
需要角色: (留空)
匹配順序: 30
```

#### 範例 4：只允許擁有特定權限的用戶訪問

```
URL 模式: /api/expenses/export
HTTP 方法: GET
公開訪問: 否
需要權限: EXPENSES_EXPORT
匹配順序: 29
```

---

## 🔄 完整配置流程示例

### 場景：設置一個新的功能模組（例如：報告系統）

#### 步驟 1：創建權限
1. 進入「權限管理」
2. 新增權限：
   - 權限代碼：`REPORTS_READ`
   - 權限名稱：`報告讀取`
   - 資源：`reports`
   - 操作：`read`

#### 步驟 2：創建角色（如果需要）
1. 進入「角色管理」
2. 新增角色：
   - 角色名稱：`ROLE_REPORTER`
   - 描述：`報告查看者`
3. 為該角色分配權限：
   - 點擊「權限」按鈕
   - 勾選 `REPORTS_READ`

#### 步驟 3：分配角色給用戶
1. 進入「用戶管理」
2. 找到目標用戶，點擊「角色」按鈕
3. 勾選 `ROLE_REPORTER`

#### 步驟 4：配置 URL 權限
1. 進入「URL 權限管理」
2. 新增規則：
   - URL 模式：`/api/reports/**`
   - 公開訪問：否
   - 需要權限：`REPORTS_READ`
   - 匹配順序：35

#### 步驟 5：創建菜單（可選）
1. 進入「菜單管理」
2. 新增菜單：
   - 菜單代碼：`REPORTS`
   - 菜單名稱：`報告系統`
   - URL：`/reports.html`
   - 所需權限：`REPORTS_READ`

---

## 📋 常見問題 (FAQ)

### Q1: URL 權限和菜單權限有什麼區別？

**A:** 
- **URL 權限**：控制**實際的 API 端點和頁面**是否可以訪問（安全層面）
- **菜單權限**：控制**菜單是否顯示**（UI 層面）

即使菜單顯示了，如果用戶沒有 URL 權限訪問對應的頁面，訪問時也會被攔截。

### Q2: 用戶、角色、權限的關係是什麼？

**A:** 
- **用戶** 被分配 **角色**
- **角色** 可以擁有多個 **權限**
- **URL 權限** 可以要求用戶擁有特定 **角色** 或 **權限**

### Q3: 為什麼要使用角色，而不是直接給用戶分配權限？

**A:** 
- **簡化管理**：當有多個用戶需要相同權限時，只需要創建一個角色，然後將用戶加入該角色
- **易於維護**：修改角色的權限時，所有該角色的用戶都會自動獲得更新
- **符合企業組織結構**：角色通常對應組織中的職位（如：管理員、財務人員、開發者）

### Q4: 匹配順序有什麼作用？

**A:** 
系統會按順序檢查 URL 權限規則，找到第一個匹配的規則後就停止。因此：
- **更具體的規則**（如 `/api/users/123`）應該有**更小的順序號**
- **更通用的規則**（如 `/api/**`）應該有**更大的順序號**

### Q5: 如何測試 URL 權限是否生效？

**A:** 
1. 使用不同的用戶帳號登入
2. 嘗試訪問受保護的 API 或頁面
3. 檢查是否返回 401（未授權）或 403（禁止訪問）錯誤
4. 在瀏覽器開發者工具的 Network 標籤中查看響應

---

## 🎯 最佳實踐

1. **先規劃權限結構**：在使用系統前，先規劃好需要的角色和權限
2. **使用清晰的命名**：權限代碼和角色名稱要清晰易懂
3. **從公開到私有配置**：先配置公開訪問的規則（小順序號），再配置需要認證的規則（大順序號）
4. **定期審查權限**：定期檢查用戶的角色分配和 URL 權限配置
5. **測試新功能**：每次添加新功能時，都要配置對應的 URL 權限和菜單權限

---

## 📞 需要幫助？

如果遇到問題，請檢查：
1. 後端日誌是否有錯誤信息
2. 瀏覽器控制台是否有錯誤
3. Network 標籤中的 HTTP 狀態碼
4. 用戶是否已正確分配角色和權限
5. URL 權限規則的順序是否正確

