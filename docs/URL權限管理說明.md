# URL 權限管理說明

## 概述

URL 權限管理是一個**細粒度的訪問控制系統**，可以針對不同的 API 端點設定不同的訪問規則。

## 權限控制層級

系統會按照以下順序檢查權限：

```
1. 是否公開 (is_public)
   ↓ 如果 false
2. 是否需要登入
   ↓ 如果需要登入
3. 是否需要特定角色 (requiredRole)
   ↓ 如果需要角色
4. 是否需要特定權限 (requiredPermission)
```

## 欄位說明

### 1. **是否公開 (is_public)**

- **true（公開）**：任何人都可以訪問，**無需登入**
  - 例如：公開的 API、前端菜單、公開查詢等
  - 適合：不需要身份驗證的資料查詢

- **false（非公開）**：需要登入才能訪問
  - 適合：需要身份驗證的功能

### 2. **需要角色 (requiredRole)**

- **作用**：限制只有**擁有特定角色**的用戶才能訪問
- **留空**：任何已登入的用戶都可以訪問（只要通過登入檢查）
- **設定值**：例如 `ROLE_ADMIN`、`ROLE_CHURCH_ADMIN` 等

**使用場景範例：**
```
URL: /api/admin/users
HTTP 方法: GET
是否公開: false
需要角色: ROLE_ADMIN
需要權限: (留空)

→ 只有擁有 ROLE_ADMIN 角色的用戶才能查看用戶列表
```

### 3. **需要權限 (requiredPermission)**

- **作用**：限制只有**擁有特定權限**的用戶才能訪問
- **留空**：不需要特定權限（只要通過角色檢查即可）
- **設定值**：例如 `SERVICE_SCHEDULE_EDIT`、`PERSON_EDIT` 等

**使用場景範例：**
```
URL: /api/church/service-schedules
HTTP 方法: DELETE
是否公開: false
需要角色: (留空)
需要權限: SERVICE_SCHEDULE_EDIT

→ 任何已登入的用戶，只要擁有 SERVICE_SCHEDULE_EDIT 權限，就可以刪除服事表
```

## 組合使用範例

### 範例 1：公開查詢（任何人都可以訪問）
```
URL: /api/church/positions/active
HTTP 方法: GET
是否公開: ✅ true
需要角色: (留空)
需要權限: (留空)

→ 任何人都可以查詢啟用的崗位列表，無需登入
```

### 範例 2：需要登入但不需要特定角色或權限
```
URL: /api/records
HTTP 方法: GET
是否公開: ❌ false
需要角色: (留空)
需要權限: (留空)

→ 任何已登入的用戶都可以查看記錄
```

### 範例 3：需要管理員角色
```
URL: /api/admin/users
HTTP 方法: DELETE
是否公開: ❌ false
需要角色: ROLE_ADMIN
需要權限: (留空)

→ 只有管理員可以刪除用戶
```

### 範例 4：需要特定權限（更細粒度控制）
```
URL: /api/church/service-schedules
HTTP 方法: POST
是否公開: ❌ false
需要角色: (留空)
需要權限: SERVICE_SCHEDULE_EDIT

→ 任何已登入的用戶，只要擁有 SERVICE_SCHEDULE_EDIT 權限，就可以新增服事表
```

### 範例 5：同時需要角色和權限（最嚴格）
```
URL: /api/church/admin/settings
HTTP 方法: PUT
是否公開: ❌ false
需要角色: ROLE_CHURCH_ADMIN
需要權限: SETTINGS_EDIT

→ 必須同時擁有 ROLE_CHURCH_ADMIN 角色和 SETTINGS_EDIT 權限才能修改設定
```

## 角色 vs 權限的區別

### 角色 (Role)
- **概念**：用戶的**身份類別**
- **範例**：`ROLE_ADMIN`（管理員）、`ROLE_USER`（一般用戶）
- **特點**：
  - 通常比較**粗粒度**
  - 一個用戶可以有多個角色
  - 適合用來區分用戶的**職責範圍**

### 權限 (Permission)
- **概念**：用戶可以執行的**具體操作**
- **範例**：`SERVICE_SCHEDULE_EDIT`（編輯服事表）、`PERSON_VIEW`（查看人員）
- **特點**：
  - 通常比較**細粒度**
  - 一個用戶可以有多個權限
  - 適合用來控制**具體功能**的訪問

## 實際應用建議

### 建議使用角色的情況：
- 需要區分**管理員**和**一般用戶**
- 需要區分**不同部門**的用戶
- 需要**大範圍**的權限控制

### 建議使用權限的情況：
- 需要控制**特定功能**的訪問（如：編輯、刪除）
- 需要**細粒度**的權限控制
- 同一個角色內需要**不同權限**（例如：有些管理員可以編輯，有些只能查看）

### 建議同時使用角色和權限的情況：
- 需要**雙重驗證**（更安全）
- 需要**非常嚴格**的訪問控制
- 需要同時滿足**身份**和**能力**要求

## 檢查流程（程式碼邏輯）

當用戶訪問一個 URL 時，系統會：

1. **檢查是否公開**
   ```java
   if (isPublic == true) {
       // 直接允許訪問，無需登入
       return;
   }
   ```

2. **檢查是否已登入**
   ```java
   if (未登入) {
       return 401 未授權;
   }
   ```

3. **檢查角色（如果設定了）**
   ```java
   if (requiredRole != null) {
       if (用戶沒有該角色) {
           return 403 禁止訪問;
       }
   }
   ```

4. **檢查權限（如果設定了）**
   ```java
   if (requiredPermission != null) {
       if (用戶沒有該權限) {
           return 403 禁止訪問;
       }
   }
   ```

5. **通過所有檢查，允許訪問**

## 總結

- **是否公開**：決定是否需要登入
- **需要角色**：決定哪些**身份類別**的用戶可以訪問
- **需要權限**：決定哪些**具體操作**的用戶可以訪問

這三個欄位可以**靈活組合**，實現從「完全公開」到「非常嚴格」的各種訪問控制需求。

