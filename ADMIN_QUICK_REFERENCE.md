# 系統管理快速參考圖

## 🎯 五大功能關係圖

```
┌─────────────────────────────────────────────────────────┐
│                   系統權限管理架構                        │
└─────────────────────────────────────────────────────────┘

┌──────────┐         ┌──────────┐         ┌──────────┐
│   用戶   │ ──分配──│   角色   │ ──擁有──│   權限   │
│  (User)  │         │  (Role)  │         │(Permission)│
└──────────┘         └──────────┘         └──────────┘
     │                     │                     │
     │                     │                     │
     │                     │                     │
     └─────────────────────┴─────────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │  URL 權限規則   │
                  │(UrlPermission) │
                  └─────────────────┘
                           │
                           │ 控制訪問
                           ▼
                  ┌─────────────────┐
                  │   API 端點      │
                  │   頁面 URL      │
                  └─────────────────┘

┌──────────┐                           ┌──────────┐
│   菜單   │ ────── 參考權限 ──────── │   權限   │
│  (Menu)  │                           │(Permission)│
└──────────┘                           └──────────┘
     │
     │ 控制顯示
     ▼
┌──────────┐
│  用戶介面 │
│  (UI)    │
└──────────┘
```

## 📋 配置流程圖

### 完整配置流程

```
1. 創建權限 (Permissions)
   ↓
2. 創建角色 (Roles) → 分配權限
   ↓
3. 創建用戶 (Users) → 分配角色
   ↓
4. 配置 URL 權限 (UrlPermissions) → 要求角色或權限
   ↓
5. 創建菜單 (Menus) → 要求權限（可選）
```

## 🔢 五大功能對照表

| 功能 | 管理對象 | 主要用途 | 關鍵字段 |
|------|---------|---------|---------|
| 👥 **用戶管理** | 使用者帳號 | 管理誰可以使用系統 | username, email, roles |
| 🔐 **角色管理** | 角色類型 | 定義權限分組 | roleName, permissions |
| 🔑 **權限管理** | 權限代碼 | 定義最小權限單位 | permissionCode, resource, action |
| 🔗 **URL 權限管理** | API/頁面訪問規則 | 控制誰能訪問哪些 URL | urlPattern, requiredRole, requiredPermission |
| 📑 **菜單管理** | 系統菜單 | 控制菜單顯示 | menuCode, url, requiredPermission |

## 🎯 常見場景配置

### 場景 1：管理員完整權限

```
1. 權限：ADMIN_ACCESS (管理員存取)
2. 角色：ROLE_ADMIN (系統管理員)
   - 分配權限：ADMIN_ACCESS
3. 用戶：admin
   - 分配角色：ROLE_ADMIN
4. URL 權限：
   - /api/users/** → 需要 ROLE_ADMIN
   - /api/roles/** → 需要 ROLE_ADMIN
   - /admin/** → 需要 ROLE_ADMIN
```

### 場景 2：一般用戶記帳功能

```
1. 權限：EXPENSES_READ, EXPENSES_WRITE
2. 角色：ROLE_USER (一般用戶)
   - 分配權限：EXPENSES_READ, EXPENSES_WRITE
3. 用戶：user1
   - 分配角色：ROLE_USER
4. URL 權限：
   - /api/expenses/** → 只需認證（所有登入用戶）
5. 菜單：
   - 家庭記帳 → 需要 EXPENSES_READ
```

### 場景 3：只讀查看者

```
1. 權限：EXPENSES_READ, TRACKER_READ
2. 角色：ROLE_VIEWER (查看者)
   - 分配權限：EXPENSES_READ, TRACKER_READ
3. 用戶：viewer1
   - 分配角色：ROLE_VIEWER
4. URL 權限：
   - /api/expenses (GET) → 需要 EXPENSES_READ
   - /api/expenses (POST/PUT/DELETE) → 需要 EXPENSES_WRITE（會被拒絕）
```

## 🚀 URL 權限配置模板

### 公開訪問（無需登入）

```
順序: 1-10
URL 模式: /api/auth/**, /login.html, /api/hello
公開訪問: ✅ 是
需要角色: (留空)
需要權限: (留空)
```

### 管理員專用

```
順序: 20-30
URL 模式: /api/users/**, /api/roles/**, /admin/**
公開訪問: ❌ 否
需要角色: ROLE_ADMIN
需要權限: (留空)
```

### 認證用戶訪問

```
順序: 30-50
URL 模式: /api/expenses/**, /api/assets/**, /expenses.html
公開訪問: ❌ 否
需要角色: (留空) 或 ROLE_USER
需要權限: (留空) 或 特定權限
```

### 兜底規則（最後）

```
順序: 90-99
URL 模式: /api/**, /*.html, /**
公開訪問: ❌ 否
需要角色: (留空)
需要權限: (留空)
說明: 所有其他請求都需要認證
```

## ⚡ 快速檢查清單

配置新功能時，檢查以下項目：

- [ ] 1. 是否已創建對應的權限？
- [ ] 2. 是否需要創建新角色？
- [ ] 3. 用戶是否已分配正確的角色？
- [ ] 4. URL 權限規則是否已配置？（順序號是否正確？）
- [ ] 5. 菜單是否需要顯示？（如需要，是否配置了菜單權限？）
- [ ] 6. 是否已測試訪問權限？

## 🔍 故障排除

### 問題：用戶無法訪問某個頁面

**檢查步驟：**
1. ✅ 用戶是否已登入？
2. ✅ 用戶是否有對應的角色？
3. ✅ 角色是否有對應的權限？
4. ✅ URL 權限規則是否存在？
5. ✅ URL 權限規則的順序是否正確？（更具體的規則應該在前面）
6. ✅ URL 權限規則是否要求了正確的角色或權限？

### 問題：菜單不顯示

**檢查步驟：**
1. ✅ 用戶是否已登入？
2. ✅ 菜單的 `isActive` 是否為 `true`？
3. ✅ 菜單的 `requiredPermission` 是否正確？
4. ✅ 用戶是否有該權限？（直接權限或通過角色）

### 問題：API 返回 401/403 錯誤

**檢查步驟：**
1. ✅ 用戶會話是否有效？
2. ✅ URL 是否匹配某個 URL 權限規則？
3. ✅ 規則的 `isActive` 是否為 `true`？
4. ✅ 規則是否要求角色或權限？
5. ✅ 用戶是否滿足要求？

